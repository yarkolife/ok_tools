{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Video Player - {{ video.filename }}</title>
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    <style>
        body { margin: 0; padding: 20px; background: #f5f5f5; font-family: Arial, sans-serif; }
        .video-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .video-info { margin-bottom: 20px; }
        .video-info h1 { color: #333; margin: 0 0 10px 0; }
        .video-info p { color: #666; margin: 5px 0; }
        .video-js { width: 100%; height: auto; max-height: 600px; }
        .loading { text-align: center; padding: 50px; color: #666; }
        .error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .loading-progress { background: #f0f0f0; border-radius: 4px; padding: 10px; margin: 10px 0; }
        .progress-bar { background: #2196F3; height: 20px; border-radius: 4px; transition: width 0.3s; }
        .progress-text { text-align: center; margin-top: 5px; color: #666; }
    </style>
</head>
<body>
    <div class="video-container">
        <div class="video-info">
            <h1>{{ video.filename }}</h1>
            <p><strong>Номер:</strong> {{ video.number }}</p>
            <p><strong>Хранилище:</strong> {{ video.storage_location.name }}</p>
            {% if video.duration %}<p><strong>Длительность:</strong> {{ video.duration }}</p>{% endif %}
            {% if video.file_size %}<p><strong>Размер:</strong> {{ video.file_size|filesizeformat }}</p>{% endif %}
            {% if video.total_bitrate %}<p><strong>Битрейт:</strong> {{ video.total_bitrate }} bps</p>{% endif %}
        </div>

        {% if video.is_available %}
            <video
                id="video-player"
                class="video-js vjs-default-skin"
                controls
                preload="metadata"
                data-setup='{
                    "fluid": true,
                    "responsive": true,
                    "playbackRates": [0.5, 1, 1.25, 1.5, 2],
                    "techOrder": ["html5"],
                    "html5": {
                        "nativeVideoTracks": false,
                        "nativeAudioTracks": false,
                        "nativeTextTracks": false
                    }
                }'>
                <source src="{% url 'admin:media_files_videofile_stream' video.id %}" type="video/{{ video.format|default:'mp4' }}">
                <p class="vjs-no-js">
                    Для просмотра видео включите JavaScript или используйте 
                    <a href="{% url 'admin:media_files_videofile_stream' video.id %}" download>скачать видео</a>
                </p>
            </video>
            
            <div id="loading-progress" class="loading-progress" style="display: none;">
                <div class="progress-bar" style="width: 0%"></div>
                <div class="progress-text">Загрузка видео...</div>
            </div>
        {% else %}
            <div class="error">
                ❌ Видеофайл недоступен. Проверьте путь: {{ video.file_path }}
            </div>
        {% endif %}
    </div>

    <script>
        // Инициализация плеера
        var player = videojs('video-player', {
            responsive: true,
            fluid: true,
            playbackRates: [0.5, 1, 1.25, 1.5, 2],
            controls: true,
            preload: 'metadata'
        });

        // Обработка ошибок
        player.on('error', function() {
            var error = player.error();
            console.error('Video error:', error);
            
            if (error.code === 4) {
                // MEDIA_ERR_SRC_NOT_SUPPORTED
                document.querySelector('.video-container').innerHTML = 
                    '<div class="error">❌ Формат видео не поддерживается браузером. ' +
                    '<a href="{% url "admin:media_files_videofile_stream" video.id %}" download>Скачать файл</a></div>';
            }
        });

        // Показывать прогресс загрузки
        var progressDiv = document.getElementById('loading-progress');
        var progressBar = progressDiv.querySelector('.progress-bar');
        var progressText = progressDiv.querySelector('.progress-text');
        
        player.on('loadstart', function() {
            console.log('Начинается загрузка видео...');
            progressDiv.style.display = 'block';
            progressText.textContent = 'Загрузка видео...';
        });

        player.on('progress', function() {
            var buffered = player.buffered();
            var duration = player.duration();
            if (duration > 0) {
                var bufferedEnd = buffered.length > 0 ? buffered.end(buffered.length - 1) : 0;
                var percent = Math.round((bufferedEnd / duration) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = 'Загрузка видео... ' + percent + '%';
            }
        });

        player.on('canplay', function() {
            console.log('Видео готово к воспроизведению');
            progressDiv.style.display = 'none';
            
            // Автоматически начинаем воспроизведение если загружено достаточно
            if (player.buffered().length > 0) {
                var bufferedEnd = player.buffered().end(player.buffered().length - 1);
                var duration = player.duration();
                if (duration > 0 && (bufferedEnd / duration) > 0.1) { // 10% загружено
                    player.play();
                }
            }
        });

        player.on('waiting', function() {
            console.log('Буферизация...');
            progressDiv.style.display = 'block';
            progressText.textContent = 'Буферизация...';
        });

        player.on('canplaythrough', function() {
            console.log('Видео полностью загружено');
            progressDiv.style.display = 'none';
        });
    </script>
</body>
</html>
