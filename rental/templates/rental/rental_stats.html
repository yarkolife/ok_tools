{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <link rel="apple-touch-icon" href="{% static 'img/favicon.ico' %}">
    <title>{% trans "Rental Statistics" %} - OK Tools</title>
    <link href="{% static 'admin/css/base.css' %}" rel="stylesheet">
    <link href="{% static 'rental/css/admin_rental.css' %}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-number { font-size: 3rem; font-weight: bold; }
        .danger-zone {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 15px;
        }
        .table-container { max-height: 500px; overflow-y: auto; }
        .status-reserved { background: #17a2b8; color: white; }
        .status-issued { background: #28a745; color: white; }
        .status-returned { background: #6c757d; color: white; }
        .status-cancelled { background: #dc3545; color: white; }
        .inventory-rented { background: #ffc107; color: #212529; }
        .inventory-reserved { background: #17a2b8; color: white; }
        .inventory-available { background: #28a745; color: white; }
        .return-ontime { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .return-overdue { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .return-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .return-active { background: #cce5ff; color: #004085; border: 1px solid #99d3ff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #417690 !important;">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="{% url 'rental:admin_rental_process' %}">
                <i class="fas fa-arrow-left me-2"></i>{% trans "Back to Rental Process" %}
            </a>
            <div class="navbar-nav ms-auto align-items-center gap-2">
                <span class="navbar-text text-white d-none d-md-inline">
                    <i class="fas fa-chart-bar me-2"></i>{% trans "Rental Statistics & Administration" %}
                </span>
                <div class="btn-group" role="group" aria-label="calendars">
                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#invDayModal" title="{% trans 'Inventory calendar (day)' %}"><i class="fas fa-calendar-day me-1"></i><span class="d-none d-md-inline">{% trans "Day" %}</span></button>
                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#invWeekModal" title="{% trans 'Inventory calendar (week)' %}"><i class="fas fa-calendar-week me-1"></i><span class="d-none d-md-inline">{% trans "Week" %}</span></button>
                </div>
                <a class="nav-link text-white" href="{% url 'admin:index' %}">
                    <i class="fas fa-cog me-1"></i>{% trans "Administration" %}
                </a>
            </div>
        </div>
    </nav>
    <style>
      .slot-free { background:#e8f5e9 !important; }
      .slot-busy { background:#ffebee !important; }
      #invDayTable td, #invWeekTable td { height: 28px; }
      .cell-note { font-size: 11px; line-height: 1.1; display:flex; align-items:center; justify-content:center; font-weight:600; }
      /* Single item modal */
      #singleInvTable { width: 100%; border-collapse: collapse; }
      #singleInvTable td, #singleInvTable th { 
        height: 35px; 
        border: 1px solid #dee2e6; 
        padding: 4px; 
        text-align: center; 
        vertical-align: middle;
      }
      .calendar-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; }
      .calendar-cell { min-height:60px; padding:6px; border:1px solid #dee2e6; border-radius:4px; font-size:12px; text-align:center; }
      .calendar-cell .date { font-weight:600; display:block; margin-bottom:4px; }
      .calendar-cell.weekend-day { background-color: #f8f9fa; }
      .calendar-cell.today-day { border: 2px solid #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.3); }
      .calendar-cell.table-warning { background-color: #fff3cd !important; border-color: #ffeaa7; }
      .calendar-cell.slot-busy { background-color: #f8d7da !important; border-color: #f5c6cb; }
      .calendar-cell.slot-free { background-color: #d4edda !important; border-color: #c3e6cb; }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        function fmt(d){ 
          // Use local date instead of UTC to avoid timezone issues
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
        function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }

        function getEl(id){ return document.getElementById(id); }

        function ensureDefaults(){
          const d = getEl('invDayDate');
          const w = getEl('invWeekDate');
          const t = fmt(today());
          if(d && !d.value) d.value = t;
          if(w && !w.value) w.value = t;
        }

        function shiftDate(input, deltaDays){
          if(!input) return;
          const d = new Date(input.value || fmt(today()));
          d.setDate(d.getDate() + deltaDays);
          input.value = fmt(d);
        }

        function initials(name){
          if(!name) return '';
          const parts = String(name).trim().split(/\s+/);
          if(parts.length === 1) return parts[0].slice(0,12);
          return (parts[0].slice(0,1) + parts[parts.length-1].slice(0,1)).toUpperCase();
        }

        async function loadDay(){
          const d = getEl('invDayDate');
          ensureDefaults();
          const date = (d && d.value) || fmt(today());
          const res = await fetch(`/rental/api/inventory-calendar/?mode=day&date=${date}`);
          const data = await res.json();
          const header = document.getElementById('invDayHeader');
          const body = document.getElementById('invDayBody');
          header.innerHTML = ''; body.innerHTML = '';
          if(!data.success){ body.innerHTML = `<tr><td class='text-danger' colspan='10'>${data.error||'Error'}</td></tr>`; return; }
          if(!data.items || data.items.length===0){ body.innerHTML = `<tr><td class='text-muted' colspan='10'>No rentable items found for selected filters</td></tr>`; return; }
          
          // Filter items by search
          const searchTerm = getEl('invDaySearch')?.value?.toLowerCase() || '';
          const filteredItems = data.items.filter(it => {
            const number = (it.inventory_number || '').toLowerCase();
            const description = (it.description || '').toLowerCase();
            return number.includes(searchTerm) || description.includes(searchTerm);
          });
          
          if(filteredItems.length === 0){ body.innerHTML = `<tr><td class='text-muted' colspan='10'>No items found matching search criteria</td></tr>`; return; }
          
          // Header
          const thInv = document.createElement('th'); thInv.textContent = 'Inventory'; thInv.style.minWidth = '240px'; header.appendChild(thInv);
          for(let h=10; h<=19; h++){ const th=document.createElement('th'); th.className='text-center'; th.textContent = `${h}:00`; header.appendChild(th); }
          // Rows
          filteredItems.forEach(it=>{
            const tr = document.createElement('tr');
            const td0 = document.createElement('td'); td0.textContent = `${it.inventory_number} — ${it.description||''}`; tr.appendChild(td0);
            const slots = it.hours||[];
            let idx = 0;
            while(idx < slots.length){
              const cur = slots[idx];
              let len = 1;
              while(idx + len < slots.length){
                const nxt = slots[idx+len];
                const sameUser = (cur.info && nxt.info) ? (cur.info.user_name === nxt.info.user_name) : (!cur.info && !nxt.info);
                if(nxt.status === cur.status && sameUser){ len++; } else { break; }
              }
              const td = document.createElement('td');
              if(len>1) td.colSpan = len;
              td.className = cur.status==='issued'?'slot-busy':(cur.status==='reserved'?'table-warning':'slot-free');
              if(cur.info){
                td.title = `${cur.info.user_name} • ${cur.info.status} • ${cur.info.start}—${cur.info.end} (ID ${cur.info.id})`;
                const span = document.createElement('span');
                span.className = 'cell-note';
                span.textContent = cur.info.user_name;
                td.appendChild(span);
              }
              tr.appendChild(td);
              idx += len;
            }
            body.appendChild(tr);
          });
        }
        async function loadWeek(){
          const w = getEl('invWeekDate');
          ensureDefaults();
          const date = (w && w.value) || fmt(today());
          const res = await fetch(`/rental/api/inventory-calendar/?mode=week&date=${date}`);
          const data = await res.json();
          const header = document.getElementById('invWeekHeader');
          const body = document.getElementById('invWeekBody');
          header.innerHTML=''; body.innerHTML='';
          if(!data.success){ body.innerHTML = `<tr><td class='text-danger' colspan='8'>${data.error||'Error'}</td></tr>`; return; }
          if(!data.items || data.items.length===0){ body.innerHTML = `<tr><td class='text-muted' colspan='8'>No rentable items found for selected filters</td></tr>`; return; }
          
          // Filter items by search
          const searchTerm = getEl('invWeekSearch')?.value?.toLowerCase() || '';
          const filteredItems = data.items.filter(it => {
            const number = (it.inventory_number || '').toLowerCase();
            const description = (it.description || '').toLowerCase();
            return number.includes(searchTerm) || description.includes(searchTerm);
          });
          
          if(filteredItems.length === 0){ body.innerHTML = `<tr><td class='text-muted' colspan='8'>No items found matching search criteria</td></tr>`; return; }
          
          const thInv = document.createElement('th'); thInv.textContent='Inventory'; thInv.style.minWidth='240px'; header.appendChild(thInv);
          if(data.items && data.items[0] && data.items[0].week){
            // Show day name + date in header
            data.items[0].week.forEach(d=>{
              const th=document.createElement('th'); 
              th.className='text-center'; 
              const date = new Date(d.date);
              const dayName = date.toLocaleDateString('de-DE', { weekday: 'short' });
              const dayNum = date.getDate();
              const monthName = date.toLocaleDateString('de-DE', { month: 'short' });
              th.innerHTML = `<div>${dayName}</div><div style="font-size: 12px;">${dayNum}. ${monthName}</div>`;
              header.appendChild(th); 
            });
          }
          filteredItems.forEach(it=>{
            const tr=document.createElement('tr');
            const td0=document.createElement('td'); td0.textContent = `${it.inventory_number} — ${it.description||''}`; tr.appendChild(td0);
            const days = it.week||[];
            let i=0;
            while(i<days.length){
              const cur = days[i];
              let span=1;
              while(i+span<days.length){
                const nxt = days[i+span];
                const sameUser = (cur.user_name||'') === (nxt.user_name||'');
                if(nxt.status===cur.status && sameUser){ span++; } else { break; }
              }
              const td=document.createElement('td');
              if(span>1) td.colSpan = span;
              td.className = cur.status==='issued'?'slot-busy':(cur.status==='reserved'?'table-warning':'slot-free');
              if(cur.user_name){ const spanEl=document.createElement('span'); spanEl.className='cell-note'; spanEl.textContent = cur.user_name; td.appendChild(spanEl); }
              tr.appendChild(td);
              i += span;
            }
            body.appendChild(tr);
          });
        }
        document.addEventListener('shown.bs.modal', (e)=>{
          if(e.target && e.target.id==='invDayModal') {
            e.target.removeAttribute('aria-hidden'); // Fix accessibility warning
            loadDay();
          }
          if(e.target && e.target.id==='invWeekModal') {
            e.target.removeAttribute('aria-hidden'); // Fix accessibility warning
            loadWeek();
          }
          if(e.target && e.target.id==='singleInvModal') {
            e.target.removeAttribute('aria-hidden'); // Fix accessibility warning
          }
        });
        ensureDefaults();
        const btnDay = document.getElementById('invDayReload'); if(btnDay) btnDay.addEventListener('click', ()=>{ loadDay(); });
        const btnWeek = document.getElementById('invWeekReload'); if(btnWeek) btnWeek.addEventListener('click', ()=>{ loadWeek(); });
        const btnPrevDay = document.getElementById('invDayPrev'); if(btnPrevDay) btnPrevDay.addEventListener('click', ()=>{ shiftDate(getEl('invDayDate'), -1); loadDay(); });
        const btnNextDay = document.getElementById('invDayNext'); if(btnNextDay) btnNextDay.addEventListener('click', ()=>{ shiftDate(getEl('invDayDate'), +1); loadDay(); });
        const btnPrevWeek = document.getElementById('invWeekPrev'); if(btnPrevWeek) btnPrevWeek.addEventListener('click', ()=>{ shiftDate(getEl('invWeekDate'), -7); loadWeek(); });
        const btnNextWeek = document.getElementById('invWeekNext'); if(btnNextWeek) btnNextWeek.addEventListener('click', ()=>{ shiftDate(getEl('invWeekDate'), +7); loadWeek(); });
        const inputDay = document.getElementById('invDayDate'); if(inputDay) inputDay.addEventListener('change', loadDay);
        const inputWeek = document.getElementById('invWeekDate'); if(inputWeek) inputWeek.addEventListener('change', loadWeek);
        
        // Search functionality
        const searchDay = document.getElementById('invDaySearch'); 
        if(searchDay) {
          searchDay.addEventListener('input', () => {
            clearTimeout(searchDay.searchTimeout);
            searchDay.searchTimeout = setTimeout(loadDay, 300); // Debounce search
          });
        }
        const searchWeek = document.getElementById('invWeekSearch'); 
        if(searchWeek) {
          searchWeek.addEventListener('input', () => {
            clearTimeout(searchWeek.searchTimeout);
            searchWeek.searchTimeout = setTimeout(loadWeek, 300); // Debounce search
          });
        }

        // Inventory search filter (client-side on already loaded table rows)
        const invSearch = document.getElementById('inventorySearch');
        if(invSearch){
          invSearch.addEventListener('input', function(){
            const q = this.value.toLowerCase();
            const rows = document.querySelectorAll('#inventoryTableBody tr');
            rows.forEach(row => {
              const num = (row.children[0]?.innerText || '').toLowerCase();
              const desc = (row.children[1]?.innerText || '').toLowerCase();
              if(!q || num.includes(q) || desc.includes(q)){
                row.style.display = '';
              } else {
                row.style.display = 'none';
              }
            });
          });
        }

        // Force replace legacy per-item calendar to the new modal
        const invTable = document.getElementById('inventoryTableBody');
        if(invTable){
          // Clean legacy inline onclick handlers on dynamically inserted calendar buttons
          const scrub = (root)=>{
            root.querySelectorAll('button').forEach(btn=>{
              const hasCalIcon = !!btn.querySelector('.fa-calendar, .fa-calendar-day, .fa-calendar-week, .fa-regular.fa-calendar');
              if(hasCalIcon && (btn.getAttribute('onclick') || btn.onclick)){
                btn.removeAttribute('onclick');
                btn.onclick = null;
              }
            });
          };
          const mo = new MutationObserver((mutations)=>{
            mutations.forEach(m=>{ m.addedNodes.forEach(n=>{ if(n.nodeType===1){ scrub(n); } }); });
          });
          mo.observe(invTable, { childList: true, subtree: true });
          // Initial scrub if rows already present
          scrub(invTable);

          const handleCalendarClick = function(e){
            const btn = e.target.closest('button');
            if(!btn) return;
            // Heuristic: buttons in Calendar column (with calendar icon)
            const hasCalIcon = !!btn.querySelector('.fa-calendar, .fa-calendar-day, .fa-calendar-week, .fa-regular.fa-calendar');
            if(!hasCalIcon && !btn.dataset.invNumber) return;
            const tr = btn.closest('tr');
            if(!tr) return;
            const inv = btn.dataset.invNumber || (tr.children[0]?.innerText || '').trim();
            const desc = btn.dataset.invDesc || (tr.children[1]?.innerText || '').trim();
            if(inv){
              e.preventDefault();
              if(e.stopImmediatePropagation) e.stopImmediatePropagation();
              e.stopPropagation();
              openSingleInventorySchedule(inv, desc);
            }
          };
          // Capture phase to preempt legacy listeners
          invTable.addEventListener('click', handleCalendarClick, true);
          invTable.addEventListener('click', handleCalendarClick, false);
        }

        // Single item schedule modal API
        window.rentalStats = window.rentalStats || {};
        const single = {
          inv: null,
          desc: null,
          mode: 'week', // week|month
          date: fmt(today()),
        };

        function setSingleHeader(){
          const h = document.getElementById('singleInvHeader');
          if(h) h.textContent = `${single.inv} — ${single.desc}`;
        }

        function range(start, days){
          const d = new Date(start); d.setHours(0,0,0,0);
          const end = new Date(d); end.setDate(end.getDate()+days-1);
          return [d, end];
        }

        async function fetchSingle(startDate, endDate){
          const qs = `inv=${encodeURIComponent(single.inv)}&start_date=${startDate}&end_date=${endDate}`;
          const url = `/rental/api/inventory-schedule/?${qs}`;
          const res = await fetch(url);
          const data = await res.json();
          return data;
        }

        async function loadSingle(){
          setSingleHeader();
          const mode = single.mode;
          const date = single.date;
          
          // Hide all views first
          document.getElementById('singleInvWeek').style.display = 'none';
          document.getElementById('singleInvMonth').style.display = 'none';
          
          try {
            if(mode === 'week'){
              // Calculate Monday-based week
              const currentDate = new Date(date);
              const monday = new Date(currentDate);
              monday.setDate(currentDate.getDate() - (currentDate.getDay() + 6) % 7); // Get Monday
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate() + 6); // Get Sunday
              
              const data = await fetchSingle(fmt(monday), fmt(sunday));
              renderSingleWeek(data);
              document.getElementById('singleInvWeek').style.display = 'block';
            } else if(mode === 'month'){
              const d = new Date(date);
              d.setDate(1); // Start of month
              const nextMonth = new Date(d);
              nextMonth.setMonth(nextMonth.getMonth() + 1);
              nextMonth.setDate(0); // Last day of current month
              const data = await fetchSingle(fmt(d), fmt(nextMonth));
              renderSingleMonth(data);
              document.getElementById('singleInvMonth').style.display = 'block';
            }
          } catch(e) {
            console.error('Failed to load single item schedule:', e);
          }
        }


        function renderSingleWeek(data){
          const grid = document.getElementById('singleInvWeekGrid');
          
          if(!data.success || !data.schedule || data.schedule.length === 0){
            grid.innerHTML = '<div class="text-center text-muted p-3">Keine Daten verfügbar</div>';
            return;
          }
          
          
          // Use data directly from API instead of generating our own
          const weekDays = data.schedule;
          
          // Calculate week range from actual data
          const firstDate = new Date(weekDays[0].date);
          const lastDate = new Date(weekDays[weekDays.length - 1].date);
          const weekStr = `${firstDate.toLocaleDateString('de-DE')} - ${lastDate.toLocaleDateString('de-DE')}`;
          
          let html = `<div style="grid-column: 1 / -1; text-align: center; font-weight: bold; margin-bottom: 10px;">${weekStr}</div>`;
          
          // Header row with day names and numbers
          weekDays.forEach(dayData => {
            const date = new Date(dayData.date);
            const dayName = date.toLocaleDateString('de-DE', { weekday: 'short' });
            const dayNum = date.getDate();
            const monthName = date.toLocaleDateString('de-DE', { month: 'short' });
            html += `<div class="calendar-cell" style="background: #f8f9fa; font-weight: bold;">
              <div class="date">${dayName}</div>
              <div>${dayNum}. ${monthName}</div>
            </div>`;
          });
          
          // Data row
          weekDays.forEach(dayData => {
            let className = 'slot-free';
            let content = '';
            let title = `${dayData.day_name}, ${new Date(dayData.date).toLocaleDateString('de-DE')}\nVerfügbar`;
            
            // Check if any slot in the day (10-19h) is occupied
            const workingHours = dayData.slots ? dayData.slots.filter(slot => {
              const hour = parseInt(slot.time.split(':')[0]);
              return hour >= 10 && hour < 20;
            }) : [];
            
            const occupiedSlots = workingHours.filter(slot => slot.status === 'occupied' && slot.info);
            const totalWorkingHours = workingHours.length || 10; // Default 10h working day
            const occupiedHours = occupiedSlots.length;
            
            if(occupiedHours > 0){
              const firstOccupied = occupiedSlots[0];
              const userName = firstOccupied.info?.user_name || '';
              const userStatus = firstOccupied.info?.status || '';
              const initials = userName.trim().split(/\s+/).filter(n => n.length > 0).map(n => n[0].toUpperCase()).join('');
              
              if(userStatus === 'reserved'){
                className = 'table-warning';
                title = `${dayData.day_name}, ${new Date(dayData.date).toLocaleDateString('de-DE')}\nReserviert: ${userName}\n${occupiedHours}/${totalWorkingHours} Stunden`;
                content = `<strong>R</strong><br><small>${initials || 'R'}</small><br><small>${occupiedHours}h</small>`;
              } else if(userStatus === 'issued'){
                className = 'slot-busy';
                title = `${dayData.day_name}, ${new Date(dayData.date).toLocaleDateString('de-DE')}\nAusgegeben: ${userName}\n${occupiedHours}/${totalWorkingHours} Stunden`;
                content = `<strong>A</strong><br><small>${initials || 'A'}</small><br><small>${occupiedHours}h</small>`;
              } else {
                // Fallback if status is unclear
                className = 'slot-busy';
                title = `${dayData.day_name}, ${new Date(dayData.date).toLocaleDateString('de-DE')}\nBelegt: ${userName}\n${occupiedHours}/${totalWorkingHours} Stunden`;
                content = `<strong>B</strong><br><small>${initials || 'B'}</small><br><small>${occupiedHours}h</small>`;
              }
            } else {
              content = `<small>Frei</small><br><small>${totalWorkingHours}h</small>`;
            }
            
            html += `<div class="calendar-cell ${className}" title="${title}">${content}</div>`;
          });
          
          grid.innerHTML = html;
        }

        function renderSingleMonth(data){
          const grid = document.getElementById('singleInvMonthGrid');
          
          if(!data.success || !data.schedule || data.schedule.length === 0){
            grid.innerHTML = '<div class="text-center text-muted p-3">Keine Daten verfügbar</div>';
            return;
          }
          
          // Get month from single.date
          const currentDate = new Date(single.date);
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          const monthName = currentDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
          
          // Get first and last days of month
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          
          // Get Monday of the week containing the first day
          const startCalendar = new Date(firstDay);
          startCalendar.setDate(firstDay.getDate() - (firstDay.getDay() + 6) % 7);
          
          // Get Sunday of the week containing the last day
          const endCalendar = new Date(lastDay);
          endCalendar.setDate(lastDay.getDate() + (7 - lastDay.getDay()) % 7);
          
          let html = `<div style="grid-column: 1 / -1; text-align: center; font-weight: bold; margin-bottom: 10px;">${monthName}</div>`;
          
          // Add day headers (Mo, Di, Mi, ...)
          const dayHeaders = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
          dayHeaders.forEach(dayName => {
            html += `<div class="calendar-cell" style="background: #f8f9fa; font-weight: bold; font-size: 12px;">${dayName}</div>`;
          });
          
          // Generate calendar days
          const current = new Date(startCalendar);
          while(current <= endCalendar) {
            const dayKey = fmt(current);
            const dayData = data.schedule.find(d => d.date === dayKey);
            const dayNum = current.getDate();
            const dayName = current.toLocaleDateString('de-DE', { weekday: 'short' });
            const isCurrentMonth = current.getMonth() === month;
            
            let className = 'slot-free';
            let content = `<div class="date">${dayNum}</div><div style="font-size: 10px;">${dayName}</div>`;
            let title = `${current.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' })}\nVerfügbar`;
            
            if(!isCurrentMonth) {
              className += ' text-muted';
              content = `<div class="date text-muted">${dayNum}</div><div style="font-size: 10px;" class="text-muted">${dayName}</div>`;
            } else if(dayData) {
              // Check if any slot in the day (10-19h) is occupied
              const workingHours = dayData.slots.filter(slot => {
                const hour = parseInt(slot.time.split(':')[0]);
                return hour >= 10 && hour < 20;
              });
              
              const occupiedSlots = workingHours.filter(slot => slot.status === 'occupied');
              const totalWorkingHours = workingHours.length;
              const occupiedHours = occupiedSlots.length;
              
              if(occupiedHours > 0){
                const firstOccupied = occupiedSlots[0];
                const userName = firstOccupied.info.user_name || '';
                const initials = userName.trim().split(/\s+/).filter(n => n.length > 0).map(n => n[0].toUpperCase()).join('');
                
                if(firstOccupied.info.status === 'reserved'){
                  className = 'table-warning';
                  title = `${current.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' })}\nReserviert: ${userName}\n${occupiedHours}/${totalWorkingHours} Stunden`;
                  content = `<div class="date">${dayNum}</div><div style="font-size: 10px;">${dayName}</div><small><strong>R</strong><br>${initials || 'R'}</small>`;
                } else if(firstOccupied.info.status === 'issued'){
                  className = 'slot-busy';
                  title = `${current.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' })}\nAusgegeben: ${userName}\n${occupiedHours}/${totalWorkingHours} Stunden`;
                  content = `<div class="date">${dayNum}</div><div style="font-size: 10px;">${dayName}</div><small><strong>A</strong><br>${initials || 'A'}</small>`;
                }
                
                if(occupiedHours < totalWorkingHours){
                  content += `<br><small>${occupiedHours}/${totalWorkingHours}h</small>`;
                }
              }
              
              // Highlight weekends
              if(dayData.is_weekend){
                className += ' weekend-day';
              }
              
              // Highlight today
              if(dayData.is_today){
                className += ' today-day';
              }
            }
            
            html += `<div class="calendar-cell ${className}" title="${title}">${content}</div>`;
            current.setDate(current.getDate() + 1);
          }
          
          grid.innerHTML = html;
        }

        function openSingleInventorySchedule(inv, desc){
          single.inv = inv; single.desc = desc; single.mode='week'; 
          
          // Set date to Monday of current week
          const currentDate = today();
          const monday = new Date(currentDate);
          monday.setDate(currentDate.getDate() - (currentDate.getDay() + 6) % 7); // Get Monday
          
          single.date = fmt(monday);
          
          const modal = new bootstrap.Modal(document.getElementById('singleInvModal'));
          modal.show();
          loadSingle();
        }

        // Override legacy class method if present (compatibility with rental_stats.js)
        // RentalStats override removed - now using direct openSingleInventorySchedule calls

        // Backward compatibility: delegate clicks from buttons having data-inv-number / data-inv-desc
        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-inv-number]');
          if(btn){
            const inv = btn.getAttribute('data-inv-number');
            const desc = btn.getAttribute('data-inv-desc') || '';
            openSingleInventorySchedule(inv, desc);
          }
        });

        // Safety net: force override after all scripts
        window.addEventListener('load', function(){
          // Legacy override removed
        });

        // Controls inside modal
        document.addEventListener('click', (e)=>{
          if(e.target.matches('[data-single-mode]')){
            single.mode = e.target.getAttribute('data-single-mode');
            document.querySelectorAll('[data-single-mode]').forEach(b=>b.classList.remove('active'));
            e.target.classList.add('active');
            loadSingle();
          }
          if(e.target.id==='singlePrev'){
            if(single.mode === 'week') {
              // Go to previous Monday
              const d = new Date(single.date);
              const monday = new Date(d);
              monday.setDate(d.getDate() - (d.getDay() + 6) % 7); // Get current Monday
              monday.setDate(monday.getDate() - 7); // Previous Monday
              single.date = fmt(monday);
            } else if(single.mode === 'month') {
              const d = new Date(single.date); 
              d.setMonth(d.getMonth() - 1);
              single.date = fmt(d);
            }
            loadSingle();
          }
          if(e.target.id==='singleNext'){
            if(single.mode === 'week') {
              // Go to next Monday
              const d = new Date(single.date);
              const monday = new Date(d);
              monday.setDate(d.getDate() - (d.getDay() + 6) % 7); // Get current Monday
              monday.setDate(monday.getDate() + 7); // Next Monday
              single.date = fmt(monday);
            } else if(single.mode === 'month') {
              const d = new Date(single.date); 
              d.setMonth(d.getMonth() + 1);
              single.date = fmt(d);
            }
            loadSingle();
          }
        });
      });
    </script>

    <div class="container-fluid mt-3">
        {% if error %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            </div>
        {% else %}
            <!-- Overview Statistics -->
            <div class="row mb-4">

                <!-- Day Modal -->
                <div class="modal fade" id="invDayModal" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-calendar-day me-1"></i>{% trans "Inventory calendar (day)" %}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="d-flex align-items-center mb-2 gap-2">
                          <input type="text" id="invDaySearch" class="form-control form-control-sm" placeholder="{% trans 'Search by number or name...' %}" style="max-width:200px;">
                          <button class="btn btn-outline-secondary btn-sm" id="invDayPrev" title="-1"><i class="fas fa-chevron-left"></i></button>
                          <input type="date" id="invDayDate" class="form-control form-control-sm" style="max-width:180px" />
                          <button class="btn btn-outline-secondary btn-sm" id="invDayNext" title="+1"><i class="fas fa-chevron-right"></i></button>
                          <div class="ms-auto small">
                            <span class="badge bg-success-subtle text-success border">{% trans "Free" %}</span>
                            <span class="badge bg-danger-subtle text-danger border">{% trans "Occupied" %}</span>
                          </div>
                        </div>
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered align-middle" id="invDayTable">
                            <thead class="table-light">
                              <tr id="invDayHeader"></tr>
                            </thead>
                            <tbody id="invDayBody"></tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Week Modal -->
                <div class="modal fade" id="invWeekModal" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-calendar-week me-1"></i>{% trans "Inventory calendar (week)" %}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="d-flex align-items-center mb-2 gap-2">
                          <input type="text" id="invWeekSearch" class="form-control form-control-sm" placeholder="{% trans 'Search by number or name...' %}" style="max-width:200px;">
                          <button class="btn btn-outline-secondary btn-sm" id="invWeekPrev" title="-7"><i class="fas fa-chevron-left"></i></button>
                          <input type="date" id="invWeekDate" class="form-control form-control-sm" style="max-width:180px" />
                          <button class="btn btn-outline-secondary btn-sm" id="invWeekNext" title="+7"><i class="fas fa-chevron-right"></i></button>
                          <div class="ms-auto small">
                            <span class="badge bg-success-subtle text-success border">{% trans "Free" %}</span>
                            <span class="badge bg-danger-subtle text-danger border">{% trans "Occupied" %}</span>
                          </div>
                        </div>
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered align-middle" id="invWeekTable">
                            <thead class="table-light">
                              <tr id="invWeekHeader"></tr>
                            </thead>
                            <tbody id="invWeekBody"></tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Single Inventory Modal -->
                <div class="modal fade" id="singleInvModal" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-box me-2"></i><span id="singleInvHeader"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="d-flex align-items-center mb-2 gap-2">
                          <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-secondary active" data-single-mode="week"><i class="fas fa-calendar-week me-1"></i>{% trans 'Week' %}</button>
                            <button class="btn btn-sm btn-outline-secondary" data-single-mode="month"><i class="fas fa-calendar-alt me-1"></i>{% trans 'Month' %}</button>
                          </div>
                          <button class="btn btn-outline-secondary btn-sm ms-auto" id="singlePrev"><i class="fas fa-chevron-left"></i></button>
                          <button class="btn btn-outline-secondary btn-sm" id="singleNext"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        
                        <!-- Legend -->
                        <div class="d-flex align-items-center mb-3 gap-3 text-sm">
                          <div class="d-flex align-items-center gap-1">
                            <div style="width:16px; height:16px; background:#d4edda; border:1px solid #c3e6cb; border-radius:3px;"></div>
                            <span>{% trans 'Available' %}</span>
                          </div>
                          <div class="d-flex align-items-center gap-1">
                            <div style="width:16px; height:16px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:3px;"></div>
                            <span>{% trans 'Reserved' %} (R)</span>
                          </div>
                          <div class="d-flex align-items-center gap-1">
                            <div style="width:16px; height:16px; background:#f8d7da; border:1px solid #f5c6cb; border-radius:3px;"></div>
                            <span>{% trans 'Issued' %} (A)</span>
                          </div>
                        </div>


                        <!-- Week grid -->
                        <div id="singleInvWeek" class="mb-3">
                          <div class="calendar-grid" id="singleInvWeekGrid"></div>
                        </div>

                        <!-- Month grid -->
                        <div id="singleInvMonth">
                          <div class="calendar-grid" id="singleInvMonthGrid"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ total_rentals }}</div>
                        <div><i class="fas fa-clipboard-list me-2"></i>{% trans "Total Rentals" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ active_rentals }}</div>
                        <div><i class="fas fa-clock me-2"></i>{% trans "Active Rentals" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ total_users }}</div>
                        <div><i class="fas fa-users me-2"></i>{% trans "Users with Rentals" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ total_items }}</div>
                        <div><i class="fas fa-boxes me-2"></i>{% trans "Available Items" %}</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="nav-tabs-container">
                <ul class="nav nav-tabs" id="statsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="rentals-tab" data-bs-toggle="tab" data-bs-target="#rentals" type="button">
                            <i class="fas fa-list"></i>
                            <span>{% trans "All Rentals" %}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button">
                            <i class="fas fa-boxes"></i>
                            <span>{% trans "Inventory Status" %}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sets-tab" data-bs-toggle="tab" data-bs-target="#sets" type="button">
                            <i class="fas fa-layer-group"></i>
                            <span>{% trans "Equipment Sets" %}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button">
                            <i class="fas fa-cogs"></i>
                            <span>{% trans "Administration" %}</span>
                        </button>
                    </li>
                </ul>
            </div>

            <div class="tab-content" id="statsTabContent">
                <!-- Rentals Tab -->
                <div class="tab-pane fade show active" id="rentals" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>{% trans "All Rentals" %}</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" id="statusFilter">
                                                <option value="all">{% trans "All Status" %}</option>
                                                <option value="reserved">{% trans "Reserved" %}</option>
                                                <option value="issued">{% trans "Issued" %}</option>
                                                <option value="returned">{% trans "Returned" %}</option>
                                                <option value="cancelled">{% trans "Cancelled" %}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" id="typeFilter">
                                                <option value="all">{% trans "All Types" %}</option>
                                                <option value="equipment">{% trans "Equipment" %}</option>
                                                <option value="room">{% trans "Rooms" %}</option>
                                                <option value="mixed">{% trans "Mixed" %}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="text" class="form-control form-control-sm" id="userFilter" placeholder="{% trans 'Search user...' %}">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-warning btn-sm w-100" id="expireRoomsBtn" title="{% trans 'Automatic expiration of room reservations and rentals' %}">
                                                <i class="fas fa-sync-alt me-1"></i>{% trans "Expire Rooms" %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover rentals-table">
                                    <thead>
                                        <tr>
                                            <th class="col-id">ID</th>
                                            <th class="col-project">{% trans "Project" %}</th>
                                            <th class="col-user">{% trans "User" %}</th>
                                            <th class="col-status">{% trans "Status" %}</th>
                                            <th class="col-created">{% trans "Created" %}</th>
                                            <th class="col-period">{% trans "Period" %}</th>
                                            <th class="col-return">{% trans "Return" %}</th>
                                            <th class="col-items">{% trans "Items/Rooms" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rentalsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center">
                                                <div class="spinner-border spinner-border-sm me-2"></div>{% trans 'Loading data...' %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div id="rentalsInfo">Lade...</div>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0" id="rentalsPagination"></ul>
                                </nav>
                            </div>

                            <!-- Room Expiration Result -->
                            <div id="expireRoomsResult" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div class="tab-pane fade" id="inventory" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>{% trans "Inventory Status" %}</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="row g-2 align-items-center">
                                        <div class="col-5 col-md-5 order-1">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                <input type="text" class="form-control" id="inventorySearch" placeholder="{% trans 'Search by number or description' %}">
                                            </div>
                                        </div>
                                        <div class="col-3 col-md-3 order-2">
                                            <select class="form-select form-select-sm" id="ownerFilter">
                                                <option value="all">{% trans "All Owners" %}</option>
                                                <option value="{{ STATE_MEDIA_INSTITUTION }}">{{ STATE_MEDIA_INSTITUTION }}</option>
                                                <option value="{{ ORGANIZATION_OWNER }}">{{ ORGANIZATION_OWNER }}</option>
                                            </select>
                                        </div>
                                        <div class="col-4 col-md-4 order-3">
                                            <select class="form-select form-select-sm" id="inventoryStatusFilter">
                                                <option value="all">{% trans "All Status" %}</option>
                                                <option value="available">{% trans "Available" %}</option>
                                                <option value="reserved">{% trans "Reserved" %}</option>
                                                <option value="rented">{% trans "Rented" %}</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>{% trans "Inventory No." %}</th>
                                            <th>{% trans "Description" %}</th>
                                            <th>{% trans "Owner" %}</th>
                                            <th>{% trans "Location" %}</th>
                                            <th>{% trans "Category" %}</th>
                                            <th>{% trans "Reserved" %}</th>
                                            <th>{% trans "Rented" %}</th>
                                            <th>{% trans "Status" %}</th>
                                            <th>{% trans "Calendar" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center">
                                                <div class="spinner-border spinner-border-sm me-2"></div>{% trans 'Loading data...' %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <div id="inventoryInfo">Lade...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipment Sets Tab -->
                <div class="tab-pane fade" id="sets" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>{% trans "Equipment Sets" %}</h5>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <button class="btn btn-primary btn-sm" id="createSetBtn">
                                                <i class="fas fa-plus me-1"></i>{% trans "Create New Set" %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-container">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>{% trans "Name" %}</th>
                                                    <th>{% trans "Description" %}</th>
                                                    <th>{% trans "Items" %}</th>
                                                    <th>{% trans "Status" %}</th>
                                                    <th>{% trans "Created" %}</th>
                                                    <th>{% trans "Actions" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody id="setsTableBody">
                                                <tr>
                                                    <td colspan="6" class="text-center">
                                                        <div class="spinner-border spinner-border-sm me-2"></div>{% trans 'Loading sets...' %}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>{% trans "Set Details" %}</h6>
                                </div>
                                <div class="card-body" id="setDetailsPanel">
                                    <p class="text-muted text-center">{% trans 'Select a set to see details' %}</p>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>

                <!-- Administration Tab -->
                <div class="tab-pane fade" id="admin" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>{% trans "Information" %}</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3">{% trans "These administration functions allow you to reset or clean up the entire rental system." %}</p>

                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>{% trans "Warning" %}:</strong> {% trans "These actions cannot be undone. Make sure you have a backup." %}
                                    </div>

                                    <h6>{% trans "Available Actions" %}:</h6>
                                    <ul>
                                        <li><strong>{% trans "Reset Inventory Quantities" %}:</strong> {% trans "Sets all reserved_quantity and rented_quantity to 0" %}</li>
                                        <li><strong>{% trans "Cancel Active Rentals" %}:</strong> {% trans "Cancels all active rentals and resets inventory quantities" %}</li>
                                        <li><strong>{% trans "Delete All Data" %}:</strong> {% trans "Deletes ALL rental data and resets inventory" %}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="danger-zone p-4">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Danger Zone" %}</h5>

                                <div class="mb-3">
                                    <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="resetAction('reset_inventory_quantities')">
                                        <i class="fas fa-undo me-2"></i>{% trans "Reset Inventory Quantities" %}
                                    </button>

                                    <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="resetAction('cancel_active_rentals')">
                                        <i class="fas fa-ban me-2"></i>{% trans "Cancel Active Rentals" %}
                                    </button>

                                    <button class="btn btn-light btn-sm w-100" onclick="resetAction('reset_all')">
                                        <i class="fas fa-trash me-2"></i>{% trans "Delete All Data" %}
                                    </button>
                                </div>

                                <small>{% trans "Confirmation code required" %}: <code>RESET_ALL_DATA</code></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Inventory Schedule Modal -->
    <!-- removed old modal; use singleInvModal instead -->

    <!-- Create/Edit Set Modal -->
    <div class="modal fade" id="setModal" tabindex="-1" aria-labelledby="setModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setModalLabel">
                        <i class="fas fa-layer-group me-2"></i>{% trans "Create Equipment Set" %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="setForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="setName" class="form-label">{% trans "Name" %} *</label>
                                    <input type="text" class="form-control" id="setName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="setDescription" class="form-label">{% trans "Description" %}</label>
                                    <textarea class="form-control" id="setDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="setIsActive" checked>
                                        <label class="form-check-label" for="setIsActive">
                                            {% trans "Active" %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>{% trans "Add Items" %}:</h6>
                                <div class="mb-3">
                                    <input type="text" class="form-control form-control-sm" id="itemSearch" placeholder="{% trans 'Search items...' %}">
                                </div>
                                <div class="border rounded p-2 mb-3" style="height: 200px; overflow-y: auto;" id="searchResults">
                                    <small class="text-muted">{% trans 'Enter a search term...' %}</small>
                                </div>
                            </div>
                        </div>

                        <h6>{% trans "Set Contents" %}:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>{% trans "Item" %}</th>
                                        <th>{% trans "Quantity" %}</th>
                                        <th>{% trans "Action" %}</th>
                                    </tr>
                                </thead>
                                <tbody id="setItemsList">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">{% trans 'No items added' %}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-primary" id="saveSetBtn">{% trans "Save Set" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Confirmation Required" %}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage"></p>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Enter" %} <code>RESET_ALL_DATA</code> {% trans "to continue" %}:</label>
                        <input type="text" class="form-control" id="confirmationCode" placeholder="RESET_ALL_DATA">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-danger" id="confirmResetBtn">{% trans "Confirm" %}</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript translations -->
    <script src="{% url 'javascript-catalog' %}"></script>

    <script>
        const URLS = {
            resetSystem: "{% url 'rental:api_reset_rental_system' %}",
            getAllRentals: "{% url 'rental:api_get_all_rentals' %}",
            getInventoryStatus: "{% url 'rental:api_get_all_inventory_status' %}",
            getAllSets: "{% url 'rental:api_get_all_equipment_sets' %}",
            createSet: "{% url 'rental:api_create_equipment_set' %}",
            deleteSet: "{% url 'rental:api_delete_equipment_set' pk=0 %}".replace('0', '{setId}'),
            searchInventory: "{% url 'rental:api_search_inventory' %}",
            inventorySchedule: "{% url 'rental:api_inventory_schedule' %}",
        };
        const CSRF_TOKEN = "{{ csrf_token }}";
    </script>
    <script src="{% static 'rental/js/rental_stats.js' %}"></script>
    <script>
      // Legacy overrides removed - now using direct calls
    </script>
</body>
</html>
