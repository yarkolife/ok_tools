# Roadmap: Дашборд администратора OK_tools

## Этап 1: Анализ и проектирование
- [x] Анализ существующих моделей Django (Profile, License, Contribution, Project, InventoryItem, RentalRequest)
- [x] Проектирование структуры дашборда и виджетов
- [x] Определение API endpoints для получения данных
- [x] Создание схемы базы данных для кэширования агрегированных данных
- [x] Тестирование: проверка доступности всех моделей, валидация схемы БД

## Этап 2: Базовая инфраструктура дашборда
- [x] Создание Django app `dashboard`
- [x] Настройка базовых URL и views для дашборда
- [x] Создание базового шаблона с Bootstrap/Modern UI
- [x] Реализация системы аутентификации и авторизации для администраторов
- [x] Создание базовой структуры для виджетов
- [x] Тестирование: запуск в Docker, проверка базовых URL, аутентификация

## Этап 3: Система фильтрации и контекста
- [x] Реализация единой временной шкалы (период, неделя/месяц)
- [x] Создание фильтра по MediaAuthority/ОК
- [x] Реализация демографических фильтров (пол, возраст, членство)
- [x] Создание системы контекстных фильтров для всех виджетов
- [x] Реализация AJAX для динамического обновления данных
- [x] Тестирование: проверка фильтров, AJAX запросов, обновления данных

## Этап 4: Виджет "Пользователи и профили"
- [x] Создание API для получения статистики пользователей
- [x] Реализация подсчёта по полу (Profile.gender)
- [x] Реализация возрастных групп (расчёт по Profile.birthday)
- [x] Статистика по MediaAuthority/ОК
- [x] Статистика по статусу верификации и членству
- [x] Динамика регистрации по месяцам/неделям
- [x] Создание виджета с графиками и таблицами
- [x] Тестирование: проверка API, корректность расчётов, отображение виджета
- [x] Исправление ошибки "datetime is not defined" - функции сделаны глобально доступными
- [x] Исправление ошибок на главной странице дашборда (Chart.js, FontAwesome, Alpine.js, API 500 errors)
- [x] Исправление ошибки "datetime is not defined" на странице users и замена тестовых данных на реальные
- [x] Исправление проблем с линтером и фильтрами на странице users
- [x] Исправление ошибок JSON парсинга и фильтрации по датам
- [x] Исправление ошибки "QuerySet not JSON serializable" в API
- [x] Удаление Alpine.js и замена на обычные HTML формы для фильтров
- [x] Исправление ошибок JSON парсинга в графиках и улучшение инициализации
- [x] Исправление ошибки сериализации QuerySet в API и улучшение передачи данных
- [x] Замена Django template данных на AJAX загрузку для графиков
- [x] Исправление ошибок инициализации графиков и улучшение обработки ошибок
- [x] Исправление ошибок в updateStatisticsCards и добавление отладки API
- [x] Обновление dashboard.js - убраны устаревшие комментарии про Alpine.js
- [x] Улучшение отладки updateStatisticsCards и добавление подробного логирования
- [x] Исправление ошибки с областью видимости функции updateStatisticsCards
- [x] Добавление детальной отладки для выявления причины ошибки в updateStatisticsCards
- [x] Исправление дублирования функции updateStatisticsCards и несоответствия параметров
- [x] Добавление загрузки данных фильтров и исправление Registration Trend графика
- [x] Исправление Registration Trend - теперь учитывает выбранный период фильтра
- [x] Создание виджета лицензий с полной статистикой и графиками
- [x] Создание виджета эфиров с кросс-метриками и конверсией
- [x] Создание отдельного базового шаблона для админ-дашборда с полным меню
- [x] Создание главной страницы админ-дашборда с обзором всех виджетов
- [x] Исправление подключения правильного JavaScript файла в админ-дашборде
- [x] Добавление фильтров на главную страницу админ-дашборда
- [x] Исправление фильтра категорий в виджете лицензий
- [x] Исправление обновления графика "Licenses by Category" при изменении фильтров
- [x] Добавление расширенных метрик для лицензий (длительность, защита молодежи, медиабиблиотека, обмен)
- [x] Добавление визуализации расширенных метрик в интерфейс виджета лицензий
- [x] Исправление ошибок в виджете contributions (фильтр primary, конверсия лицензий)
- [x] Исправление логики расчета конверсии лицензий (устранение >100% конверсии)
- [x] Добавление архивных метрик для лицензий (анализ активности за 6 месяцев)
- [x] Добавление индикаторов загрузки и оптимизация запросов к БД
- [x] Исправление ошибок JavaScript (конфликт функций setLoadingState)
- [x] Исправление проблемы с загрузочным оверлеем на главной странице дашборда (конфликт между main.html и dashboard.js)
- [x] Удаление ненужного файла dashboard.js - каждая страница имеет свои собственные функции
- [x] Унификация стилей виджета contributions.html - применение стилей из projects.html
- [x] Увеличение ширины сайдбара и улучшение размещения логотипа (логотип сверху, текст под ним)
- [x] Улучшение отображения информации о пользователе - правильное получение имени и статуса из Profile модели
- [x] Добавление визуализации архивных метрик в интерфейс
- [x] Исправление ошибок инициализации графиков (проверка destroy функции)
- [x] Исправление ошибок часовых поясов в архивных метриках
- [x] Исправление логики архивирования (анализ всех лицензий для определения архивного статуса)
- [x] Проверка архивных данных (96.4% лицензий являются архивными)
- [x] Подтверждение корректности архивных метрик (фильтр по датам работает правильно)
- [x] Проверка лицензии 10574 (архивная лицензия с показом 2019 года)
- [x] Проверка лицензии 13168 (архивная лицензия с множественными показами)
- [x] Исправление логики архивных метрик (использование поля number вместо id для идентификации лицензий)
  [x] Удаление всех упоминаний Django ID из debug сообщений (использование только поля number)
- [x] Исправление логики архивных метрик (анализ всех лицензий без ограничений по датам)
- [x] Корректировка архивных метрик (показ лицензий, которые были показаны в выбранный период)
- [x] Синхронизация логики архивных метрик с анализом (порог 365 дней вместо 180 дней)
- [x] Исправление логики анализа архивных лицензий (анализ всех лицензий, показанных в период, а не только созданных в период)
- [x] Создание единой метрики для дашборда contributions (TOTAL, LIVE, AUFGEZEICHNET, уникальных, PRIMARY, архивных, REPETITIONS, CONVERSION RATE)
- [x] Исправление ошибки импорта datetime в методе get_unified_metrics
- [x] Исправление логики подсчета primary contributions (использование метода is_primary() вместо подсчета всех contributions с ранней датой)
- [x] Улучшение дизайна общих метрик (увеличение ширины карточек, улучшение стилей, удаление дублирующей секции "License Archive Status")
- [x] Удаление архивных секций со страницы лицензий ("License Archive Distribution", "Archive Status Details", Archive Statistics Cards)
- [x] Исправление обновления графиков на странице проектов при применении фильтров

## Этап 5: Виджет "Лицензии и эфиры"
- [x] API для статистики лицензий (общее число, новые, подтверждённые)
- [x] Статистика по категориям, медиавластям, полу и возрасту автора
- [x] API для статистики эфиров (количество показов, первичные/повторы)
- [x] Статистика по дате, полу, возрасту, ОК автора
- [x] Расчёт доли "живых" трансляций
- [x] Кросс-метрики: конверсия "заявка→эфир"
- [x] Среднее время от лицензии до первого эфира
- [x] Создание виджета с взаимосвязанными графиками
- [x] Тестирование: проверка API, корректность кросс-метрик, взаимосвязь графиков

## Этап 6: Виджет "Проекты"
- [x] API для статистики проектов по категориям
- [x] Статистика по целевым группам и руководителям
- [x] Подсчёт участников проекта по возрастным и гендерным полям
- [x] Аналитика по времени (периоды, ОК)
- [x] Создание виджета с таблицами и диаграммами
- [x] Тестирование: проверка API, корректность подсчётов участников, отображение таблиц

## Этап 7: Виджет "Оборудование и аренда"
- [x] API для статистики инвентаря (категории, производители, статусы)
- [x] Статистика доступности для аренды
- [x] API для запросов на аренду (статусы, длительность, задержки)
- [x] Статистика по полу, ОК, членству арендаторов
- [x] Кросс-метрики: популярные категории, процент завершённых аренд
- [x] Статистика использования комплектов оборудования
- [x] Создание виджета с карточками и графиками
- [x] Тестирование: проверка API, корректность расчётов аренды, отображение карточек
- [x] Интеграция виджета инвентаря в главный дашборд
- [x] Добавление статистики инвентаря на главную страницу дашборда
- [x] Добавление расширенных фильтров для виджета инвентаря (медиавласти, пол, возраст, членство, категории, владельцы, локации)
- [x] Исправление SQL ошибок в запросах трендов (неоднозначные столбцы)
- [x] Добавление статистики по комнатам - популярные категории (локации), тренды использования, популярные комнаты
- [x] Добавление возможности выбора произвольных дат начала и конца в фильтрах
- [x] Исправление SQL ошибки в запросах трендов комнат - замена сложного SQL на простой Python код
- [x] Исправление SQL ошибки в запросах трендов аренд при использовании кастомных дат - замена сложного SQL на простой Python код
- [x] Исправление UI для кастомных дат - добавление инициализации полей дат и обработки параметра custom
- [x] Исправление ошибок в инициализации графиков - добавление проверок для всех данных
- [x] Исправление фильтра категорий инвентаря - использование inventory.models.Category вместо licenses.models.Category
- [x] Исправление UI для кастомных дат - убраны автоматические обновления фильтров, добавлен правильный обработчик событий для dateRange
- [x] Добавление функции resetInventoryFilters для кнопки сброса фильтров
- [x] Исправление ошибки с undefined значениями в фильтрах - добавлена проверка на 'undefined', 'null' и пустые значения в JavaScript и API
- [x] Исправление JavaScript для загрузки категорий инвентаря - использование data.inventory_categories вместо data.category_choices
- [x] Исправление применения фильтров к инвентарю - добавлено применение _apply_inventory_filters к get_basic_stats, get_inventory_by_category и get_inventory_by_owner
- [x] Исправление полей кастомных дат - добавлена задержка для инициализации toggleCustomDateInputs
- [x] Исправление конфликтов JavaScript функций между inventory.html и dashboard.js - переименование toggleCustomDateInputs в toggleInventoryCustomDateInputs
- [x] Исправление проблемы с Room Rentals Statistics - добавлено правильное уничтожение графиков roomCategoriesChart и roomTrendChart
- [x] Исправление бесконечного цикла в initializeCharts - добавлена защита от повторных вызовов и проверка на пустые данные
- [x] Удаление ненужных фильтров из виджета инвентаря - убраны Bürgermedium, Min Age, Max Age, Verification
- [x] Исправление высоты графиков комнат - убраны фиксированные размеры из HTML и добавлен CSS для ограничения высоты
- [x] Удаление ненужного графика Popular Categories из виджета инвентаря
- [x] Добавление статистики по популярному инвентарю - количество доступных предметов и 10 самых популярных
- [x] Исправление форматирования названий предметов инвентаря - убраны коды владельцев, оставлены инвентарные номера
- [x] Убрано дублирование цифр в списке популярных предметов - оставлен только badge с количеством аренд
- [x] Добавлена аналитика активности пользователей - рейтинг и антирейтинг по аренде vs создание лицензий

## Этап 8: Виджет "Системные уведомления"
- [x] API для активных уведомлений
- [x] Статистика по приоритетам и охвату
- [x] Система отметок "видел/игнорировал" для пользователей
- [x] Создание виджета с управлением уведомлениями
- [x] Тестирование: проверка API, функциональность отметок, управление уведомлениями

## Этап 9: Интерактивность и навигация
- [ ] Реализация сквозной навигации (клик по числам → детализация)
- [ ] Создание модальных окон для детального просмотра
- [ ] Реализация экспорта данных (CSV/XLSX)
- [ ] Добавление интерактивных элементов (tooltips, hover эффекты)
- [ ] Тестирование: проверка навигации, модальных окон, экспорта, интерактивности

## Этап 10: Визуализация и UI/UX
- [ ] Интеграция Chart.js или D3.js для графиков
- [ ] Создание линейных графиков для динамики
- [ ] Создание секторальных диаграмм для состава
- [ ] Реализация адаптивного дизайна
- [ ] Добавление анимаций и переходов
- [ ] Тестирование: проверка графиков, адаптивности, анимаций в разных браузерах

## Этап 11: Оптимизация и производительность
- [ ] Реализация кэширования агрегированных данных
- [ ] Оптимизация SQL запросов
- [ ] Добавление пагинации для больших таблиц
- [ ] Реализация lazy loading для виджетов
- [ ] Тестирование: проверка производительности, кэширования, пагинации

## Этап 12: Расширенная функциональность
- [ ] Отслеживание "воронки" участия (регистрация → лицензия → эфир)
- [ ] Автоматические оповещения при превышении порогов
- [ ] Интерактивное сравнение нескольких ОК/периодов
- [ ] Создание дашборда "по умолчанию" для новых администраторов
- [ ] Тестирование: проверка воронки, оповещений, сравнения ОК, дашборда по умолчанию

## Этап 13: Финальная интеграция
- [ ] Интеграция всех виджетов в единый интерфейс
- [ ] Тестирование всех сценариев использования
- [ ] Оптимизация производительности
- [ ] Документация для администраторов
- [ ] Финальное тестирование: интеграционное тестирование, нагрузочное тестирование, проверка в Docker

## Технические детали

### Структура Django app `dashboard`:
```
dashboard/
├── models.py          # Модели для кэширования агрегированных данных
├── views.py           # Views для дашборда и API
├── urls.py            # URL конфигурация
├── api.py             # API endpoints для виджетов
├── widgets/           # Отдельные виджеты
│   ├── users.py
│   ├── licenses.py
│   ├── projects.py
│   ├── inventory.py
│   ├── imports.py
│   └── notifications.py
├── templates/         # HTML шаблоны
├── static/            # Статические файлы
│   ├── css/           # Стили
│   ├── js/            # JavaScript
│   └── img/           # Изображения
├── locale/            # Файлы переводов (.po, .mo)
└── utils.py           # Утилиты для расчётов
```

### Frontend:
- **Alpine.js** - лёгкая интерактивность (sidebar, фильтры, модальные окна)
- **HTMX** - динамическое обновление виджетов без перезагрузки
- **Bootstrap 5** - готовые компоненты и адаптивность

### Backend:
- **Django 5.2** - основной веб-фреймворк
- **Django REST Framework** - API для виджетов
- **Chart.js** - простые и красивые графики
- **Redis** - кэширование агрегированных данных
- **Django i18n** - интернационализация

### Требования к разработке:
- Все тексты интерфейса на английском языке
- Все строки обёрнуты для перевода (gettext, {% trans %})
- После каждого этапа - тестирование работоспособности и коррекция
- Разработка и тестирование в Docker среде

### Приоритеты разработки:
1. Базовая инфраструктура и фильтры
2. Виджет пользователей (основа для остальных)
3. Виджет лицензий и эфиров (основная бизнес-логика)
4. Остальные виджеты
5. Интерактивность и оптимизация
