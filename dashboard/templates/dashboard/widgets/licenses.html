{% extends "dashboard/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Licenses Dashboard" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            
            <!-- Filters Section -->
            <div class="filter-section">
                <form id="filtersForm" method="GET">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label">{% trans "Date Range" %}</label>
                            <select class="form-select" id="dateRange" name="days">
                                <option value="7">{% trans "Last 7 days" %}</option>
                                <option value="30">{% trans "Last 30 days" %}</option>
                                <option value="90">{% trans "Last 90 days" %}</option>
                                <option value="365">{% trans "Last year" %}</option>
                                <option value="all">{% trans "All Time" %}</option>
                                <option value="custom">{% trans "Custom Period" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="customStartDate" class="form-label">{% trans "Start Date" %}</label>
                            <input type="date" class="form-control" id="customStartDate" name="start_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="customEndDate" class="form-label">{% trans "End Date" %}</label>
                            <input type="date" class="form-control" id="customEndDate" name="end_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="mediaAuthority" class="form-label">{% trans "Media Authority" %}</label>
                            <select class="form-select" id="mediaAuthority" name="media_authority">
                                <option value="">{% trans "All Authorities" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="genderFilter" class="form-label">{% trans "Gender" %}</label>
                            <select class="form-select" id="genderFilter" name="gender">
                                <option value="">{% trans "All Genders" %}</option>
                                <option value="m">{% trans "Male" %}</option>
                                <option value="f">{% trans "Female" %}</option>
                                <option value="d">{% trans "Diverse" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="ageGroupFilter" class="form-label">{% trans "Age Group" %}</label>
                            <select class="form-select" id="ageGroupFilter" name="age_group">
                                <option value="">{% trans "All Ages" %}</option>
                                <option value="under_18">{% trans "Under 18" %}</option>
                                <option value="18_25">{% trans "18-25" %}</option>
                                <option value="26_35">{% trans "26-35" %}</option>
                                <option value="36_50">{% trans "36-50" %}</option>
                                <option value="over_50">{% trans "Over 50" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="categoryFilter" class="form-label">{% trans "Category" %}</label>
                            <select class="form-select" id="categoryFilter" name="category">
                                <option value="">{% trans "All Categories" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">{% trans "Status" %}</label>
                            <select class="form-select" id="statusFilter" name="status">
                                <option value="">{% trans "All Statuses" %}</option>
                                <option value="confirmed">{% trans "Confirmed" %}</option>
                                <option value="pending">{% trans "Pending" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">{% trans "Apply Filters" %}</button>
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">{% trans "Reset" %}</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card" data-type="total" data-title="{% trans 'Total Licenses' %}">
                        <div class="stat-number" id="totalLicenses">0</div>
                        <div class="stat-label">{% trans "Total Licenses" %}</div>

                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" data-type="active" data-title="{% trans 'Active Licenses' %}">
                        <div class="stat-number" id="confirmedLicenses">0</div>
                        <div class="stat-label">{% trans "Confirmed" %}</div>

                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" data-type="pending" data-title="{% trans 'Pending Licenses' %}">
                        <div class="stat-number" id="pendingLicenses">0</div>
                        <div class="stat-label">{% trans "Pending" %}</div>

                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" data-type="new" data-title="{% trans 'New Licenses' %}">
                        <div class="stat-number" id="newLicenses">0</div>
                        <div class="stat-label">{% trans "New Licenses" %}</div>

                    </div>
                </div>
            </div>

            <!-- Extended Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="avgDuration">0</div>
                        <div class="stat-label">{% trans "Avg Duration (min)" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="youthProtectionRate">0%</div>
                        <div class="stat-label">{% trans "Youth Protection" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="libraryRate">0%</div>
                        <div class="stat-label">{% trans "Media Library" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="saxonyExchangeRate">0%</div>
                        <div class="stat-label">{% trans "Saxony Exchange" %}</div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header d-flex justify-content-between align-items-center">
                            <h3 class="widget-title">{% trans "Licenses by Category" %}</h3>
                            <div class="d-flex gap-2">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary active" onclick="changeChartType('categoryChart', 'doughnut')" title="{% trans 'Doughnut Chart' %}">
                                        <i class="bi bi-pie-chart"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeChartType('categoryChart', 'bar')" title="{% trans 'Bar Chart' %}">
                                        <i class="bi bi-bar-chart"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeChartType('categoryChart', 'horizontalBar')" title="{% trans 'Horizontal Bar Chart' %}">
                                        <i class="bi bi-bar-chart-steps"></i>
                                    </button>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('categoryChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 400px; overflow: auto; position: relative;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header d-flex justify-content-between align-items-center">
                            <h3 class="widget-title">{% trans "Licenses by Media Authority" %}</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('authorityChart')">
                                <i class="bi bi-download"></i> {% trans "Export" %}
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="authorityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header d-flex justify-content-between align-items-center">
                            <h3 class="widget-title">{% trans "Licenses by Gender" %}</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('genderChart')">
                                <i class="bi bi-download"></i> {% trans "Export" %}
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header d-flex justify-content-between align-items-center">
                            <h3 class="widget-title">{% trans "Licenses by Age Group" %}</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('ageChart')">
                                <i class="bi bi-download"></i> {% trans "Export" %}
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Licenses Trend -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="dashboard-widget">
                        <div class="widget-header d-flex justify-content-between align-items-center">
                            <h3 class="widget-title">{% trans "Licenses Trend" %}</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('trendChart')">
                                <i class="bi bi-download"></i> {% trans "Export" %}
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confirmation Rate -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">{% trans "Confirmation Rate" %}</h3>
                        </div>
                        <div class="text-center">
                            <div class="display-4 text-primary" id="confirmationRate">0%</div>
                            <p class="text-muted">{% trans "of licenses are confirmed" %}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">{% trans "License Status Distribution" %}</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Extended Metrics Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header d-flex justify-content-between align-items-center">
                            <h3 class="widget-title">{% trans "Duration Distribution" %}</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('durationChart')">
                                <i class="bi bi-download"></i> {% trans "Export" %}
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="durationChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-widget">
                        <div class="widget-header d-flex justify-content-between align-items-center">
                            <h3 class="widget-title">{% trans "Youth Protection Categories" %}</h3>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('youthChart')">
                                <i class="bi bi-download"></i> {% trans "Export" %}
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="youthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

                   <!-- Exchange Permissions -->
       <div class="row mb-4">
           <div class="col-md-6">
               <div class="dashboard-widget">
                   <div class="widget-header d-flex justify-content-between align-items-center">
                       <h3 class="widget-title">{% trans "Saxony-Anhalt Exchange" %}</h3>
                       <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('saxonyChart')">
                           <i class="bi bi-download"></i> {% trans "Export" %}
                       </button>
                   </div>
                   <div class="chart-container">
                       <canvas id="saxonyChart"></canvas>
                   </div>
               </div>
           </div>
           <div class="col-md-6">
               <div class="dashboard-widget">
                   <div class="widget-header d-flex justify-content-between align-items-center">
                       <h3 class="widget-title">{% trans "Other States Exchange" %}</h3>
                       <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('otherStatesChart')">
                           <i class="bi bi-download"></i> {% trans "Export" %}
                       </button>
                   </div>
                   <div class="chart-container">
                       <canvas id="otherStatesChart"></canvas>
                   </div>
               </div>
           </div>
       </div>


        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">{% trans "Loading data..." %}</p>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<script>
// Chart instances
window.categoryChart = null;
window.authorityChart = null;
window.genderChart = null;
window.ageChart = null;
window.trendChart = null;
window.statusChart = null;
window.durationChart = null;
window.youthChart = null;
window.saxonyChart = null;
window.otherStatesChart = null;

// Initialize chart data with empty values
window.chartData = {
    licensesByCategory: [],
    licensesByAuthority: [],
    licensesByGender: [],
    licensesByAge: {},
    licensesTrend: [],
    basicStats: {},
    confirmationRate: {}
};

// Load filter data via AJAX
async function loadFilterData() {
    try {
        const response = await fetch('/admin-dashboard/api/filters-data/');
        const data = await response.json();
        
        if (data.success && data.data && data.data.context) {
            console.log('Filter data loaded:', data.data.context);
            
            // Populate Media Authority options
            const mediaAuthoritySelect = document.getElementById('mediaAuthority');
            if (mediaAuthoritySelect && data.data.context.media_authorities) {
                while (mediaAuthoritySelect.children.length > 1) {
                    mediaAuthoritySelect.removeChild(mediaAuthoritySelect.lastChild);
                }
                
                data.data.context.media_authorities.forEach(authority => {
                    const option = document.createElement('option');
                    option.value = authority.name;
                    option.textContent = authority.name;
                    mediaAuthoritySelect.appendChild(option);
                });
            }
            
            // Populate Category options
            const categorySelect = document.getElementById('categoryFilter');
            if (categorySelect && data.data.context.category_choices) {
                while (categorySelect.children.length > 1) {
                    categorySelect.removeChild(categorySelect.lastChild);
                }
                
                data.data.context.category_choices.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }
        } else {
            console.error('Failed to load filter data:', data);
        }
    } catch (error) {
        console.error('Error loading filter data:', error);
    }
}

// Load chart data via AJAX
async function loadChartData() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const response = await fetch(`/admin-dashboard/api/licenses-statistics/?${urlParams.toString()}`);
        const data = await response.json();
        
        if (data.success && data.data) {
            console.log('API response data:', data.data);
            console.log('Licenses by category data:', data.data.licenses_by_category);
            
                   window.chartData = {
           licensesByCategory: data.data.licenses_by_category || [],
           licensesByAuthority: data.data.licenses_by_authority || [],
           licensesByGender: data.data.licenses_by_gender || [],
           licensesByAge: data.data.licenses_by_age || {},
           licensesTrend: data.data.licenses_trend || [],
           basicStats: data.data.basic_stats || {},
           confirmationRate: data.data.confirmation_rate || {},
           durationStats: data.data.duration_stats || {},
           youthProtectionStats: data.data.youth_protection_stats || {},
           mediaLibraryStats: data.data.media_library_stats || {},
           exchangeStats: data.data.exchange_stats || {},
           archiveStats: data.data.archive_stats || {}
       };
            
            // Update statistics cards
            updateStatisticsCards(data.data.basic_stats);
            updateConfirmationRate(data.data.confirmation_rate);
            updateExtendedStatisticsCards();
            

            
            console.log('Chart data loaded successfully:', window.chartData);
        } else {
            console.error('API returned error or no data:', data);
            window.chartData = {
                licensesByCategory: [],
                licensesByAuthority: [],
                licensesByGender: [],
                licensesByAge: {},
                licensesTrend: [],
                basicStats: {},
                confirmationRate: {}
            };
        }
    } catch (error) {
        console.error('Error loading chart data:', error);
        window.chartData = {
            licensesByCategory: [],
            licensesByAuthority: [],
            licensesByGender: [],
            licensesByAge: {},
            licensesTrend: [],
            basicStats: {},
            confirmationRate: {}
        };
    }
}

// Update statistics cards
window.updateStatisticsCards = function(basicStats) {
    if (!basicStats || typeof basicStats !== 'object') {
        console.warn('basicStats is undefined or not an object, skipping statistics update');
        return;
    }
    
    const elements = {
        'totalLicenses': basicStats.total_licenses || 0,
        'confirmedLicenses': basicStats.confirmed_licenses || 0,
        'pendingLicenses': basicStats.pending_licenses || 0,
        'newLicenses': basicStats.new_licenses || 0
    };
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    });
}

// Update extended statistics cards
window.updateExtendedStatisticsCards = function() {
    const durationStats = window.chartData.durationStats || {};
    const youthProtectionStats = window.chartData.youthProtectionStats || {};
    const mediaLibraryStats = window.chartData.mediaLibraryStats || {};
    const exchangeStats = window.chartData.exchangeStats || {};
    
    // Duration stats
    const avgDurationElement = document.getElementById('avgDuration');
    if (avgDurationElement) {
        avgDurationElement.textContent = durationStats.average_duration_minutes || 0;
    }
    
    // Youth protection stats
    const youthProtectionElement = document.getElementById('youthProtectionRate');
    if (youthProtectionElement) {
        youthProtectionElement.textContent = `${youthProtectionStats.youth_protection_rate || 0}%`;
    }
    
    // Media library stats
    const libraryRateElement = document.getElementById('libraryRate');
    if (libraryRateElement) {
        libraryRateElement.textContent = `${mediaLibraryStats.library_rate || 0}%`;
    }
    
    // Saxony exchange stats
    const saxonyExchangeElement = document.getElementById('saxonyExchangeRate');
    if (saxonyExchangeElement) {
        saxonyExchangeElement.textContent = `${exchangeStats.saxony_rate || 0}%`;
    }
};

// Update confirmation rate
function updateConfirmationRate(confirmationRate) {
    if (!confirmationRate || typeof confirmationRate !== 'object') {
        return;
    }
    
    const rateElement = document.getElementById('confirmationRate');
    if (rateElement) {
        rateElement.textContent = `${confirmationRate.rate || 0}%`;
    }
}



// Initialize filters from URL
function initializeFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days');
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');
    
    if (days) {
        const dateRangeSelect = document.getElementById('dateRange');
        if (dateRangeSelect) {
            dateRangeSelect.value = days;
        }
        
        if (days === 'custom' && startDate && endDate) {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');
            if (startInput) startInput.value = startDate;
            if (endInput) endInput.value = endDate;
        }
    }
    
    // Set other filter values from URL
    const filters = ['media_authority', 'gender', 'age_group', 'category', 'status'];
    filters.forEach(filter => {
        const value = urlParams.get(filter);
        if (value) {
            const element = document.getElementById(filter === 'media_authority' ? 'mediaAuthority' : filter + 'Filter');
            if (element) {
                element.value = value;
            }
        }
    });
}

function toggleCustomDateInputs() {
    const dateRange = document.getElementById('dateRange').value;
    const startDateInput = document.getElementById('customStartDate');
    const endDateInput = document.getElementById('customEndDate');
    
    if (dateRange === 'custom') {
        startDateInput.style.display = 'block';
        endDateInput.style.display = 'block';
    } else {
        startDateInput.style.display = 'none';
        endDateInput.style.display = 'none';
    }
}

function applyFilters() {
    const form = document.getElementById('filtersForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    window.history.pushState({}, '', window.location.pathname + '?' + params.toString());
    
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
}

function resetFilters() {
    const form = document.getElementById('filtersForm');
    form.reset();
    
    window.history.pushState({}, '', window.location.pathname);
    
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize filters from URL
    initializeFiltersFromURL();
    
    // Load filter data
    loadFilterData();
    
    // Add click handlers for stat cards
    const statCards = document.querySelectorAll('.stat-card[data-type]');
    statCards.forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const title = this.getAttribute('data-title');
            showLicenseDetailModal(type, title);
        });
        
        // Add hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 12px 20px rgba(0,0,0,0.15)';
            this.style.borderColor = '#667eea';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.05)';
            this.style.borderColor = 'rgba(0,0,0,0.05)';
        });
    });
    
    // Add event listeners for form submission
    const filtersForm = document.getElementById('filtersForm');
    if (filtersForm) {
        filtersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
    }
    
    // Add event listener for date range change
    const dateRangeSelect = document.getElementById('dateRange');
    if (dateRangeSelect) {
        dateRangeSelect.addEventListener('change', function() {
            toggleCustomDateInputs();
        });
    }
    
    // Initialize custom date inputs visibility
    toggleCustomDateInputs();
    
    // Load chart data and initialize charts
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error during initialization:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
});

// Make initializeCharts globally available
window.initializeCharts = function() {
    // Check if chartData is available
    if (!window.chartData) {
        console.warn('Chart data not available, initializing with empty data');
        window.chartData = {
            licensesByCategory: [],
            licensesByAuthority: [],
            licensesByGender: [],
            licensesByAge: {},
            licensesTrend: [],
            basicStats: {},
            confirmationRate: {},
            archiveStats: {}
        };
    }
    
    // Initialize chart variables if they don't exist
    if (!window.categoryChart) window.categoryChart = null;
    if (!window.authorityChart) window.authorityChart = null;
    if (!window.genderChart) window.genderChart = null;
    if (!window.ageChart) window.ageChart = null;
    if (!window.trendChart) window.trendChart = null;
    if (!window.statusChart) window.statusChart = null;
    if (!window.durationChart) window.durationChart = null;
    if (!window.youthChart) window.youthChart = null;
    if (!window.saxonyChart) window.saxonyChart = null;
    if (!window.otherStatesChart) window.otherStatesChart = null;
    
    // Destroy existing charts if they exist
    if (window.categoryChart && typeof window.categoryChart.destroy === 'function') {
        window.categoryChart.destroy();
    }
    if (window.authorityChart && typeof window.authorityChart.destroy === 'function') {
        window.authorityChart.destroy();
    }
    if (window.genderChart && typeof window.genderChart.destroy === 'function') {
        window.genderChart.destroy();
    }
    if (window.ageChart && typeof window.ageChart.destroy === 'function') {
        window.ageChart.destroy();
    }
    if (window.trendChart && typeof window.trendChart.destroy === 'function') {
        window.trendChart.destroy();
    }
    if (window.statusChart && typeof window.statusChart.destroy === 'function') {
        window.statusChart.destroy();
    }
    if (window.durationChart && typeof window.durationChart.destroy === 'function') {
        window.durationChart.destroy();
    }
    if (window.youthChart && typeof window.youthChart.destroy === 'function') {
        window.youthChart.destroy();
    }
    if (window.saxonyChart && typeof window.saxonyChart.destroy === 'function') {
        window.saxonyChart.destroy();
    }
    if (window.otherStatesChart && typeof window.otherStatesChart.destroy === 'function') {
        window.otherStatesChart.destroy();
    }
    
    // Destroy existing charts if they exist
    if (window.categoryChart) window.categoryChart.destroy();
    if (window.authorityChart) window.authorityChart.destroy();
    if (window.genderChart) window.genderChart.destroy();
    if (window.ageChart) window.ageChart.destroy();
    if (window.trendChart) window.trendChart.destroy();
    if (window.statusChart) window.statusChart.destroy();
    if (window.durationChart) window.durationChart.destroy();
    if (window.youthChart) window.youthChart.destroy();
    if (window.saxonyChart) window.saxonyChart.destroy();
    if (window.otherStatesChart) window.otherStatesChart.destroy();
    
    // Category Chart - Enhanced Doughnut Chart
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
        console.log('Creating enhanced category chart with data:', window.chartData.licensesByCategory);
        console.log('Category labels:', window.chartData.licensesByCategory.map(item => item.category__name || 'Unknown'));
        console.log('Category data:', window.chartData.licensesByCategory.map(item => item.count));
        
        const categoryData = window.chartData.licensesByCategory || [];
        const labels = categoryData.map(item => item.category__name || '{% trans "Unknown" %}');
        const data = categoryData.map(item => item.count);
        const total = data.reduce((sum, value) => sum + value, 0);

        // Generate extended color palette
        const extendedColors = [
            'rgba(255, 99, 132, 0.8)',   // Red
            'rgba(54, 162, 235, 0.8)',   // Blue
            'rgba(255, 206, 86, 0.8)',   // Yellow
            'rgba(75, 192, 192, 0.8)',   // Teal
            'rgba(153, 102, 255, 0.8)',  // Purple
            'rgba(255, 159, 64, 0.8)',   // Orange
            'rgba(199, 199, 199, 0.8)',  // Gray
            'rgba(83, 102, 255, 0.8)',   // Indigo
            'rgba(255, 99, 255, 0.8)',   // Pink
            'rgba(99, 255, 132, 0.8)',   // Green
            'rgba(255, 132, 99, 0.8)',   // Light Red
            'rgba(132, 99, 255, 0.8)',   // Light Purple
            'rgba(99, 132, 255, 0.8)',   // Light Blue
            'rgba(255, 255, 99, 0.8)',   // Light Yellow
            'rgba(99, 255, 255, 0.8)'    // Light Cyan
        ];
        
        const extendedBorderColors = extendedColors.map(color => color.replace('0.8', '1'));
        const extendedHoverColors = extendedColors.map(color => color.replace('0.8', '0.9'));

        // Adjust container height based on data amount
        const chartContainer = categoryCtx.closest('.chart-container');
        if (chartContainer) {
            const dataCount = labels.length;
            if (dataCount > 10) {
                chartContainer.style.height = '600px';
            } else if (dataCount > 5) {
                chartContainer.style.height = '450px';
            } else {
                chartContainer.style.height = '400px';
            }
        }
        
        window.categoryChart = new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: extendedColors.slice(0, labels.length),
                    borderColor: extendedBorderColors.slice(0, labels.length),
                    borderWidth: 2,
                    hoverBackgroundColor: extendedHoverColors.slice(0, labels.length),
                    hoverBorderColor: extendedBorderColors.slice(0, labels.length),
                    hoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    
    // Authority Chart - Enhanced Bar Chart
    const authorityCtx = document.getElementById('authorityChart');
    if (authorityCtx) {
        const authorityData = window.chartData.licensesByAuthority || [];
        const labels = authorityData.map(item => item.profile__media_authority__name || '{% trans "Unknown" %}');
        const data = authorityData.map(item => item.count);
        
        window.authorityChart = new Chart(authorityCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '{% trans "Licenses" %}',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(54, 162, 235, 0.9)',
                    hoverBorderColor: 'rgba(54, 162, 235, 1)',
                    hoverBorderWidth: 3,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#36A2EB',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Media Authority" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "Licenses" %}: ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Media Authority" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Licenses" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                }
            }
        });
    }
    
    // Gender Chart - Enhanced Pie Chart
    const genderCtx = document.getElementById('genderChart');
    if (genderCtx) {
        const maleData = window.chartData.licensesByGender.find(item => item.profile__gender === 'm')?.count || 0;
        const femaleData = window.chartData.licensesByGender.find(item => item.profile__gender === 'f')?.count || 0;
        const diverseData = window.chartData.licensesByGender.find(item => item.profile__gender === 'd')?.count || 0;
        const total = maleData + femaleData + diverseData;
        
        window.genderChart = new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: ['{% trans "Male" %}', '{% trans "Female" %}', '{% trans "Diverse" %}'],
                datasets: [{
                    data: [maleData, femaleData, diverseData],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(255, 99, 132, 0.9)',
                        'rgba(54, 162, 235, 0.9)',
                        'rgba(255, 206, 86, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                radius: '85%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    
    // Age Chart - Enhanced Bar Chart
    const ageCtx = document.getElementById('ageChart');
    if (ageCtx) {
        const ageData = window.chartData.licensesByAge || {};
        const labels = ['{% trans "Under 18" %}', '{% trans "18-25" %}', '{% trans "26-35" %}', '{% trans "36-50" %}', '{% trans "Over 50" %}'];
        const data = [
            ageData.under_18 || 0,
            ageData['18_25'] || 0,
            ageData['26_35'] || 0,
            ageData['36_50'] || 0,
            ageData.over_50 || 0
        ];
        
        window.ageChart = new Chart(ageCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '{% trans "Licenses" %}',
                    data: data,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(75, 192, 192, 0.9)',
                    hoverBorderColor: 'rgba(75, 192, 192, 1)',
                    hoverBorderWidth: 3,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#4BC0C0',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Age Group" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "Licenses" %}: ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Age Group" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Licenses" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                }
            }
        });
    }
    
    // Trend Chart - Enhanced Linear Chart
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        console.log('Creating enhanced trend chart with data:', window.chartData.licensesTrend);
        
        const trendData = Array.isArray(window.chartData.licensesTrend) ? window.chartData.licensesTrend : [];
        
        window.trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.map(item => item.date || ''),
                datasets: [{
                    label: '{% trans "New Licenses" %}',
                    data: trendData.map(item => item.count || 0),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: '#667eea',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    borderWidth: 3,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#667eea',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Date" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "New Licenses" %}: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Date" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of New Licenses" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });
    }
    
    // Status Chart - Enhanced Doughnut Chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        const confirmedData = window.chartData.basicStats.confirmed_licenses || 0;
        const pendingData = window.chartData.basicStats.pending_licenses || 0;
        const total = confirmedData + pendingData;
        
        window.statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['{% trans "Confirmed" %}', '{% trans "Pending" %}'],
                datasets: [{
                    data: [confirmedData, pendingData],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(75, 192, 192, 0.9)',
                        'rgba(255, 206, 86, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#4BC0C0',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    
    // Duration Distribution Chart - Enhanced Bar Chart
    const durationCtx = document.getElementById('durationChart');
    if (durationCtx) {
        const durationStats = window.chartData.durationStats || {};
        const distribution = durationStats.duration_distribution || {};
        const labels = Object.keys(distribution);
        const data = Object.values(distribution);
        
        window.durationChart = new Chart(durationCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '{% trans "Licenses" %}',
                    data: data,
                    backgroundColor: 'rgba(153, 102, 255, 0.8)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(153, 102, 255, 0.9)',
                    hoverBorderColor: 'rgba(153, 102, 255, 1)',
                    hoverBorderWidth: 3,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#9966FF',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Duration" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "Licenses" %}: ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Duration Range" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Licenses" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                }
            }
        });
    }
    
    // Youth Protection Categories Chart - Enhanced Doughnut Chart
    const youthCtx = document.getElementById('youthChart');
    if (youthCtx) {
        const youthStats = window.chartData.youthProtectionStats || {};
        const categories = youthStats.youth_categories || [];
        const labels = categories.map(item => item.youth_protection_category || '{% trans "Unknown" %}');
        const data = categories.map(item => item.count);
        const total = data.reduce((sum, value) => sum + value, 0);
        
        window.youthChart = new Chart(youthCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(255, 99, 132, 0.9)',
                        'rgba(54, 162, 235, 0.9)',
                        'rgba(255, 206, 86, 0.9)',
                        'rgba(75, 192, 192, 0.9)',
                        'rgba(153, 102, 255, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    
    // Saxony-Anhalt Exchange Chart - Enhanced Doughnut Chart
    const saxonyCtx = document.getElementById('saxonyChart');
    if (saxonyCtx) {
        const exchangeStats = window.chartData.exchangeStats || {};
        const allowedData = exchangeStats.saxony_exchange_allowed || 0;
        const notAllowedData = exchangeStats.saxony_exchange_not_allowed || 0;
        const unknownData = exchangeStats.saxony_exchange_unknown || 0;
        const total = allowedData + notAllowedData + unknownData;
        
        window.saxonyChart = new Chart(saxonyCtx, {
            type: 'doughnut',
            data: {
                labels: ['{% trans "Allowed" %}', '{% trans "Not Allowed" %}', '{% trans "Unknown" %}'],
                datasets: [{
                    data: [allowedData, notAllowedData, unknownData],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(75, 192, 192, 0.9)',
                        'rgba(255, 206, 86, 0.9)',
                        'rgba(255, 99, 132, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#4BC0C0',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    
    // Other States Exchange Chart - Enhanced Doughnut Chart
    const otherStatesCtx = document.getElementById('otherStatesChart');
    if (otherStatesCtx) {
        const exchangeStats = window.chartData.exchangeStats || {};
        const allowedData = exchangeStats.other_states_exchange_allowed || 0;
        const notAllowedData = exchangeStats.other_states_exchange_not_allowed || 0;
        const unknownData = exchangeStats.other_states_exchange_unknown || 0;
        const total = allowedData + notAllowedData + unknownData;
        
        window.otherStatesChart = new Chart(otherStatesCtx, {
            type: 'doughnut',
            data: {
                labels: ['{% trans "Allowed" %}', '{% trans "Not Allowed" %}', '{% trans "Unknown" %}'],
                datasets: [{
                    data: [allowedData, notAllowedData, unknownData],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(75, 192, 192, 0.9)',
                        'rgba(255, 206, 86, 0.9)',
                        'rgba(255, 99, 132, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#4BC0C0',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }
    

}

// Export functions
window.exportChartData = function(chartId) {
    const chart = getChartInstance(chartId);
    if (chart) {
        const data = chart.data;
        const csv = convertToCSV(data);
        downloadCSV(csv, `${chartId}_data.csv`);
    }
}

window.getChartInstance = function(chartId) {
    switch(chartId) {
        case 'categoryChart': return window.categoryChart;
        case 'authorityChart': return window.authorityChart;
        case 'genderChart': return window.genderChart;
        case 'ageChart': return window.ageChart;
        case 'trendChart': return window.trendChart;
        case 'statusChart': return window.statusChart;
        case 'durationChart': return window.durationChart;
        case 'youthChart': return window.youthChart;
        case 'saxonyChart': return window.saxonyChart;
        case 'otherStatesChart': return window.otherStatesChart;
        default: return null;
    }
}

window.convertToCSV = function(data) {
    const labels = data.labels;
    const values = data.datasets[0].data;
    
    let csv = 'Label,Value\n';
    for (let i = 0; i < labels.length; i++) {
        csv += `"${labels[i]}",${values[i]}\n`;
    }
    
    return csv;
}

window.downloadCSV = function(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Interactive navigation functionality for licenses
// (Moved to main DOMContentLoaded event handler above)

// Show license detail modal
function showLicenseDetailModal(type, title) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('licenseDetailModal');
    if (!modal) {
        modal = createLicenseDetailModal();
        document.body.appendChild(modal);
    }
    
    // Update modal title
    const modalTitle = modal.querySelector('.modal-title');
    modalTitle.textContent = title;
    
    // Show loading state
    const modalBody = modal.querySelector('.modal-body');
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">{% trans "Loading..." %}</span></div></div>';
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Load data
    loadLicenseDetailData(type, modalBody);
}

// Create license detail modal
function createLicenseDetailModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'licenseDetailModal';
    modal.tabIndex = -1;
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "License Detail View" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                    <button type="button" class="btn btn-primary" onclick="exportLicenseDetailData()">{% trans "Export CSV" %}</button>
                </div>
            </div>
        </div>
    `;
    return modal;
}

// Load license detail data
async function loadLicenseDetailData(type, modalBody, page = 1) {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('type', type);
        urlParams.set('page', page);
        urlParams.set('per_page', 20);
        
        // Store current type for pagination
        modalBody.dataset.currentType = type;
        
        const response = await fetch(`/admin-dashboard/api/licenses-detail/?${urlParams.toString()}`);
        const data = await response.json();
        
        if (data.success) {
            displayLicenseDetailData(data.data, modalBody);
        } else {
            modalBody.innerHTML = `<div class="alert alert-danger">{% trans "Error" %}: ${data.error}</div>`;
        }
    } catch (error) {
        modalBody.innerHTML = `<div class="alert alert-danger">{% trans "Error loading data" %}: ${error.message}</div>`;
    }
}

// Display license detail data
function displayLicenseDetailData(data, modalBody) {
    const { licenses, total_count, displayed_count, pagination } = data;
    
    let html = `
        <div class="mb-3">
            <div class="row">
                <div class="col-md-6">
                    <strong>{% trans "Total Records" %}:</strong> ${total_count}
                </div>
                <div class="col-md-6">
                    <strong>{% trans "Displayed" %}:</strong> ${displayed_count}
                </div>
            </div>
        </div>
    `;
    
    if (licenses.length > 0) {
        html += `
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="licenseDetailTable">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "Number" %}</th>
                            <th>{% trans "Title" %}</th>
                            <th>{% trans "Subtitle" %}</th>
                            <th>{% trans "Duration" %}</th>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Category" %}</th>
                            <th>{% trans "Created" %}</th>
                            <th>{% trans "Confirmed" %}</th>
                            <th>{% trans "Media Authority" %}</th>
                            <th>{% trans "City" %}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        licenses.forEach(license => {
            const confirmedBadge = license.confirmed ? '<span class="badge bg-success">{% trans "Yes" %}</span>' : '<span class="badge bg-warning">{% trans "No" %}</span>';
            html += `
                <tr>
                    <td>${license.number}</td>
                    <td>${license.title}</td>
                    <td>${license.subtitle}</td>
                    <td>${license.duration}</td>
                    <td>${license.name}</td>
                    <td>${license.category}</td>
                    <td>${license.created_at}</td>
                    <td>${confirmedBadge}</td>
                    <td>${license.media_authority}</td>
                    <td>${license.city}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        // Add pagination if available
        if (pagination && pagination.total_pages > 1) {
            html += generatePaginationHTML(pagination);
        }
    } else {
        html += '<div class="alert alert-info">{% trans "No data found for the selected criteria." %}</div>';
    }
    
    modalBody.innerHTML = html;
}

// Generate pagination HTML
function generatePaginationHTML(pagination) {
    const { current_page, total_pages, has_next, has_previous } = pagination;
    
    let html = `
        <nav aria-label="{% trans "License pagination" %}" class="mt-3">
            <ul class="pagination justify-content-center">
    `;
    
    // Previous button
    if (has_previous) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadPage(${current_page - 1})">{% trans "Previous" %}</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">{% trans "Previous" %}</span></li>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, current_page - 2);
    const endPage = Math.min(total_pages, current_page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === current_page) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadPage(${i})">${i}</a></li>`;
        }
    }
    
    // Next button
    if (has_next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadPage(${current_page + 1})">{% trans "Next" %}</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>`;
    }
    
    html += `
            </ul>
        </nav>
    `;
    
    return html;
}

// Load specific page
function loadPage(page) {
    const modalBody = document.querySelector('#licenseDetailModal .modal-body');
    const currentType = modalBody.dataset.currentType || 'all';
    
    loadLicenseDetailData(currentType, modalBody, page);
}

// Get status badge HTML
function getStatusBadge(status) {
    switch(status) {
        case 'Active':
            return '<span class="badge bg-success">{% trans "Active" %}</span>';
        case 'Expired':
            return '<span class="badge bg-danger">{% trans "Expired" %}</span>';
        case 'Pending':
            return '<span class="badge bg-warning">{% trans "Pending" %}</span>';
        default:
            return `<span class="badge bg-secondary">${status}</span>`;
    }
}

// Export license detail data
function exportLicenseDetailData() {
    const table = document.getElementById('licenseDetailTable');
    if (table) {
        const rows = table.querySelectorAll('tr');
        const csv = window.convertTableToCSV(rows);
        const filename = `licenses_detail_${new Date().toISOString().split('T')[0]}.csv`;
        window.downloadCSV(csv, filename);
    }
}

// Function to change chart type
function changeChartType(chartId, newType) {
    const chart = window[chartId];
    if (!chart) return;
    
    // Update button states
    const buttonGroup = document.querySelector(`[onclick*="${chartId}"]`)?.closest('.btn-group');
    if (buttonGroup) {
        const buttons = buttonGroup.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.onclick && btn.onclick.toString().includes(newType)) {
                btn.classList.add('active');
            }
        });
    }
    
    // Generate extended color palette
    const extendedColors = [
        'rgba(255, 99, 132, 0.8)',   // Red
        'rgba(54, 162, 235, 0.8)',   // Blue
        'rgba(255, 206, 86, 0.8)',   // Yellow
        'rgba(75, 192, 192, 0.8)',   // Teal
        'rgba(153, 102, 255, 0.8)',  // Purple
        'rgba(255, 159, 64, 0.8)',   // Orange
        'rgba(199, 199, 199, 0.8)',  // Gray
        'rgba(83, 102, 255, 0.8)',   // Indigo
        'rgba(255, 99, 255, 0.8)',   // Pink
        'rgba(99, 255, 132, 0.8)',   // Green
        'rgba(255, 132, 99, 0.8)',   // Light Red
        'rgba(132, 99, 255, 0.8)',   // Light Purple
        'rgba(99, 132, 255, 0.8)',   // Light Blue
        'rgba(255, 255, 99, 0.8)',   // Light Yellow
        'rgba(99, 255, 255, 0.8)'    // Light Cyan
    ];
    
    const extendedBorderColors = extendedColors.map(color => color.replace('0.8', '1'));
    const extendedHoverColors = extendedColors.map(color => color.replace('0.8', '0.9'));
    
    // Get current data
    const currentData = chart.data;
    const labels = currentData.labels;
    const data = currentData.datasets[0].data;
    const total = data.reduce((sum, value) => sum + value, 0);
    
    // Destroy current chart
    chart.destroy();
    
    // Create new chart with different type
    const ctx = document.getElementById(chartId);
    
    // Handle horizontal bar chart properly
    const chartType = newType === 'horizontalBar' ? 'bar' : newType;
    const isHorizontal = newType === 'horizontalBar';
    
    // Adjust container height based on data amount
    const chartContainer = ctx.closest('.chart-container');
    if (chartContainer) {
        const dataCount = labels.length;
        if (dataCount > 10) {
            chartContainer.style.height = isHorizontal ? '500px' : '600px';
        } else if (dataCount > 5) {
            chartContainer.style.height = '450px';
        } else {
            chartContainer.style.height = '400px';
        }
    }
    
    const newChart = new Chart(ctx, {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: '{% trans "Licenses" %}',
                data: data,
                backgroundColor: extendedColors.slice(0, labels.length),
                borderColor: extendedBorderColors.slice(0, labels.length),
                borderWidth: 2,
                hoverBackgroundColor: extendedHoverColors.slice(0, labels.length),
                hoverBorderColor: extendedBorderColors.slice(0, labels.length),
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: isHorizontal ? 'y' : 'x',
            layout: {
                padding: {
                    top: 10,
                    bottom: 10,
                    left: 10,
                    right: 10
                }
            },
            plugins: {
                legend: {
                    position: isHorizontal ? 'right' : 'bottom',
                    maxHeight: 200,
                    labels: {
                        usePointStyle: true,
                        padding: 8,
                        font: {
                            size: 9,
                            weight: '500'
                        },
                        boxWidth: 10,
                        boxHeight: 10,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const dataset = data.datasets[0];
                                    const value = dataset.data[i];
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    // Truncate long labels for better display
                                    const shortLabel = label.length > 25 ? label.substring(0, 22) + '...' : label;
                                    return {
                                        text: `${shortLabel}: ${value} (${percentage}%)`,
                                        fillStyle: dataset.backgroundColor[i],
                                        strokeStyle: dataset.borderColor[i],
                                        lineWidth: dataset.borderWidth,
                                        pointStyle: 'circle'
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#FF6384',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const value = isHorizontal ? context.parsed.x : (context.parsed.y || context.parsed);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: chartType !== 'doughnut' ? {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxRotation: isHorizontal ? 0 : 45,
                        minRotation: isHorizontal ? 0 : 45,
                        maxTicksLimit: isHorizontal ? 15 : 10
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxTicksLimit: isHorizontal ? 10 : 15
                    }
                }
            } : {},
            cutout: chartType === 'doughnut' ? '60%' : undefined,
            radius: chartType === 'doughnut' ? '80%' : undefined
        }
    });
    
    // Store reference
    window[chartId] = newChart;
}
</script>
{% endblock %}
