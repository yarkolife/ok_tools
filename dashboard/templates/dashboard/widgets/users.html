{% extends "dashboard/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">

                <!-- Filters Section -->
                <div class="filter-section">
                    <form id="filtersForm" method="GET">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label">{% trans "Date Range" %}</label>
                                <select class="form-select" id="dateRange" name="days">
                                <option value="7">{% trans "Last 7 days" %}</option>
                                <option value="30">{% trans "Last 30 days" %}</option>
                                <option value="90">{% trans "Last 90 days" %}</option>
                                <option value="365">{% trans "Last year" %}</option>
                                <option value="all">{% trans "All Time" %}</option>
                                <option value="custom">{% trans "Custom Period" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="customStartDate" class="form-label">{% trans "Start Date" %}</label>
                                <input type="date" class="form-control" id="customStartDate" name="start_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="customEndDate" class="form-label">{% trans "End Date" %}</label>
                                <input type="date" class="form-control" id="customEndDate" name="end_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="mediaAuthority" class="form-label">{% trans "Media Authority" %}</label>
                                <select class="form-select" id="mediaAuthority" name="media_authority">
                                <option value="">{% trans "All Authorities" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="genderFilter" class="form-label">{% trans "Gender" %}</label>
                                <select class="form-select" id="genderFilter" name="gender">
                                <option value="">{% trans "All Genders" %}</option>
                                <option value="m">{% trans "Male" %}</option>
                                <option value="f">{% trans "Female" %}</option>
                                <option value="d">{% trans "Diverse" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="ageGroupFilter" class="form-label">{% trans "Age Group" %}</label>
                                <select class="form-select" id="ageGroupFilter" name="age_group">
                                <option value="">{% trans "All Ages" %}</option>
                                <option value="under_18">{% trans "Under 18" %}</option>
                                <option value="18_25">{% trans "18-25" %}</option>
                                <option value="26_35">{% trans "26-35" %}</option>
                                <option value="36_50">{% trans "36-50" %}</option>
                                <option value="over_50">{% trans "Over 50" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="memberFilter" class="form-label">{% trans "Member Status" %}</label>
                                <select class="form-select" id="memberFilter" name="member">
                                <option value="">{% trans "All Users" %}</option>
                                <option value="true">{% trans "Members Only" %}</option>
                                <option value="false">{% trans "Non-Members Only" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="verifiedFilter" class="form-label">{% trans "Verification" %}</label>
                                <select class="form-select" id="verifiedFilter" name="verified">
                                <option value="">{% trans "All Users" %}</option>
                                <option value="true">{% trans "Verified Only" %}</option>
                                <option value="false">{% trans "Not Verified" %}</option>
                            </select>
                        </div>
                    </div>
                        <div class="row mt-3">
                        <div class="col-12">
                                <button type="submit" class="btn btn-primary">{% trans "Apply Filters" %}</button>
                                <button type="button" class="btn btn-secondary" onclick="resetFilters()">{% trans "Reset" %}</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-lg col-md-4 col-sm-6 mb-3">
                        <div class="stat-card" data-type="total" data-title="{% trans 'Total Users' %}">
                            <div class="stat-number" id="totalUsers">{{ widget_data.basic_stats.total_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Total Users" %}</div>
                        </div>
                    </div>
                    <div class="col-lg col-md-4 col-sm-6 mb-3">
                        <div class="stat-card" data-type="male" data-title="{% trans 'Male Users' %}">
                            <div class="stat-number" id="maleUsers">{{ widget_data.basic_stats.male_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Male" %}</div>
                        </div>
                    </div>
                    <div class="col-lg col-md-4 col-sm-6 mb-3">
                        <div class="stat-card" data-type="female" data-title="{% trans 'Female Users' %}">
                            <div class="stat-number" id="femaleUsers">{{ widget_data.basic_stats.female_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Female" %}</div>
                        </div>
                    </div>
                    <div class="col-lg col-md-4 col-sm-6 mb-3">
                        <div class="stat-card" data-type="verified" data-title="{% trans 'Verified Users' %}">
                            <div class="stat-number" id="verifiedUsers">{{ widget_data.basic_stats.verified_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Verified" %}</div>
                        </div>
                    </div>
                    <div class="col-lg col-md-4 col-sm-6 mb-3">
                        <div class="stat-card" data-type="member" data-title="{% trans 'Member Users' %}">
                            <div class="stat-number" id="memberUsers">{{ widget_data.basic_stats.member_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Members" %}</div>
                        </div>
                    </div>
                </div>

                <!-- Chart data will be loaded via AJAX -->
                <!-- Charts Row 1 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Users by Media Authority" %}</h3>
                                <div class="d-flex gap-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary active" onclick="changeChartType('authorityChart', 'doughnut')" title="{% trans 'Doughnut Chart' %}">
                                            <i class="bi bi-pie-chart"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="changeChartType('authorityChart', 'bar')" title="{% trans 'Bar Chart' %}">
                                            <i class="bi bi-bar-chart"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="changeChartType('authorityChart', 'horizontalBar')" title="{% trans 'Horizontal Bar Chart' %}">
                                            <i class="bi bi-bar-chart-steps"></i>
                                        </button>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary" @click="exportChartData('authorityChart')">
                                        <i class="bi bi-download"></i> {% trans "Export" %}
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 400px; overflow: auto; position: relative;">
                                <canvas id="authorityChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Age Distribution" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('ageChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="ageChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Gender Distribution" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('genderChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="genderChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Member vs Non-Member" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('memberChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="memberChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Registration Trend -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Registration Trend" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('trendChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Users by Media Authority" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportTableData('authorityTable')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="authorityTable">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Media Authority" %}</th>
                                            <th>{% trans "User Count" %}</th>
                                            <th>{% trans "Percentage" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if widget_data.users_by_authority %}
                                            {% for item in widget_data.users_by_authority %}
                                            <tr>
                                                <td>{{ item.media_authority__name|default:"Unknown" }}</td>
                                                <td>{{ item.count }}</td>
                                                <td>{% widthratio item.count widget_data.basic_stats.total_users 100 %}%</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">{% trans "No data available" %}</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Age Group Breakdown" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportTableData('ageTable')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="ageTable">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Age Group" %}</th>
                                            <th>{% trans "User Count" %}</th>
                                            <th>{% trans "Percentage" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>{% trans "Under 18" %}</td>
                                            <td>{{ widget_data.age_groups.under_18|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.under_18 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.under_18 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "18-25" %}</td>
                                            <td>{{ widget_data.age_groups.18_25|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.18_25 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.18_25 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "26-35" %}</td>
                                            <td>{{ widget_data.age_groups.26_35|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.26_35 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.26_35 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "36-50" %}</td>
                                            <td>{{ widget_data.age_groups.36_50|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.36_50 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.36_50 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "Over 50" %}</td>
                                            <td>{{ widget_data.age_groups.over_50|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.over_50 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.over_50 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<script>
// Chart instances - make them globally available
window.authorityChart = null;
window.ageChart = null;
window.genderChart = null;
window.memberChart = null;
window.trendChart = null;

// Initialize chart data with empty values
window.chartData = {
    usersByAuthority: [],
    ageGroups: {},
    basicStats: {},
    memberDistribution: {},
    registrationTrend: []
};

// Load filter data via AJAX
async function loadFilterData() {
            try {
                const response = await fetch('/admin-dashboard/api/filters-data/');
                const data = await response.json();

        if (data.success && data.data && data.data.context) {
            console.log('Filter data loaded:', data.data.context);

            // Populate Media Authority options
            const mediaAuthoritySelect = document.getElementById('mediaAuthority');
            if (mediaAuthoritySelect && data.data.context.media_authorities) {
                // Clear existing options except first one
                while (mediaAuthoritySelect.children.length > 1) {
                    mediaAuthoritySelect.removeChild(mediaAuthoritySelect.lastChild);
                }

                data.data.context.media_authorities.forEach(authority => {
                    const option = document.createElement('option');
                    option.value = authority.name;
                    option.textContent = authority.name;
                    mediaAuthoritySelect.appendChild(option);
                });

                console.log(`Loaded ${data.data.context.media_authorities.length} media authorities`);
            }
        } else {
            console.error('Failed to load filter data:', data);
        }
    } catch (error) {
        console.error('Error loading filter data:', error);
    }
}

// Load chart data via AJAX
async function loadChartData() {
    try {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const response = await fetch(`/admin-dashboard/api/users-statistics/?${urlParams.toString()}`);
                const data = await response.json();

        if (data.success && data.data) {
            console.log('API response data:', data.data);
            console.log('basic_stats type:', typeof data.data.basic_stats);
            console.log('basic_stats value:', data.data.basic_stats);
            console.log('registration_trend:', data.data.registration_trend);

            window.chartData = {
                usersByAuthority: data.data.users_by_authority || [],
                ageGroups: data.data.age_groups || {},
                basicStats: data.data.basic_stats || {},
                memberDistribution: data.data.member_distribution || {},
                registrationTrend: data.data.registration_trend || []
            };

            // Update statistics cards if they exist
            if (data.data.basic_stats && typeof data.data.basic_stats === 'object') {
                console.log('Updating statistics cards with:', data.data.basic_stats);
                console.log('window.updateStatisticsCards type:', typeof window.updateStatisticsCards);
                if (typeof window.updateStatisticsCards === 'function') {
                    // Pass the entire data object, not just basic_stats
                    window.updateStatisticsCards(data.data);
                } else {
                    console.error('window.updateStatisticsCards is not a function!');
                }
            } else {
                console.warn('basic_stats not found or invalid in API response:', data.data.basic_stats);
            }

            console.log('Chart data loaded successfully:', window.chartData);
        } else {
            console.error('API returned error or no data:', data);
            window.chartData = {
                usersByAuthority: [],
                ageGroups: {},
                basicStats: {},
                memberDistribution: {},
                registrationTrend: []
            };
        }
    } catch (error) {
        console.error('Error loading chart data:', error);
        window.chartData = {
            usersByAuthority: [],
            ageGroups: {},
            basicStats: {},
            memberDistribution: {},
            registrationTrend: []
        };
    }
}

// Update statistics cards - removed duplicate definition

// Simple filter management without Alpine.js
document.addEventListener('DOMContentLoaded', function() {
    // Initialize filters from URL
    initializeFiltersFromURL();

    // Load filter data
    loadFilterData();

    // Add click handlers for stat cards
    const statCards = document.querySelectorAll('.stat-card[data-type]');
    statCards.forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const title = this.getAttribute('data-title');
            showDetailModal(type, title);
        });

        // Add hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 12px 20px rgba(0,0,0,0.15)';
            this.style.borderColor = '#667eea';
        });

        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.05)';
            this.style.borderColor = 'rgba(0,0,0,0.05)';
        });
    });

    // Add event listeners for form submission
    const filtersForm = document.getElementById('filtersForm');
    if (filtersForm) {
        filtersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
    }

    // Add event listener for date range change
    const dateRangeSelect = document.getElementById('dateRange');
    if (dateRangeSelect) {
        dateRangeSelect.addEventListener('change', function() {
            toggleCustomDateInputs();
        });
    }

    // Initialize custom date inputs visibility
    toggleCustomDateInputs();

    // Load chart data and initialize charts
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error during initialization:', error);
        // Initialize charts with empty data if loading fails
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
});

function initializeFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days');
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');

    if (days) {
        const dateRangeSelect = document.getElementById('dateRange');
        if (dateRangeSelect) {
            dateRangeSelect.value = days;
        }

        if (days === 'custom' && startDate && endDate) {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');
            if (startInput) startInput.value = startDate;
            if (endInput) endInput.value = endDate;
        }
    }

    // Set other filter values from URL
    const filters = ['media_authority', 'gender', 'age_group', 'member', 'verified'];
    filters.forEach(filter => {
        const value = urlParams.get(filter);
        if (value) {
            const element = document.getElementById(filter === 'media_authority' ? 'mediaAuthority' : filter + 'Filter');
            if (element) {
                element.value = value;
            }
        }
    });
}

function toggleCustomDateInputs() {
    const dateRange = document.getElementById('dateRange').value;
    const startDateInput = document.getElementById('customStartDate');
    const endDateInput = document.getElementById('customEndDate');

    if (dateRange === 'custom') {
        startDateInput.style.display = 'block';
        endDateInput.style.display = 'block';
    } else {
        startDateInput.style.display = 'none';
        endDateInput.style.display = 'none';
    }
}

function applyFilters() {
    const form = document.getElementById('filtersForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();

    // Add form data to params
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }

    // Update URL without reloading page
    window.history.pushState({}, '', window.location.pathname + '?' + params.toString());

    // Reload chart data and reinitialize charts
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
}

function resetFilters() {
    // Clear form
    const form = document.getElementById('filtersForm');
    form.reset();

    // Update URL
    window.history.pushState({}, '', window.location.pathname);

    // Reload chart data and reinitialize charts
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
}

// Make initializeCharts globally available
window.initializeCharts = function() {
    // Check if chartData is available
    if (!window.chartData) {
        console.warn('Chart data not available, initializing with empty data');
        window.chartData = {
            usersByAuthority: [],
            ageGroups: {},
            basicStats: {},
            memberDistribution: {},
            registrationTrend: []
        };
    }

    // Destroy existing charts if they exist
    if (window.authorityChart) window.authorityChart.destroy();
    if (window.ageChart) window.ageChart.destroy();
    if (window.genderChart) window.genderChart.destroy();
    if (window.memberChart) window.memberChart.destroy();
    if (window.trendChart) window.trendChart.destroy();

    // Authority Chart - Enhanced Doughnut Chart
    const authorityCtx = document.getElementById('authorityChart');
    if (authorityCtx) {
        const authorityData = window.chartData.usersByAuthority || [];
        const labels = authorityData.map(item => item.media_authority__name || '{% trans "Unknown" %}');
        const data = authorityData.map(item => item.count);
        const total = data.reduce((sum, value) => sum + value, 0);

        // Generate extended color palette
        const extendedColors = [
            'rgba(255, 99, 132, 0.8)',   // Red
            'rgba(54, 162, 235, 0.8)',   // Blue
            'rgba(255, 206, 86, 0.8)',   // Yellow
            'rgba(75, 192, 192, 0.8)',   // Teal
            'rgba(153, 102, 255, 0.8)',  // Purple
            'rgba(255, 159, 64, 0.8)',   // Orange
            'rgba(199, 199, 199, 0.8)',  // Gray
            'rgba(83, 102, 255, 0.8)',   // Indigo
            'rgba(255, 99, 255, 0.8)',   // Pink
            'rgba(99, 255, 132, 0.8)',   // Green
            'rgba(255, 132, 99, 0.8)',   // Light Red
            'rgba(132, 99, 255, 0.8)',   // Light Purple
            'rgba(99, 132, 255, 0.8)',   // Light Blue
            'rgba(255, 255, 99, 0.8)',   // Light Yellow
            'rgba(99, 255, 255, 0.8)'    // Light Cyan
        ];

        const extendedBorderColors = extendedColors.map(color => color.replace('0.8', '1'));
        const extendedHoverColors = extendedColors.map(color => color.replace('0.8', '0.9'));

        // Adjust container height based on data amount
        const chartContainer = authorityCtx.closest('.chart-container');
        if (chartContainer) {
            const dataCount = labels.length;
            if (dataCount > 10) {
                chartContainer.style.height = '600px';
            } else if (dataCount > 5) {
                chartContainer.style.height = '450px';
            } else {
                chartContainer.style.height = '400px';
            }
        }

        window.authorityChart = new Chart(authorityCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: extendedColors.slice(0, labels.length),
                    borderColor: extendedBorderColors.slice(0, labels.length),
                    borderWidth: 2,
                    hoverBackgroundColor: extendedHoverColors.slice(0, labels.length),
                    hoverBorderColor: extendedBorderColors.slice(0, labels.length),
                    hoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }

    // Age Chart - Enhanced Bar Chart
    const ageCtx = document.getElementById('ageChart');
    if (ageCtx) {
        const ageGroups = window.chartData.ageGroups || {};
        const labels = ['{% trans "Under 18" %}', '{% trans "18-25" %}', '{% trans "26-35" %}', '{% trans "36-50" %}', '{% trans "Over 50" %}'];
        const data = [
            ageGroups.under_18 || 0,
            ageGroups['18_25'] || 0,
            ageGroups['26_35'] || 0,
            ageGroups['36_50'] || 0,
            ageGroups.over_50 || 0
        ];

        window.ageChart = new Chart(ageCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '{% trans "Users" %}',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(54, 162, 235, 0.9)',
                    hoverBorderColor: 'rgba(54, 162, 235, 1)',
                    hoverBorderWidth: 3,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#36A2EB',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Age Group" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "Users" %}: ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Age Group" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Users" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                }
            }
        });
    }

    // Gender Chart - Enhanced Pie Chart
    const genderCtx = document.getElementById('genderChart');
    if (genderCtx) {
        const basicStats = window.chartData.basicStats || {};
        const maleData = basicStats.male_users || 0;
        const femaleData = basicStats.female_users || 0;
        const diverseData = basicStats.diverse_users || 0;
        const total = maleData + femaleData + diverseData;

        window.genderChart = new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: ['{% trans "Male" %}', '{% trans "Female" %}', '{% trans "Diverse" %}'],
                datasets: [{
                    data: [maleData, femaleData, diverseData],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(255, 99, 132, 0.9)',
                        'rgba(54, 162, 235, 0.9)',
                        'rgba(255, 206, 86, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                radius: '85%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }

    // Member Chart - Enhanced Doughnut Chart
    const memberCtx = document.getElementById('memberChart');
    if (memberCtx) {
        const memberDistribution = window.chartData.memberDistribution || {};
        const membersData = memberDistribution.members || 0;
        const nonMembersData = memberDistribution.non_members || 0;
        const total = membersData + nonMembersData;

        window.memberChart = new Chart(memberCtx, {
            type: 'doughnut',
            data: {
                labels: ['{% trans "Members" %}', '{% trans "Non-Members" %}'],
                datasets: [{
                    data: [membersData, nonMembersData],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(75, 192, 192, 0.9)',
                        'rgba(153, 102, 255, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#4BC0C0',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }

    // Trend Chart - Enhanced Linear Chart
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        console.log('Creating enhanced trend chart with data:', window.chartData.registrationTrend);

        // Ensure registrationTrend is an array
        const trendData = Array.isArray(window.chartData.registrationTrend) ? window.chartData.registrationTrend : [];

        window.trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.map(item => item.date || ''),
                datasets: [{
                    label: '{% trans "New Registrations" %}',
                    data: trendData.map(item => item.count || 0),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: '#667eea',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    borderWidth: 3,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#667eea',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Date" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "New Registrations" %}: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Date" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of New Registrations" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });
    }
}

// Make updateCharts globally available
window.updateCharts = async function(filters) {
    try {
        const params = new URLSearchParams(filters);

        // Update users statistics
        const response = await fetch(`/admin-dashboard/api/users-statistics/?${params}`);
        const data = await response.json();

        if (data.success) {
            updateChartData(data.data);
            updateStatistics(data.data);
        }
    } catch (error) {
        console.error('{% trans "Error updating charts:" %}', error);
    }
}

// Make updateChartData globally available
window.updateChartData = function(data) {
    // Update Authority Chart
    if (window.authorityChart && data.users_by_authority) {
        window.authorityChart.data.labels = data.users_by_authority.map(item => item.media_authority__name || '{% trans "Unknown" %}');
        window.authorityChart.data.datasets[0].data = data.users_by_authority.map(item => item.count);
        window.authorityChart.update();
    }

    // Update Age Chart
    if (window.ageChart && data.age_groups) {
        window.ageChart.data.datasets[0].data = [
            data.age_groups.under_18 || 0,
            data.age_groups['18_25'] || 0,
            data.age_groups['26_35'] || 0,
            data.age_groups['36_50'] || 0,
            data.age_groups.over_50 || 0
        ];
        window.ageChart.update();
    }

    // Update Gender Chart
    if (window.genderChart && data.basic_stats) {
        window.genderChart.data.datasets[0].data = [
            data.basic_stats.male_users || 0,
            data.basic_stats.female_users || 0,
            data.basic_stats.diverse_users || 0
        ];
        window.genderChart.update();
    }

    // Update Member Chart
    if (window.memberChart && data.member_distribution) {
        window.memberChart.data.datasets[0].data = [
            data.member_distribution.members || 0,
            data.member_distribution.non_members || 0
        ];
        window.memberChart.update();
    }

    // Update Trend Chart
    if (window.trendChart && data.registration_trend) {
        window.trendChart.data.labels = data.registration_trend.map(item => item.date);
        window.trendChart.data.datasets[0].data = data.registration_trend.map(item => item.count);
        window.trendChart.update();
    }
}

// Make updateStatistics globally available
window.updateStatistics = function(data) {
    // Update statistics cards safely
    updateStatisticsCards(data);
}

// Make updateStatisticsCards globally available
window.updateStatisticsCards = function(data) {
    console.log('=== {% trans "updateStatisticsCards START" %} ===');
    console.log('{% trans "data parameter:" %}', data);

    // Check if data and basic_stats exist
    if (!data || !data.basic_stats || typeof data.basic_stats !== 'object') {
        console.warn('{% trans "data or basic_stats is invalid, skipping statistics update" %}');
        console.log('=== {% trans "updateStatisticsCards END (early return)" %} ===');
        return;
    }

    const elements = {
        'totalUsers': data.basic_stats.total_users || 0,
        'maleUsers': data.basic_stats.male_users || 0,
        'femaleUsers': data.basic_stats.female_users || 0,
        'verifiedUsers': data.basic_stats.verified_users || 0,
        'memberUsers': data.basic_stats.member_users || 0
    };

    console.log('{% trans "Elements to update:" %}', elements);

    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
            console.log(`{% trans "Updated" %} ${id} {% trans "with value:" %} ${value}`);
        } else {
            console.warn(`{% trans "Element with id" %} '${id}' {% trans "not found" %}`);
        }
    });

    console.log('=== {% trans "updateStatisticsCards END" %} ===');
}

// Make exportChartData globally available
window.exportChartData = function(chartId) {
    const chart = getChartInstance(chartId);
    if (chart) {
        const data = chart.data;
        const csv = convertToCSV(data);
        downloadCSV(csv, `${chartId}_data.csv`);
    }
}

// Make exportTableData globally available
window.exportTableData = function(tableId) {
    const table = document.getElementById(tableId);
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = convertTableToCSV(rows);
    downloadCSV(csv, `${tableId}_data.csv`);
}

// Make getChartInstance globally available
window.getChartInstance = function(chartId) {
    switch(chartId) {
        case 'authorityChart': return window.authorityChart;
        case 'ageChart': return window.ageChart;
        case 'genderChart': return window.genderChart;
        case 'memberChart': return window.memberChart;
        case 'trendChart': return window.trendChart;
        default: return null;
    }
}

// Make convertToCSV globally available
window.convertToCSV = function(data) {
    const labels = data.labels;
    const values = data.datasets[0].data;

    let csv = 'Label,Value\n';
    for (let i = 0; i < labels.length; i++) {
        csv += `"${labels[i]}",${values[i]}\n`;
    }

    return csv;
}

// Make convertTableToCSV globally available
window.convertTableToCSV = function(rows) {
    let csv = '';
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
        csv += rowData + '\n';
    });
    return csv;
}

// Make downloadCSV globally available
window.downloadCSV = function(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Interactive navigation functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to stat cards
    const statCards = document.querySelectorAll('.clickable-stat');
    statCards.forEach(card => {
        card.addEventListener('click', function() {
            const type = this.dataset.type;
            const title = this.dataset.title;
            showDetailModal(type, title);
        });

        // Add hover effect
        card.style.cursor = 'pointer';
    });
});

// Show detail modal
function showDetailModal(type, title) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('detailModal');
    if (!modal) {
        modal = createDetailModal();
        document.body.appendChild(modal);
    }

    // Store current type in modal dataset
    modal.dataset.currentType = type;

    // Update modal title
    const modalTitle = modal.querySelector('.modal-title');
    modalTitle.textContent = title;

    // Show loading state
    const modalBody = modal.querySelector('.modal-body');
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">{% trans "Loading..." %}</span></div></div>';

    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // Load data
    loadDetailData(type, modalBody);
}

// Create detail modal
function createDetailModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'detailModal';
    modal.tabIndex = -1;
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Detail View" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                    <button type="button" class="btn btn-primary" onclick="exportDetailData()">{% trans "Export CSV" %}</button>
                </div>
            </div>
        </div>
    `;
    return modal;
}

// Load detail data
async function loadDetailData(type, modalBody, page = 1) {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('type', type);
        urlParams.set('page', page);

        const response = await fetch(`/admin-dashboard/api/users-detail/?${urlParams.toString()}`);
        const data = await response.json();

        if (data.success) {
            displayDetailData(data.data, modalBody);
        } else {
            modalBody.innerHTML = `<div class="alert alert-danger">{% trans "Error:" %} ${data.error}</div>`;
        }
    } catch (error) {
        modalBody.innerHTML = `<div class="alert alert-danger">{% trans "Error loading data:" %} ${error.message}</div>`;
    }
}

// Load specific page
function loadPage(page) {
    const modal = document.getElementById('detailModal');
    const modalBody = modal.querySelector('.modal-body');
    const type = modal.dataset.currentType || 'total';

    // Show loading state
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">{% trans "Loading..." %}</span></div></div>';

    // Load data for the specified page
    loadDetailData(type, modalBody, page);
}

// Display detail data
function displayDetailData(data, modalBody) {
    const { users, total_count, displayed_count, pagination } = data;

    let html = `
        <div class="mb-3">
            <div class="row">
                <div class="col-md-6">
                    <strong>{% trans "Total Records:" %}</strong> ${total_count}
                </div>
                <div class="col-md-6">
                    <strong>{% trans "Displayed:" %}</strong> ${pagination.start_index}-${pagination.end_index} {% trans "of" %} ${total_count}
                </div>
            </div>
        </div>
    `;

    if (users.length > 0) {
        html += `
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="detailTable">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Email" %}</th>
                            <th>{% trans "Gender" %}</th>
                            <th>{% trans "Age" %}</th>
                            <th>{% trans "Verified" %}</th>
                            <th>{% trans "Member" %}</th>
                            <th>{% trans "Media Authority" %}</th>
                            <th>{% trans "City" %}</th>
                            <th>{% trans "Created" %}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        users.forEach(user => {
            html += `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.gender}</td>
                    <td>${user.age}</td>
                    <td>${user.verified ? '<span class="badge bg-success">{% trans "Yes" %}</span>' : '<span class="badge bg-secondary">{% trans "No" %}</span>'}</td>
                    <td>${user.member ? '<span class="badge bg-primary">{% trans "Yes" %}</span>' : '<span class="badge bg-secondary">{% trans "No" %}</span>'}</td>
                    <td>${user.media_authority}</td>
                    <td>${user.city}</td>
                    <td>${user.created_at}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        // Add pagination
        if (pagination.total_pages > 1) {
            html += `
                <nav aria-label="{% trans "User pagination" %}" class="mt-3">
                    <ul class="pagination justify-content-center">
                        <li class="page-item ${!pagination.has_previous ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="loadPage(${pagination.current_page - 1}); return false;">{% trans "Previous" %}</a>
                        </li>
            `;

            // Page numbers
            const startPage = Math.max(1, pagination.current_page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadPage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            html += `
                        <li class="page-item ${!pagination.has_next ? 'disabled' : ''}">
                            <a class="page-link" href="#" onclick="loadPage(${pagination.current_page + 1}); return false;">{% trans "Next" %}</a>
                        </li>
                    </ul>
                </nav>
            `;
        }
    } else {
        html += '<div class="alert alert-info">{% trans "No data found for the selected criteria." %}</div>';
    }

    modalBody.innerHTML = html;
}

// Export detail data
function exportDetailData() {
    const table = document.getElementById('detailTable');
    if (table) {
        const rows = table.querySelectorAll('tr');
        const csv = window.convertTableToCSV(rows);
        const filename = `users_detail_${new Date().toISOString().split('T')[0]}.csv`;
        window.downloadCSV(csv, filename);
    }
}

// Function to change chart type
function changeChartType(chartId, newType) {
    const chart = window[chartId];
    if (!chart) return;

    // Update button states
    const buttonGroup = document.querySelector(`[onclick*="${chartId}"]`)?.closest('.btn-group');
    if (buttonGroup) {
        const buttons = buttonGroup.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.onclick && btn.onclick.toString().includes(newType)) {
                btn.classList.add('active');
            }
        });
    }

    // Generate extended color palette
    const extendedColors = [
        'rgba(255, 99, 132, 0.8)',   // Red
        'rgba(54, 162, 235, 0.8)',   // Blue
        'rgba(255, 206, 86, 0.8)',   // Yellow
        'rgba(75, 192, 192, 0.8)',   // Teal
        'rgba(153, 102, 255, 0.8)',  // Purple
        'rgba(255, 159, 64, 0.8)',   // Orange
        'rgba(199, 199, 199, 0.8)',  // Gray
        'rgba(83, 102, 255, 0.8)',   // Indigo
        'rgba(255, 99, 255, 0.8)',   // Pink
        'rgba(99, 255, 132, 0.8)',   // Green
        'rgba(255, 132, 99, 0.8)',   // Light Red
        'rgba(132, 99, 255, 0.8)',   // Light Purple
        'rgba(99, 132, 255, 0.8)',   // Light Blue
        'rgba(255, 255, 99, 0.8)',   // Light Yellow
        'rgba(99, 255, 255, 0.8)'    // Light Cyan
    ];

    const extendedBorderColors = extendedColors.map(color => color.replace('0.8', '1'));
    const extendedHoverColors = extendedColors.map(color => color.replace('0.8', '0.9'));

    // Get current data
    const currentData = chart.data;
    const labels = currentData.labels;
    const data = currentData.datasets[0].data;
    const total = data.reduce((sum, value) => sum + value, 0);

    // Destroy current chart
    chart.destroy();

    // Create new chart with different type
    const ctx = document.getElementById(chartId);

    // Handle horizontal bar chart properly
    const chartType = newType === 'horizontalBar' ? 'bar' : newType;
    const isHorizontal = newType === 'horizontalBar';

    // Adjust container height based on data amount
    const chartContainer = ctx.closest('.chart-container');
    if (chartContainer) {
        const dataCount = labels.length;
        if (dataCount > 10) {
            chartContainer.style.height = isHorizontal ? '500px' : '600px';
        } else if (dataCount > 5) {
            chartContainer.style.height = '450px';
        } else {
            chartContainer.style.height = '400px';
        }
    }

    const newChart = new Chart(ctx, {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: '{% trans "Users" %}',
                data: data,
                backgroundColor: extendedColors.slice(0, labels.length),
                borderColor: extendedBorderColors.slice(0, labels.length),
                borderWidth: 2,
                hoverBackgroundColor: extendedHoverColors.slice(0, labels.length),
                hoverBorderColor: extendedBorderColors.slice(0, labels.length),
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: isHorizontal ? 'y' : 'x',
            layout: {
                padding: {
                    top: 10,
                    bottom: 10,
                    left: 10,
                    right: 10
                }
            },
            plugins: {
                legend: {
                    position: isHorizontal ? 'right' : 'bottom',
                    maxHeight: 200,
                    labels: {
                        usePointStyle: true,
                        padding: 8,
                        font: {
                            size: 9,
                            weight: '500'
                        },
                        boxWidth: 10,
                        boxHeight: 10,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const dataset = data.datasets[0];
                                    const value = dataset.data[i];
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    // Truncate long labels for better display
                                    const shortLabel = label.length > 25 ? label.substring(0, 22) + '...' : label;
                                    return {
                                        text: `${shortLabel}: ${value} (${percentage}%)`,
                                        fillStyle: dataset.backgroundColor[i],
                                        strokeStyle: dataset.borderColor[i],
                                        lineWidth: dataset.borderWidth,
                                        pointStyle: 'circle'
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#FF6384',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const value = isHorizontal ? context.parsed.x : (context.parsed.y || context.parsed);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: chartType !== 'doughnut' ? {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxRotation: isHorizontal ? 0 : 45,
                        minRotation: isHorizontal ? 0 : 45,
                        maxTicksLimit: isHorizontal ? 15 : 10
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxTicksLimit: isHorizontal ? 10 : 15
                    }
                }
            } : {},
            cutout: chartType === 'doughnut' ? '60%' : undefined,
            radius: chartType === 'doughnut' ? '80%' : undefined
        }
    });

    // Store reference
    window[chartId] = newChart;
}
</script>
{% endblock %}
