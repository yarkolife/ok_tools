{% extends "dashboard/base.html" %}
{% load i18n %}

{% block title %}{% trans "Rental Statistics" %}{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
        <div class="card">
            <div class="card-header">
            <h5 class="card-title mb-0">{% trans "Filters" %}</h5>
            </div>
            <div class="card-body">
            <form id="filtersForm">

                <!-- Row 1: Zeitraum + User -->
                <div class="row mb-3">
                <div class="col-md-2">
                    <label for="dateRange" class="form-label">{% trans "Time Period" %}</label>
                    <select class="form-select" id="dateRange" name="days">
                    <option value="7">{% trans "Last 7 days" %}</option>
                    <option value="30" selected>{% trans "Last 30 days" %}</option>
                    <option value="90">{% trans "Last 90 days" %}</option>
                    <option value="365">{% trans "Last year" %}</option>
                    <option value="custom">{% trans "Custom Period" %}</option>
                    </select>
                </div>
                <div class="col-md-2" id="customDateInputs" style="display: none;">
                    <label for="startDate" class="form-label">{% trans "Start Date" %}</label>
                    <input type="date" class="form-control" id="startDate" name="start_date">
                </div>
                <div class="col-md-2" id="customDateInputs2" style="display: none;">
                    <label for="endDate" class="form-label">{% trans "End Date" %}</label>
                    <input type="date" class="form-control" id="endDate" name="end_date">
                </div>
                <div class="col-md-2">
                    <label for="gender" class="form-label">{% trans "Gender" %}</label>
                    <select class="form-select" id="gender" name="gender">
                    <option value="">{% trans "All" %}</option>
                    <option value="m">{% trans "Male" %}</option>
                    <option value="f">{% trans "Female" %}</option>
                    <option value="d">{% trans "Diverse" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="member" class="form-label">{% trans "Membership" %}</label>
                    <select class="form-select" id="member" name="member">
                    <option value="">{% trans "All" %}</option>
                    <option value="true">{% trans "Members" %}</option>
                    <option value="false">{% trans "Non-members" %}</option>
                    </select>
                </div>
                </div>

                <!-- Row 2: Inventory -->
                <div class="row mb-3">
                <div class="col-md-2">
                    <label for="category" class="form-label">{% trans "Category" %}</label>
                    <select class="form-select" id="category" name="category">
                    <option value="">{% trans "All" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="owner" class="form-label">{% trans "Owner" %}</label>
                    <select class="form-select" id="owner" name="owner">
                    <option value="">{% trans "All" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="location" class="form-label">{% trans "Location" %}</label>
                    <select class="form-select" id="location" name="location">
                    <option value="">{% trans "All" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">{% trans "Status" %}</label>
                    <select class="form-select" id="status" name="status">
                    <option value="">{% trans "All" %}</option>
                    <option value="in_stock">{% trans "In Stock" %}</option>
                    <option value="out_of_stock">{% trans "Out of Stock" %}</option>
                    <option value="maintenance">{% trans "Maintenance" %}</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-primary me-2" id="applyFiltersBtn">{% trans "Apply Filters" %}</button>
                    <button type="button" class="btn btn-secondary" onclick="window.resetInventoryFilters()">{% trans "Reset" %}</button>
                </div>
                </div>

            </form>
            </div>
        </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="stat-card" data-type="total" data-title="{% trans 'Total Items' %}">
                <div class="stat-number" id="totalItems">-</div>
                <div class="stat-label">{% trans "Total Items" %}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card" data-type="available" data-title="{% trans 'Available Items' %}">
                <div class="stat-number" id="inStockItems">-</div>
                <div class="stat-label">{% trans "In Stock" %}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card" data-type="total_rentals" data-title="{% trans 'Total Rentals' %}">
                <div class="stat-number" id="totalRentals">-</div>
                <div class="stat-label">{% trans "Total Rentals" %}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card" data-type="active_rentals" data-title="{% trans 'Active Rentals' %}">
                <div class="stat-number" id="activeRentals">-</div>
                <div class="stat-label">{% trans "Active Rentals" %}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card" data-type="rentals" data-title="{% trans 'Rented Items' %}">
                <div class="stat-number" id="rentedItems">-</div>
                <div class="stat-label">{% trans "Rented" %}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-number" id="utilizationRate">-</div>
                <div class="stat-label">{% trans "Utilization Rate" %}</div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Inventory by Category" %}</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('inventoryByCategoryChart')">
                        <i class="bi bi-download"></i> {% trans "Export" %}
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="inventoryByCategoryChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Inventory by Owner" %}</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('inventoryByOwnerChart')">
                        <i class="bi bi-download"></i> {% trans "Export" %}
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="inventoryByOwnerChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Rentals by Status" %}</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('rentalsByStatusChart')">
                        <i class="bi bi-download"></i> {% trans "Export" %}
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="rentalsByStatusChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Rentals by Type" %}</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('rentalsByTypeChart')">
                        <i class="bi bi-download"></i> {% trans "Export" %}
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="rentalsByTypeChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Rentals by Gender" %}</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('rentalsByGenderChart')">
                        <i class="bi bi-download"></i> {% trans "Export" %}
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="rentalsByGenderChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Rentals Trend" %}</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('rentalsTrendChart')">
                        <i class="bi bi-download"></i> {% trans "Export" %}
                    </button>
                </div>
                <div class="card-body">
                    <canvas id="rentalsTrendChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Sets Statistics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Equipment Sets Statistics" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-primary" id="activeSets">-</h4>
                                <p class="text-muted">{% trans "Active Sets" %}</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-success" id="availableSets">-</h4>
                                <p class="text-muted">{% trans "Available Sets" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Popular Equipment Sets" %}</h5>
                </div>
                <div class="card-body">
                    <div id="popularSetsList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Inventory Statistics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Popular Inventory Statistics" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-primary" id="availableItems">-</h4>
                                <p class="text-muted">{% trans "Available Items" %}</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-info" id="totalRentals">-</h4>
                                <p class="text-muted">{% trans "Total Rentals" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Popular Inventory Items" %}</h5>
                </div>
                <div class="card-body">
                    <div id="popularInventoryList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- User Activity Analytics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "User Activity Analytics" %}</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-warning">{% trans "Anti-Rating" %}</h6>
                    <p class="text-muted small">{% trans "Users who rent but don't create licenses" %}</p>
                    <div id="antiRatingList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Content Creators" %}</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-success">{% trans "Rating" %}</h6>
                    <p class="text-muted small">{% trans "Users who create licenses but don't rent much" %}</p>
                    <div id="ratingList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Rentals Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">{% trans "Room Rentals Statistics" %}</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('roomTrendChart')">
                        <i class="bi bi-download"></i> {% trans "Export" %}
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{% trans "Room Usage Trend" %}</h6>
                            <canvas id="roomTrendChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h6>{% trans "Popular Rooms" %}</h6>
                            <div id="popularRoomsStats">
                                <p class="text-muted">{% trans "Loading..." %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{% trans "Loading..." %}</span>
    </div>
</div>

<script>
// Global chart variables
window.inventoryByCategoryChart = null;
window.inventoryByOwnerChart = null;
window.rentalsByStatusChart = null;
window.rentalsByTypeChart = null;
window.rentalsByGenderChart = null;
window.rentalsTrendChart = null;
window.roomTrendChart = null;

// Toggle custom date inputs for inventory
function toggleInventoryCustomDateInputs() {
    const dateRange = document.getElementById('dateRange');
    const customInputs = document.getElementById('customDateInputs');
    const customInputs2 = document.getElementById('customDateInputs2');

    console.log('toggleInventoryCustomDateInputs called');
    console.log('dateRange value:', dateRange ? dateRange.value : 'dateRange not found');
    console.log('customInputs found:', !!customInputs);
    console.log('customInputs2 found:', !!customInputs2);

    if (dateRange && customInputs && customInputs2) {
        if (dateRange.value === 'custom') {
            customInputs.style.display = 'block';
            customInputs2.style.display = 'block';
            console.log('Showing custom date inputs');
        } else {
            customInputs.style.display = 'none';
            customInputs2.style.display = 'none';
            console.log('Hiding custom date inputs');
        }
    } else {
        console.error('Required elements not found for toggleInventoryCustomDateInputs');
    }
}

// Define resetFilters function
window.resetInventoryFilters = function() {
    const form = document.getElementById('filtersForm');
    if (form) {
        form.reset();
        // Set default values
        document.getElementById('dateRange').value = '30';
        toggleInventoryCustomDateInputs();
        // Apply filters with default values
        window.applyInventoryFilters();
    }
};

// Define applyFilters function early
window.applyInventoryFilters = function() {
    const form = document.getElementById('filtersForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();

    for (let [key, value] of formData.entries()) {
        // Skip empty, undefined, or null values
        if (value && value !== 'undefined' && value !== 'null' && value.trim() !== '') {
            // Handle custom date period
            if (key === 'days' && value === 'custom') {
                // Don't add days parameter for custom period
                continue;
            }
            params.append(key, value);
        }
    }

    window.history.pushState({}, '', window.location.pathname + '?' + params.toString());

    loadChartData().then(function() {
        // Update statistics cards
        if (window.chartData && window.chartData.basic_stats) {
            updateStatisticsCards(window.chartData.basic_stats);
        }

        // Update charts
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
};



// Load chart data via AJAX
async function loadChartData() {
    try {
        setLoadingState(true);
        const urlParams = new URLSearchParams(window.location.search);
        const response = await fetch(`/admin-dashboard/api/inventory-statistics/?${urlParams.toString()}`).then(r => r.json());
        const data = response;

        if (data.success && data.data) {
            window.chartData = {
                basic_stats: data.data.basic_stats || {},
                inventory_by_category: data.data.inventory_by_category || [],
                inventory_by_owner: data.data.inventory_by_owner || [],
                rentals_by_status: data.data.rentals_by_status || [],
                rentals_by_type: data.data.rentals_by_type || [],
                rentals_by_demographics: data.data.rentals_by_demographics || {},
                rentals_trend: data.data.rentals_trend || [],
                equipment_sets_stats: data.data.equipment_sets_stats || {},
                popular_inventory_stats: data.data.popular_inventory_stats || {},
                user_activity_analytics: data.data.user_activity_analytics || {},
                room_rentals_stats: data.data.room_rentals_stats || {}
            };

            // Update statistics cards
            updateStatisticsCards(data.data.basic_stats);

        } else {
            console.error('API returned error or no data:', data);
            window.chartData = {
                basic_stats: {},
                inventory_by_category: [],
                inventory_by_owner: [],
                rentals_by_status: [],
                rentals_by_type: [],
                rentals_by_demographics: {},
                rentals_trend: [],
                equipment_sets_stats: {},
                popular_inventory_stats: {},
                user_activity_analytics: {},
                room_rentals_stats: {}
            };
        }
    } catch (error) {
        console.error('Error loading chart data:', error);
        window.chartData = {
            basic_stats: {},
            inventory_by_category: [],
            inventory_by_owner: [],
            rentals_by_status: [],
            rentals_by_type: [],
            rentals_by_demographics: {},
            rentals_trend: [],
            equipment_sets_stats: {},
            popular_inventory_stats: {},
            user_activity_analytics: {},
            room_rentals_stats: {}
        };
    } finally {
        setLoadingState(false);
    }
}

// Update statistics cards
window.updateStatisticsCards = function(basicStats) {
    if (!basicStats || typeof basicStats !== 'object') {
        console.warn('basicStats is undefined or not an object, skipping statistics update');
        return;
    }

    // Update basic statistics
    document.getElementById('totalItems').textContent = basicStats.total_items || 0;
    document.getElementById('inStockItems').textContent = basicStats.in_stock_items || 0;
    document.getElementById('rentedItems').textContent = basicStats.rented_items || 0;
    document.getElementById('totalRentals').textContent = basicStats.total_rentals || 0;
    document.getElementById('activeRentals').textContent = basicStats.active_rentals || 0;
    document.getElementById('utilizationRate').textContent = (basicStats.utilization_rate || 0) + '%';

    // Update equipment sets stats
    const equipmentStats = window.chartData.equipment_sets_stats || {};
    document.getElementById('activeSets').textContent = equipmentStats.active_sets || 0;
    document.getElementById('availableSets').textContent = equipmentStats.available_sets || 0;

    // Update popular inventory stats
    const popularInventoryStats = window.chartData.popular_inventory_stats || {};
    document.getElementById('availableItems').textContent = popularInventoryStats.total_available_items || 0;

    // Calculate total rentals from popular items
    const totalRentals = (popularInventoryStats.popular_items || []).reduce((sum, item) => sum + (item.rental_count || 0), 0);
    document.getElementById('totalRentals').textContent = totalRentals;

    // Update popular sets
    const popularSetsList = document.getElementById('popularSetsList');
    if (equipmentStats.popular_sets && equipmentStats.popular_sets.length > 0) {
        popularSetsList.innerHTML = equipmentStats.popular_sets.map(set =>
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <span>${set.name}</span>
                <span class="badge bg-primary">${set.usage_count}</span>
            </div>`
        ).join('');
    } else {
        popularSetsList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }

    // Update popular inventory items
    const popularInventoryList = document.getElementById('popularInventoryList');
    if (popularInventoryStats.popular_items && popularInventoryStats.popular_items.length > 0) {
        popularInventoryList.innerHTML = popularInventoryStats.popular_items.map(item =>
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">${item.manufacturer || ''}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-info">${item.rental_count}</span>
                </div>
            </div>`
        ).join('');
    } else {
        popularInventoryList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }

    // Update user activity analytics
    const userActivityAnalytics = window.chartData.user_activity_analytics || {};

    // Update anti-rating list
    const antiRatingList = document.getElementById('antiRatingList');
    if (userActivityAnalytics.anti_rating && userActivityAnalytics.anti_rating.length > 0) {
        antiRatingList.innerHTML = userActivityAnalytics.anti_rating.map(user =>
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${user.username}</div>
                    <small class="text-muted">${user.gender || '{% trans "Unknown" %}'}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-warning">${user.rental_count}</span>
                    <small class="text-muted d-block">{% trans "rentals" %}</small>
                </div>
            </div>`
        ).join('');
    } else {
        antiRatingList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }

    // Update rating list
    const ratingList = document.getElementById('ratingList');
    if (userActivityAnalytics.rating && userActivityAnalytics.rating.length > 0) {
        ratingList.innerHTML = userActivityAnalytics.rating.map(user =>
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${user.username}</div>
                    <small class="text-muted">${user.gender || '{% trans "Unknown" %}'}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-success">${user.license_count}</span>
                    <small class="text-muted d-block">{% trans "licenses" %}</small>
                </div>
            </div>`
        ).join('');
    } else {
        ratingList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }
}

// Set loading state
function setLoadingState(loading) {
    const overlay = document.getElementById('loadingOverlay');
    if (loading) {
        overlay.style.display = 'flex';
    } else {
        overlay.style.display = 'none';
    }
}

// Make initializeCharts globally available
window.initializeCharts = function() {
    console.log('initializeCharts called');

    // Prevent multiple simultaneous calls
    if (window.initializingCharts) {
        console.log('initializeCharts already running, skipping');
        return;
    }
    window.initializingCharts = true;
    // Check if chartData is available
    if (!window.chartData) {
        console.warn('Chart data not available, initializing with empty data');
        window.chartData = {
            basic_stats: {},
            inventory_by_category: [],
            inventory_by_owner: [],
            rentals_by_status: [],
            rentals_by_type: [],
            rentals_by_demographics: {},
            rentals_trend: [],
            equipment_sets_stats: {},
            room_rentals_stats: {}
        };
    }

    // Ensure all data arrays exist
    if (!window.chartData.inventory_by_category) window.chartData.inventory_by_category = [];
    if (!window.chartData.inventory_by_owner) window.chartData.inventory_by_owner = [];
    if (!window.chartData.rentals_by_status) window.chartData.rentals_by_status = [];
    if (!window.chartData.rentals_by_type) window.chartData.rentals_by_type = [];
    if (!window.chartData.rentals_by_demographics) window.chartData.rentals_by_demographics = {};
    if (!window.chartData.rentals_trend) window.chartData.rentals_trend = [];
    if (!window.chartData.equipment_sets_stats) window.chartData.equipment_sets_stats = {};
    if (!window.chartData.room_rentals_stats) window.chartData.room_rentals_stats = {};

    // Destroy and recreate all charts
    // Destroy existing charts
    if (window.inventoryByCategoryChart) {
        window.inventoryByCategoryChart.destroy();
        window.inventoryByCategoryChart = null;
    }

    if (window.inventoryByOwnerChart) {
        window.inventoryByOwnerChart.destroy();
        window.inventoryByOwnerChart = null;
    }

    if (window.rentalsByStatusChart) {
        window.rentalsByStatusChart.destroy();
        window.rentalsByStatusChart = null;
    }

    if (window.rentalsByTypeChart) {
        window.rentalsByTypeChart.destroy();
        window.rentalsByTypeChart = null;
    }

    if (window.rentalsByGenderChart) {
        window.rentalsByGenderChart.destroy();
        window.rentalsByGenderChart = null;
    }

    if (window.rentalsTrendChart) {
        window.rentalsTrendChart.destroy();
        window.rentalsTrendChart = null;
    }

    if (window.roomTrendChart) {
        console.log('Destroying roomTrendChart');
        window.roomTrendChart.destroy();
        window.roomTrendChart = null;
    }

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }

    // Inventory by Category Chart - Enhanced Bar Chart
    const categoryCtx = document.getElementById('inventoryByCategoryChart');
    if (categoryCtx) {
        const categoryData = window.chartData.inventory_by_category || [];
        const categoryLabels = categoryData.map(item => item.name);
        const totalItemsData = categoryData.map(item => item.total_items);
        const rentedItemsData = categoryData.map(item => item.rented_items);

        window.inventoryByCategoryChart = new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: '{% trans "Total Items" %}',
                    data: totalItemsData,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(54, 162, 235, 0.9)',
                    hoverBorderColor: 'rgba(54, 162, 235, 1)',
                    hoverBorderWidth: 3,
                    borderRadius: 6,
                    borderSkipped: false
                }, {
                    label: '{% trans "Rented Items" %}',
                    data: rentedItemsData,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(255, 99, 132, 0.9)',
                    hoverBorderColor: 'rgba(255, 99, 132, 1)',
                    hoverBorderWidth: 3,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#36A2EB',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Category" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Category',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Items" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                }
            }
        });
    }

    // Inventory by Owner Chart - Enhanced Doughnut Chart
    const ownerCtx = document.getElementById('inventoryByOwnerChart');
    if (ownerCtx) {
        const ownerData = window.chartData.inventory_by_owner || [];
        const ownerLabels = ownerData.map(item => item.name);
        const ownerValues = ownerData.map(item => item.total_items);
        const ownerTotal = ownerValues.reduce((sum, value) => sum + value, 0);

        window.inventoryByOwnerChart = new Chart(ownerCtx, {
            type: 'doughnut',
            data: {
                labels: ownerLabels,
                datasets: [{
                    data: ownerValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(201, 203, 207, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(201, 203, 207, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(255, 99, 132, 0.9)',
                        'rgba(54, 162, 235, 0.9)',
                        'rgba(255, 206, 86, 0.9)',
                        'rgba(75, 192, 192, 0.9)',
                        'rgba(153, 102, 255, 0.9)',
                        'rgba(255, 159, 64, 0.9)',
                        'rgba(201, 203, 207, 0.9)',
                        'rgba(255, 99, 132, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(201, 203, 207, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = ownerTotal > 0 ? ((value / ownerTotal) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = ownerTotal > 0 ? ((value / ownerTotal) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }

    // Rentals by Status Chart - Enhanced Pie Chart
    const statusCtx = document.getElementById('rentalsByStatusChart');
    if (statusCtx) {
        const statusData = window.chartData.rentals_by_status || [];
        const statusLabels = statusData.map(item => item.status);
        const statusValues = statusData.map(item => item.count);
        const statusTotal = statusValues.reduce((sum, value) => sum + value, 0);

        window.rentalsByStatusChart = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(201, 203, 207, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(201, 203, 207, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(255, 99, 132, 0.9)',
                        'rgba(54, 162, 235, 0.9)',
                        'rgba(255, 206, 86, 0.9)',
                        'rgba(75, 192, 192, 0.9)',
                        'rgba(153, 102, 255, 0.9)',
                        'rgba(255, 159, 64, 0.9)',
                        'rgba(201, 203, 207, 0.9)',
                        'rgba(255, 99, 132, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(201, 203, 207, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                radius: '85%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = statusTotal > 0 ? ((value / statusTotal) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = statusTotal > 0 ? ((value / statusTotal) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }

    // Rentals by Type Chart - Enhanced Bar Chart
    const typeCtx = document.getElementById('rentalsByTypeChart');
    if (typeCtx) {
        const typeData = window.chartData.rentals_by_type || [];
        const typeLabels = typeData.map(item => item.type);
        const typeValues = typeData.map(item => item.count);

        window.rentalsByTypeChart = new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: typeLabels,
                datasets: [{
                    label: '{% trans "Count" %}',
                    data: typeValues,
                    backgroundColor: 'rgba(153, 102, 255, 0.8)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    hoverBackgroundColor: 'rgba(153, 102, 255, 0.9)',
                    hoverBorderColor: 'rgba(153, 102, 255, 1)',
                    hoverBorderWidth: 3,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#9966FF',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Type" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "Count" %}: ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Rental Type" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Rentals" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                }
            }
        });
    }

    // Rentals by Gender Chart - Enhanced Doughnut Chart
    const genderCtx = document.getElementById('rentalsByGenderChart');
    if (genderCtx) {
        const genderData = window.chartData.rentals_by_demographics.gender || [];
        const genderLabels = genderData.map(item => item.user__profile__gender || 'Unknown');
        const genderValues = genderData.map(item => item.count);
        const genderTotal = genderValues.reduce((sum, value) => sum + value, 0);

        window.rentalsByGenderChart = new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: genderLabels,
                datasets: [{
                    data: genderValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 3,
                    hoverBackgroundColor: [
                        'rgba(255, 99, 132, 0.9)',
                        'rgba(54, 162, 235, 0.9)',
                        'rgba(255, 206, 86, 0.9)',
                        'rgba(75, 192, 192, 0.9)'
                    ],
                    hoverBorderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                radius: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = genderTotal > 0 ? ((value / genderTotal) * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label}: ${value} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor[i],
                                            lineWidth: dataset.borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF6384',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                const value = context.parsed;
                                const percentage = genderTotal > 0 ? ((value / genderTotal) * 100).toFixed(1) : 0;
                                return `{% trans "Count" %}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 2000,
                    easing: 'easeInOutQuart'
                },
                elements: {
                    arc: {
                        borderWidth: 3
                    }
                }
            }
        });
    }

    // Rentals Trend Chart - Enhanced Linear Chart
    const trendCtx = document.getElementById('rentalsTrendChart');
    if (trendCtx) {
        const trendData = window.chartData.rentals_trend || [];
        const trendLabels = trendData.map(item => item.period);
        const trendValues = trendData.map(item => item.count);

        window.rentalsTrendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: '{% trans "Rentals" %}',
                    data: trendValues,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: '#667eea',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    borderWidth: 3,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#667eea',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Period" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "Rentals" %}: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Time Period" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Rentals" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });
    }



    // Room Trend Chart - Enhanced Linear Chart
    const roomTrendCtx = document.getElementById('roomTrendChart');
    if (roomTrendCtx && window.chartData.room_rentals_stats && window.chartData.room_rentals_stats.time_periods && window.chartData.room_rentals_stats.time_periods.length > 0) {
        console.log('Creating enhanced roomTrendChart with data:', window.chartData.room_rentals_stats.time_periods);
        const roomTrendData = window.chartData.room_rentals_stats.time_periods;
        const roomTrendLabels = roomTrendData.map(item => item.period);
        const roomTrendValues = roomTrendData.map(item => item.count);

        window.roomTrendChart = new Chart(roomTrendCtx, {
            type: 'line',
            data: {
                labels: roomTrendLabels,
                datasets: [{
                    label: '{% trans "Room Rentals" %}',
                    data: roomTrendValues,
                    borderColor: '#FF9F40',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#FF9F40',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: '#FF9F40',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 3,
                    borderWidth: 3,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#FF9F40',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '{% trans "Period" %}: ' + context[0].label;
                            },
                            label: function(context) {
                                return '{% trans "Room Rentals" %}: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Time Period" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        display: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Room Rentals" %}',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)',
                            drawBorder: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart',
                    delay: (context) => {
                        return context.dataIndex * 100;
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });
    }

    // Update popular rooms list
    if (window.chartData.room_rentals_stats) {
        const popularRoomsDiv = document.getElementById('popularRoomsStats');
        if (popularRoomsDiv) {
            const rooms = window.chartData.room_rentals_stats.popular_rooms;
            if (rooms && rooms.length > 0) {
                popularRoomsDiv.innerHTML = rooms.map(room =>
                    `<div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${room.room}</span>
                        <span class="badge bg-primary">${room.count}</span>
                    </div>`
                ).join('');
            } else {
                popularRoomsDiv.innerHTML = '<p class="text-muted">{% trans "No room rentals found" %}</p>';
            }
        }
    }

    // Reset the flag
    window.initializingCharts = false;
};

// Load filter data
async function loadFilterData() {
    try {
        const response = await fetch('/admin-dashboard/api/filters-data/');
        const data = await response.json();

        console.log('Filter data loaded:', data);

        if (data.success) {
            // Populate categories
            const categorySelect = document.getElementById('category');
            if (categorySelect && data.inventory_categories) {
                data.inventory_categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }

            // Populate owners (organizations)
            const ownerSelect = document.getElementById('owner');
            if (ownerSelect && data.organizations) {
                data.organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    ownerSelect.appendChild(option);
                });
            }

            // Populate locations
            const locationSelect = document.getElementById('location');
            if (locationSelect && data.locations) {
                data.locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    locationSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading filter data:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load filter data first
    loadFilterData();

    // Initialize custom date inputs visibility with delay
    setTimeout(() => {
        toggleInventoryCustomDateInputs();
    }, 100);

    // Load initial data
    loadChartData();

    // Add event listeners for form submission
    const filtersForm = document.getElementById('filtersForm');
    if (filtersForm) {
        filtersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            window.applyInventoryFilters();
        });
    }

    // Add click event listener to Apply Filters button
    const applyButton = document.getElementById('applyFiltersBtn');
    if (applyButton) {
        applyButton.addEventListener('click', function(e) {
            e.preventDefault();
            window.applyInventoryFilters();
        });
    }

    // Add event listeners for filter changes (only for date range to toggle custom inputs)
    const dateRangeSelect = document.getElementById('dateRange');
    if (dateRangeSelect) {
        dateRangeSelect.addEventListener('change', function() {
            toggleInventoryCustomDateInputs();
        });
    }

    // Add click handlers to stat cards
    const statCards = document.querySelectorAll('.stat-card[data-type]');
    statCards.forEach(card => {
        card.style.cursor = 'pointer';
        card.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const title = this.getAttribute('data-title');
            showInventoryDetailModal(type, title);
        });

        // Add hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 12px 20px rgba(0,0,0,0.15)';
            this.style.borderColor = '#667eea';
        });

        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.05)';
            this.style.borderColor = 'rgba(0,0,0,0.05)';
        });
    });
});

// Show inventory detail modal
function showInventoryDetailModal(type, title) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('inventoryDetailModal');
    if (!modal) {
        modal = createInventoryDetailModal();
        document.body.appendChild(modal);
    }

    // Update modal title
    const modalTitle = modal.querySelector('.modal-title');
    modalTitle.textContent = title;

    // Show loading state
    const modalBody = modal.querySelector('.modal-body');
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">{% trans "Loading..." %}</span></div></div>';
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    // Load data
    loadInventoryDetailData(type, modalBody);
}

// Create inventory detail modal
function createInventoryDetailModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'inventoryDetailModal';
    modal.tabIndex = -1;
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Inventory Detail View" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                    <button type="button" class="btn btn-primary" onclick="exportInventoryDetailData()">{% trans "Export CSV" %}</button>
                </div>
            </div>
        </div>
    `;
    return modal;
}

// Load inventory detail data
async function loadInventoryDetailData(type, modalBody, page = 1) {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('type', type);
        urlParams.set('page', page);
        urlParams.set('per_page', 20);

        const response = await fetch(`/admin-dashboard/api/inventory-detail/?${urlParams.toString()}`);
        const data = await response.json();

        if (data.success) {
            displayInventoryDetailData(data.data, modalBody, type, page);
        } else {
            modalBody.innerHTML = `<div class="alert alert-danger">{% trans "Error" %}: ${data.error}</div>`;
        }
    } catch (error) {
        modalBody.innerHTML = `<div class="alert alert-danger">{% trans "Error loading data" %}: ${error.message}</div>`;
    }
}

// Display inventory detail data
function displayInventoryDetailData(data, modalBody, type, currentPage = 1) {
    const { inventory, rentals, total_count, displayed_count, page, per_page, total_pages } = data;

    let html = `
        <div class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <strong>{% trans "Total Records" %}:</strong> ${total_count}
                </div>
                <div class="col-md-4">
                    <strong>{% trans "Displayed" %}:</strong> ${displayed_count}
                </div>
                <div class="col-md-4">
                    <strong>{% trans "Page" %}:</strong> ${currentPage} {% trans "of" %} ${total_pages}
                </div>
            </div>
        </div>
    `;

    if (type.includes('rentals') && rentals && rentals.length > 0) {
        html += `
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="inventoryDetailTable">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "User Name" %}</th>
                            <th>{% trans "User Email" %}</th>
                            <th>{% trans "Inventory Number" %}</th>
                            <th>{% trans "Item Description" %}</th>
                            <th>{% trans "Manufacturer" %}</th>
                            <th>{% trans "Category" %}</th>
                            <th>{% trans "Quantity" %}</th>
                            <th>{% trans "Start Date" %}</th>
                            <th>{% trans "End Date" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th>{% trans "Media Authority" %}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        rentals.forEach(rental => {
            const statusBadge = getRentalStatusBadge(rental.status);
            html += `
                <tr>
                    <td>${rental.user_name}</td>
                    <td>${rental.user_email}</td>
                    <td>${rental.inventory_number}</td>
                    <td>${rental.item_description}</td>
                    <td>${rental.manufacturer}</td>
                    <td>${rental.category}</td>
                    <td>${rental.quantity}</td>
                    <td>${rental.start_date}</td>
                    <td>${rental.end_date}</td>
                    <td>${statusBadge}</td>
                    <td>${rental.media_authority}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;
    } else if (inventory && inventory.length > 0) {
        html += `
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="inventoryDetailTable">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "Inventory Number" %}</th>
                            <th>{% trans "Description" %}</th>
                            <th>{% trans "Manufacturer" %}</th>
                            <th>{% trans "Category" %}</th>
                            <th>{% trans "Owner" %}</th>
                            <th>{% trans "Available" %}</th>
                            <th>{% trans "Condition" %}</th>
                            <th>{% trans "Location" %}</th>
                            <th>{% trans "Created" %}</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        inventory.forEach(item => {
            const availableBadge = item.available_for_rent ? `<span class="badge bg-success">{% trans "Yes" %}</span>` : `<span class="badge bg-danger">{% trans "No" %}</span>`;
            html += `
                <tr>
                    <td>${item.inventory_number}</td>
                    <td>${item.description}</td>
                    <td>${item.manufacturer}</td>
                    <td>${item.category}</td>
                    <td>${item.owner}</td>
                    <td>${availableBadge}</td>
                    <td>${item.condition}</td>
                    <td>${item.location}</td>
                    <td>${item.created_at}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;
    } else {
        html += `<div class="alert alert-info">{% trans "No data found for the selected criteria." %}</div>`;
    }

    // Add pagination controls
    if (total_pages > 1) {
        html += createPaginationControls(currentPage, total_pages, type);
    }

    modalBody.innerHTML = html;
}

// Create pagination controls
function createPaginationControls(currentPage, totalPages, type) {
    let html = `
        <nav aria-label="{% trans "Inventory pagination" %}" class="mt-3">
            <ul class="pagination justify-content-center">
    `;

    // Previous button
    if (currentPage > 1) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadInventoryDetailPage(${currentPage - 1}, '${type}')">{% trans "Previous" %}</a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">{% trans "Previous" %}</span>
            </li>
        `;
    }

    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `
                <li class="page-item active">
                    <span class="page-link">${i}</span>
                </li>
            `;
        } else {
            html += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadInventoryDetailPage(${i}, '${type}')">${i}</a>
                </li>
            `;
        }
    }

    // Next button
    if (currentPage < totalPages) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadInventoryDetailPage(${currentPage + 1}, '${type}')">{% trans "Next" %}</a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">{% trans "Next" %}</span>
            </li>
        `;
    }

    html += `
            </ul>
        </nav>
    `;

    return html;
}

// Load inventory detail page
async function loadInventoryDetailPage(page, type) {
    const modal = document.getElementById('inventoryDetailModal');
    const modalBody = modal.querySelector('.modal-body');

    // Show loading state
    modalBody.innerHTML = `<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">{% trans "Loading..." %}</span></div></div>`;

    // Load data for the new page
    await loadInventoryDetailData(type, modalBody, page);
}

// Get rental status badge HTML
function getRentalStatusBadge(status) {
    switch(status) {
        case 'Approved':
            return `<span class="badge bg-success">{% trans "Approved" %}</span>`;
        case 'Pending':
            return `<span class="badge bg-warning">{% trans "Pending" %}</span>`;
        case 'Rejected':
            return `<span class="badge bg-danger">{% trans "Rejected" %}</span>`;
        case 'Returned':
            return `<span class="badge bg-info">{% trans "Returned" %}</span>`;
        default:
            return `<span class="badge bg-secondary">${status}</span>`;
    }
}

// Export inventory detail data
function exportInventoryDetailData() {
    const table = document.getElementById('inventoryDetailTable');
    if (table) {
        const rows = table.querySelectorAll('tr');
        const csv = window.convertTableToCSV(rows);
        const filename = `inventory_detail_${new Date().toISOString().split('T')[0]}.csv`;
        window.downloadCSV(csv, filename);
    }
}

// Make utility functions globally available
window.convertTableToCSV = function(rows) {
    let csv = '';
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
        csv += rowData + '\n';
    });
    return csv;
};

window.downloadCSV = function(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
};

// Export chart data function
window.exportChartData = function(chartId) {
    const chart = getChartInstance(chartId);
    if (!chart) {
        console.error(`Chart ${chartId} not found`);
        showExportError(`Chart ${chartId} not found`);
        return;
    }

    // Add loading animation to button
    const button = event.target;
    const originalText = button.innerHTML;
    button.classList.add('exporting');
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Exporting..." %}';
    button.disabled = true;

    try {
        const data = chart.data;
        const chartTitle = getChartTitle(chartId);

        exportChartToCSV(data, chartTitle, chartId);

        // Show success message
        showExportSuccess('CSV');

    } catch (error) {
        console.error('Export error:', error);
        showExportError('Export failed: ' + error.message);
    } finally {
        // Reset button
        setTimeout(() => {
            button.classList.remove('exporting');
            button.innerHTML = originalText;
            button.disabled = false;
        }, 1000);
    }
};

// Get chart instance by ID
function getChartInstance(chartId) {
    switch(chartId) {
        case 'inventoryByCategoryChart': return window.inventoryByCategoryChart;
        case 'inventoryByOwnerChart': return window.inventoryByOwnerChart;
        case 'rentalsByStatusChart': return window.rentalsByStatusChart;
        case 'rentalsByTypeChart': return window.rentalsByTypeChart;
        case 'rentalsByGenderChart': return window.rentalsByGenderChart;
        case 'rentalsTrendChart': return window.rentalsTrendChart;
        case 'roomTrendChart': return window.roomTrendChart;
        default: return null;
    }
}

// Get chart title by ID
function getChartTitle(chartId) {
    const titles = {
        'inventoryByCategoryChart': '{% trans "Inventory by Category" %}',
        'inventoryByOwnerChart': '{% trans "Inventory by Owner" %}',
        'rentalsByStatusChart': '{% trans "Rentals by Status" %}',
        'rentalsByTypeChart': '{% trans "Rentals by Type" %}',
        'rentalsByGenderChart': '{% trans "Rentals by Gender" %}',
        'rentalsTrendChart': '{% trans "Rentals Trend" %}',
        'roomTrendChart': '{% trans "Room Rentals Trend" %}'
    };
    return titles[chartId] || '{% trans "Chart Data" %}';
}

// Export chart data to CSV
function exportChartToCSV(data, title, chartId) {
    let csv = `"${title}"\n\n`;

    if (data.datasets.length === 1) {
        // Single dataset (pie, doughnut, single bar)
        csv += `"{% trans "Label" %}","{% trans "Value" %}"\n`;
        data.labels.forEach((label, index) => {
            csv += `"${label}","${data.datasets[0].data[index]}"\n`;
        });
    } else {
        // Multiple datasets (bar charts with multiple series)
        csv += `"{% trans "Label" %}"`;
        data.datasets.forEach(dataset => {
            csv += `,"${dataset.label}"`;
        });
        csv += '\n';

        data.labels.forEach((label, index) => {
            csv += `"${label}"`;
            data.datasets.forEach(dataset => {
                csv += `,"${dataset.data[index] || 0}"`;
            });
            csv += '\n';
        });
    }

    const filename = `${chartId}_${new Date().toISOString().split('T')[0]}.csv`;
    window.downloadCSV(csv, filename);
}

// Show export success notification
function showExportSuccess(format) {
    const notification = createNotification(`{% trans "Data exported successfully as" %} ${format}`, 'success');
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Show export error notification
function showExportError(message) {
    const notification = createNotification(message, 'error');
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Create notification element
function createNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideInRight 0.3s ease-out;
    `;

    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans "Close" %}"></button>
    `;

    return notification;
}
</script>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.15s ease-in-out;
}

/* Room charts height limit */
#roomTrendChart {
    max-height: 200px !important;
    height: 200px !important;
}

/* Export buttons styling */
.btn-group .btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.btn-group .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-group .btn:active {
    transform: translateY(0);
}

.btn-group .btn i {
    margin-right: 4px;
}

/* Export button animations */
@keyframes exportPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.btn-group .btn.exporting {
    animation: exportPulse 0.6s ease-in-out;
}

/* Notification animations */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Responsive export buttons */
@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }

    .btn-group .btn {
        margin-bottom: 2px;
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}
