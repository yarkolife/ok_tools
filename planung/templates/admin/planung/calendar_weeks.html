{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'planung/css/calendar_weeks.css' %}">
{% endblock %}

{% block content %}

<!-- Weekly Statistics -->
<div class="stats-container">
  <div class="card border-primary">
    <div class="card-header bg-primary text-white">
      <h6 class="mb-0">{% trans "Current Week" %} (KW {{ current_week }})</h6>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Planned days" %}:</span>
        <strong id="currentWeekPlanned">0</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Total time" %}:</span>
        <strong id="currentWeekTime">0/735 min</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Fill rate" %}:</span>
        <strong id="currentWeekFill">0%</strong>
      </div>
      <div class="d-flex justify-content-between">
        <span>{% trans "Licenses" %}:</span>
        <strong id="currentWeekFreistellungen">0</strong>
      </div>
    </div>
  </div>

  <div class="card border-info">
    <div class="card-header bg-info text-white">
      <h6 class="mb-0">{% trans "Next Week" %} (KW {{ current_week|add:1 }})</h6>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Planned days" %}:</span>
        <strong id="nextWeekPlanned">0</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Total time" %}:</span>
        <strong id="nextWeekTime">0/735 min</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Fill rate" %}:</span>
        <strong id="nextWeekFill">0%</strong>
      </div>
      <div class="d-flex justify-content-between">
        <span>{% trans "Freistellungen" %}:</span>
        <strong id="nextWeekFreistellungen">0</strong>
      </div>
    </div>
  </div>

  <div class="card border-warning">
    <div class="card-header bg-warning text-white">
      <h6 class="mb-0">{% trans "Week After Next" %} (KW {{ current_week|add:2 }})</h6>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Planned days" %}:</span>
        <strong id="afterNextWeekPlanned">0</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Total time" %}:</span>
        <strong id="afterNextWeekTime">0/735 min</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Fill rate" %}:</span>
        <strong id="afterNextWeekFill">0%</strong>
      </div>
      <div class="d-flex justify-content-between">
        <span>{% trans "Freistellungen" %}:</span>
        <strong id="afterNextWeekFreistellungen">0</strong>
      </div>
    </div>
  </div>

  <div class="card border-secondary">
    <div class="card-header bg-secondary text-white">
      <h6 class="mb-0">{% trans "3 Weeks Ahead" %} (KW {{ current_week|add:3 }})</h6>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Planned days" %}:</span>
        <strong id="threeWeeksAheadPlanned">0</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Total time" %}:</span>
        <strong id="threeWeeksAheadTime">0/735 min</strong>
      </div>
      <div class="d-flex justify-content-between mb-2">
        <span>{% trans "Fill rate" %}:</span>
        <strong id="threeWeeksAheadFill">0%</strong>
      </div>
      <div class="d-flex justify-content-between">
        <span>{% trans "Freistellungen" %}:</span>
        <strong id="threeWeeksAheadFreistellungen">0</strong>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-bordered text-center">
    <thead>
      <tr>
        <th></th>
        {% for name in weekday_names %}
          <th style="font-size:16px;">{{ name }}</th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for week in weeks %}
      <tr class="{% if week.num == current_week %}current-week{% endif %}">
          <td class="kw-cell">{% trans "KW" %} {{ week.num }}</td>

          {% for cell in week.days %}
            <td class="{{ cell.cls }}">
              <button class="btn btn-sm btn-outline-primary date-cell"
                      data-date="{{ cell.iso }}">
                {{ cell.date|date:"d.m" }}
                {% if cell.icon %}<span class="icon">{{ cell.icon }}</span>{% endif %}
              </button>
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Bootstrap 3 compatible modal window -->
<div id="dayPlanModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="dayPlanLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="dayPlanLabel">
          <span id="modalDateDisplay"></span> – <span id="modalWeekday"></span>
        </h5>
        <button type="button" class="btn-close-custom" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}">&times;</button>
      </div>

      <div class="modal-body">
        <div class="time-status text-success" id="timeStatus">
          <strong>{% trans "Broadcast block" %}:</strong> {{ broadcast_start }} – {{ broadcast_end }} (<span id="blockDurationDisplay"></span>) •
          <span id="remainingTime">{% trans "Full available" %}</span>
          <br><small>{% trans "Large gaps (≥5 min) can be filled with videos" %}</small>
        </div>

        <div class="d-flex gap-2 mb-3">
          <input type="number" id="licenseNumberInput" class="form-control" placeholder="{% trans 'Enter license number...' %}" style="width: 270px;">
          <button id="addLicenseBtn" class="btn btn-primary">{% trans "Add" %}</button>
        </div>

        <table class="table table-bordered table-condensed" id="licenseTable">
          <thead>
            <tr>
              <th>{% trans "Start" %}</th>
              <th>{% trans "End" %}</th>
              <th>{% trans "Number" %}</th>
              <th>{% trans "Title" %}</th>
              <th>{% trans "Author" %}</th>
              <th>{% trans "Duration" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will insert rows here -->
          </tbody>
        </table>

        <div class="form-group">
          <label for="noteText">{% trans "Comment or notes:" %}</label>
          <textarea id="noteText" class="form-control" rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button id="sortByTimeBtn" class="btn btn-secondary me-2" type="button" title="{% trans 'Sort by time' %}">⏱️ {% trans 'Sort by time' %}</button>
        <button class="btn btn-danger">{% trans "Delete" %}</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
        <button id="savePlanBtn" class="btn btn-primary">{% trans "Save" %}</button>
        <button id="planPlanBtn" class="btn btn-success">{% trans "Plan!" %}</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block footer %}
  {{ block.super }}

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <script src="{% url 'javascript-catalog' %}"></script>

  <script>
    const CURRENT_WEEK = parseInt('{{ current_week }}', 10);
    const BROADCAST_START = "{{ broadcast_start }}";
    const BROADCAST_END = "{{ broadcast_end }}";
  </script>
  <script src="{% static 'planung/js/calendar_weeks.js' %}"></script>



{% endblock %}
