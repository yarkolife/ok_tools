{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <link rel="apple-touch-icon" href="{% static 'img/favicon.ico' %}">
    <title>{% trans "Rental Statistics" %} - OK Tools</title>
    <link href="{% static 'admin/css/base.css' %}" rel="stylesheet">
    <link href="{% static 'rental/css/admin_rental.css' %}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-number { font-size: 3rem; font-weight: bold; }
        .danger-zone {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 15px;
        }
        .table-container { max-height: 500px; overflow-y: auto; }
        .status-reserved { background: #17a2b8; color: white; }
        .status-issued { background: #28a745; color: white; }
        .status-returned { background: #6c757d; color: white; }
        .status-cancelled { background: #dc3545; color: white; }
        .inventory-rented { background: #ffc107; color: #212529; }
        .inventory-reserved { background: #17a2b8; color: white; }
        .inventory-available { background: #28a745; color: white; }
        .return-ontime { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .return-overdue { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .return-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .return-active { background: #cce5ff; color: #004085; border: 1px solid #99d3ff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #417690 !important;">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="{% url 'rental:admin_rental_process' %}">
                <i class="fas fa-arrow-left me-2"></i>{% trans "Back to Rental Process" %}
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-white" href="{% url 'admin:index' %}">
                    <i class="fas fa-cog me-1"></i>{% trans "Administration" %}
                </a>
                <span class="navbar-text text-white">
                    <i class="fas fa-chart-bar me-2"></i>{% trans "Rental Statistics & Administration" %}
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        {% if error %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            </div>
        {% else %}
            <!-- Overview Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ total_rentals }}</div>
                        <div><i class="fas fa-clipboard-list me-2"></i>{% trans "Total Rentals" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ active_rentals }}</div>
                        <div><i class="fas fa-clock me-2"></i>{% trans "Active Rentals" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ total_users }}</div>
                        <div><i class="fas fa-users me-2"></i>{% trans "Users with Rentals" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card p-4 text-center">
                        <div class="stats-number">{{ total_items }}</div>
                        <div><i class="fas fa-boxes me-2"></i>{% trans "Available Items" %}</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="nav-tabs-container">
                <ul class="nav nav-tabs" id="statsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="rentals-tab" data-bs-toggle="tab" data-bs-target="#rentals" type="button">
                            <i class="fas fa-list"></i>
                            <span>{% trans "All Rentals" %}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button">
                            <i class="fas fa-boxes"></i>
                            <span>{% trans "Inventory Status" %}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sets-tab" data-bs-toggle="tab" data-bs-target="#sets" type="button">
                            <i class="fas fa-layer-group"></i>
                            <span>{% trans "Equipment Sets" %}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button">
                            <i class="fas fa-cogs"></i>
                            <span>{% trans "Administration" %}</span>
                        </button>
                    </li>
                </ul>
            </div>

            <div class="tab-content" id="statsTabContent">
                <!-- Rentals Tab -->
                <div class="tab-pane fade show active" id="rentals" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>{% trans "All Rentals" %}</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" id="statusFilter">
                                                <option value="all">{% trans "All Status" %}</option>
                                                <option value="reserved">{% trans "Reserved" %}</option>
                                                <option value="issued">{% trans "Issued" %}</option>
                                                <option value="returned">{% trans "Returned" %}</option>
                                                <option value="cancelled">{% trans "Cancelled" %}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select form-select-sm" id="typeFilter">
                                                <option value="all">{% trans "All Types" %}</option>
                                                <option value="equipment">{% trans "Equipment" %}</option>
                                                <option value="room">{% trans "Rooms" %}</option>
                                                <option value="mixed">{% trans "Mixed" %}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="text" class="form-control form-control-sm" id="userFilter" placeholder="{% trans 'Search user...' %}">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-warning btn-sm w-100" id="expireRoomsBtn" title="{% trans 'Automatic expiration of room reservations and rentals' %}">
                                                <i class="fas fa-sync-alt me-1"></i>{% trans "Expire Rooms" %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover rentals-table">
                                    <thead>
                                        <tr>
                                            <th class="col-id">ID</th>
                                            <th class="col-project">{% trans "Project" %}</th>
                                            <th class="col-user">{% trans "User" %}</th>
                                            <th class="col-status">{% trans "Status" %}</th>
                                            <th class="col-created">{% trans "Created" %}</th>
                                            <th class="col-period">{% trans "Period" %}</th>
                                            <th class="col-return">{% trans "Return" %}</th>
                                            <th class="col-items">{% trans "Items/Rooms" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rentalsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center">
                                                <div class="spinner-border spinner-border-sm me-2"></div>{% trans 'Loading data...' %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div id="rentalsInfo">Lade...</div>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0" id="rentalsPagination"></ul>
                                </nav>
                            </div>

                            <!-- Room Expiration Result -->
                            <div id="expireRoomsResult" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div class="tab-pane fade" id="inventory" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>{% trans "Inventory Status" %}</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <select class="form-select form-select-sm" id="ownerFilter">
                                                <option value="all">{% trans "All Owners" %}</option>
                                                <option value="MSA">MSA</option>
                                                <option value="OKMQ">OKMQ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <select class="form-select form-select-sm" id="inventoryStatusFilter">
                                                <option value="all">{% trans "All Status" %}</option>
                                                <option value="available">{% trans "Available" %}</option>
                                                <option value="reserved">{% trans "Reserved" %}</option>
                                                <option value="rented">{% trans "Rented" %}</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>{% trans "Inventory No." %}</th>
                                            <th>{% trans "Description" %}</th>
                                            <th>{% trans "Owner" %}</th>
                                            <th>{% trans "Location" %}</th>
                                            <th>{% trans "Category" %}</th>
                                            <th>{% trans "Reserved" %}</th>
                                            <th>{% trans "Rented" %}</th>
                                            <th>{% trans "Status" %}</th>
                                            <th>{% trans "Calendar" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center">
                                                <div class="spinner-border spinner-border-sm me-2"></div>{% trans 'Loading data...' %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <div id="inventoryInfo">Lade...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Equipment Sets Tab -->
                <div class="tab-pane fade" id="sets" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>{% trans "Equipment Sets" %}</h5>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <button class="btn btn-primary btn-sm" id="createSetBtn">
                                                <i class="fas fa-plus me-1"></i>{% trans "Create New Set" %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-container">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>{% trans "Name" %}</th>
                                                    <th>{% trans "Description" %}</th>
                                                    <th>{% trans "Items" %}</th>
                                                    <th>{% trans "Status" %}</th>
                                                    <th>{% trans "Created" %}</th>
                                                    <th>{% trans "Actions" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody id="setsTableBody">
                                                <tr>
                                                    <td colspan="6" class="text-center">
                                                        <div class="spinner-border spinner-border-sm me-2"></div>{% trans 'Loading sets...' %}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>{% trans "Set Details" %}</h6>
                                </div>
                                <div class="card-body" id="setDetailsPanel">
                                    <p class="text-muted text-center">{% trans 'Select a set to see details' %}</p>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>

                <!-- Administration Tab -->
                <div class="tab-pane fade" id="admin" role="tabpanel">
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>{% trans "Information" %}</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3">{% trans "These administration functions allow you to reset or clean up the entire rental system." %}</p>

                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>{% trans "Warning" %}:</strong> {% trans "These actions cannot be undone. Make sure you have a backup." %}
                                    </div>

                                    <h6>{% trans "Available Actions" %}:</h6>
                                    <ul>
                                        <li><strong>{% trans "Reset Inventory Quantities" %}:</strong> {% trans "Sets all reserved_quantity and rented_quantity to 0" %}</li>
                                        <li><strong>{% trans "Cancel Active Rentals" %}:</strong> {% trans "Cancels all active rentals and resets inventory quantities" %}</li>
                                        <li><strong>{% trans "Delete All Data" %}:</strong> {% trans "Deletes ALL rental data and resets inventory" %}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="danger-zone p-4">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Danger Zone" %}</h5>

                                <div class="mb-3">
                                    <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="resetAction('reset_inventory_quantities')">
                                        <i class="fas fa-undo me-2"></i>{% trans "Reset Inventory Quantities" %}
                                    </button>

                                    <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="resetAction('cancel_active_rentals')">
                                        <i class="fas fa-ban me-2"></i>{% trans "Cancel Active Rentals" %}
                                    </button>

                                    <button class="btn btn-light btn-sm w-100" onclick="resetAction('reset_all')">
                                        <i class="fas fa-trash me-2"></i>{% trans "Delete All Data" %}
                                    </button>
                                </div>

                                <small>{% trans "Confirmation code required" %}: <code>RESET_ALL_DATA</code></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Inventory Schedule Modal -->
    <div class="modal fade" id="inventoryScheduleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-calendar me-2"></i>{% trans "Inventory schedule" %}: <span id="invScheduleTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">{% trans "From" %}</label>
                            <input type="date" class="form-control" id="invCalStart">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">{% trans "To" %}</label>
                            <input type="date" class="form-control" id="invCalEnd">
                        </div>
                    </div>
                    <div id="invCalendarContainer" class="border rounded p-3" style="min-height: 500px;">
                        <div class="text-center p-5">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2">{% trans 'Loading calendar...' %}</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Set Modal -->
    <div class="modal fade" id="setModal" tabindex="-1" aria-labelledby="setModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setModalLabel">
                        <i class="fas fa-layer-group me-2"></i>{% trans "Create Equipment Set" %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="setForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="setName" class="form-label">{% trans "Name" %} *</label>
                                    <input type="text" class="form-control" id="setName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="setDescription" class="form-label">{% trans "Description" %}</label>
                                    <textarea class="form-control" id="setDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="setIsActive" checked>
                                        <label class="form-check-label" for="setIsActive">
                                            {% trans "Active" %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>{% trans "Add Items" %}:</h6>
                                <div class="mb-3">
                                    <input type="text" class="form-control form-control-sm" id="itemSearch" placeholder="{% trans 'Search items...' %}">
                                </div>
                                <div class="border rounded p-2 mb-3" style="height: 200px; overflow-y: auto;" id="searchResults">
                                    <small class="text-muted">{% trans 'Enter a search term...' %}</small>
                                </div>
                            </div>
                        </div>

                        <h6>{% trans "Set Contents" %}:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>{% trans "Item" %}</th>
                                        <th>{% trans "Quantity" %}</th>
                                        <th>{% trans "Action" %}</th>
                                    </tr>
                                </thead>
                                <tbody id="setItemsList">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">{% trans 'No items added' %}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-primary" id="saveSetBtn">{% trans "Save Set" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>{% trans "Confirmation Required" %}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage"></p>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Enter" %} <code>RESET_ALL_DATA</code> {% trans "to continue" %}:</label>
                        <input type="text" class="form-control" id="confirmationCode" placeholder="RESET_ALL_DATA">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-danger" id="confirmResetBtn">{% trans "Confirm" %}</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript translations -->
    <script src="{% url 'javascript-catalog' %}"></script>

    <script>
        const URLS = {
            resetSystem: "{% url 'rental:api_reset_rental_system' %}",
            getAllRentals: "{% url 'rental:api_get_all_rentals' %}",
            getInventoryStatus: "{% url 'rental:api_get_all_inventory_status' %}",
            getAllSets: "{% url 'rental:api_get_all_equipment_sets' %}",
            createSet: "{% url 'rental:api_create_equipment_set' %}",
            deleteSet: "{% url 'rental:api_delete_equipment_set' pk=0 %}".replace('0', '{setId}'),
            searchInventory: "{% url 'rental:api_search_inventory' %}",
            inventorySchedule: "{% url 'rental:api_inventory_schedule' %}",
        };
        const CSRF_TOKEN = "{{ csrf_token }}";
    </script>
    <script src="{% static 'rental/js/rental_stats.js' %}"></script>
</body>
</html>
