{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Video Player - {{ video.filename }}</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <style>
        body { margin: 0; padding: 20px; background: #f5f5f5; font-family: Arial, sans-serif; }
        .video-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .video-info { margin-bottom: 20px; }
        .video-info h1 { color: #333; margin: 0 0 10px 0; }
        .video-info p { color: #666; margin: 5px 0; }
        .plyr { width: 100%; height: auto; max-height: 600px; }
        .loading { text-align: center; padding: 50px; color: #666; }
        .error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .loading-progress { background: #f0f0f0; border-radius: 4px; padding: 10px; margin: 10px 0; }
        .progress-bar { background: #2196F3; height: 20px; border-radius: 4px; transition: width 0.3s; }
        .progress-text { text-align: center; margin-top: 5px; color: #666; }
    </style>
</head>
<body>
    <div class="video-container">
        <div class="video-info">
            <h1>{{ video.filename }}</h1>
            <p><strong>–ù–æ–º–µ—Ä:</strong> {{ video.number }}</p>
            <p><strong>–•—Ä–∞–Ω–∏–ª–∏—â–µ:</strong> {{ video.storage_location.name }}</p>
            {% if video.duration %}<p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{ video.duration }}</p>{% endif %}
            {% if video.file_size %}<p><strong>–†–∞–∑–º–µ—Ä:</strong> {{ video.file_size|filesizeformat }}</p>{% endif %}
            {% if video.total_bitrate %}<p><strong>–ë–∏—Ç—Ä–µ–π—Ç:</strong> {{ video.total_bitrate }} bps</p>{% endif %}
        </div>

        {% if video.is_available %}
            <video
                id="plyr-player"
                controls
                preload="auto">
                <source src="{% url 'admin:media_files_videofile_stream' video.id %}" type="video/{{ video.format|default:'mp4' }}">
                <p>–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ –≤–∫–ª—é—á–∏—Ç–µ JavaScript –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 
                    <a href="{% url 'admin:media_files_videofile_stream' video.id %}" download>—Å–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ</a>
                </p>
            </video>
            
            <div id="loading-progress" class="loading-progress" style="display: none;">
                <div class="progress-bar" style="width: 0%"></div>
                <div class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>
            </div>
            
            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff;">
                <div style="font-size: 13px; color: #333; margin-bottom: 5px;">
                    <strong>üìÅ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (Linux):</strong>
                </div>
                <code style="display: block; padding: 10px; background: white; border-radius: 3px; word-break: break-all; font-size: 12px; color: #495057; border: 1px solid #dee2e6;">{{ video.full_path }}</code>
                
                {% if video.unc_path %}
                <div style="font-size: 13px; color: #333; margin-top: 10px; margin-bottom: 5px;">
                    <strong>üíæ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (Windows UNC):</strong>
                </div>
                <code style="display: block; padding: 10px; background: white; border-radius: 3px; word-break: break-all; font-size: 12px; color: #495057; border: 1px solid #dee2e6;">{{ video.unc_path }}</code>
                {% endif %}
            </div>
        {% else %}
            <div class="error">
                ‚ùå –í–∏–¥–µ–æ—Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å: {{ video.file_path }}
            </div>
        {% endif %}
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Plyr –ø–ª–µ–µ—Ä–∞
        const player = new Plyr('#plyr-player', {
            controls: [
                'play-large', 'restart', 'rewind', 'play', 'fast-forward', 'progress',
                'current-time', 'duration', 'mute', 'volume', 'settings', 'fullscreen'
            ],
            settings: ['quality', 'speed'],
            speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2] },
            quality: { default: 720, options: [1080, 720, 480, 360] }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        player.on('error', function(event) {
            console.error('Video error:', event.detail);
            
            document.querySelector('.video-container').innerHTML = 
                '<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ. ' +
                '<a href="{% url "admin:media_files_videofile_stream" video.id %}" download>–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a></div>';
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
        var progressDiv = document.getElementById('loading-progress');
        var progressBar = progressDiv.querySelector('.progress-bar');
        var progressText = progressDiv.querySelector('.progress-text');
        
        player.on('loadstart', function() {
            console.log('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...');
            progressDiv.style.display = 'block';
            progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...';
        });

        player.on('progress', function() {
            var buffered = player.buffered;
            var duration = player.duration;
            if (duration > 0) {
                var bufferedEnd = buffered.length > 0 ? buffered.end(buffered.length - 1) : 0;
                var percent = Math.round((bufferedEnd / duration) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ... ' + percent + '%';
            }
        });

        player.on('canplay', function() {
            console.log('–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é');
            progressDiv.style.display = 'none';
        });

        player.on('ready', function() {
            console.log('Plyr player ready');
        });

        player.on('waiting', function() {
            console.log('–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è...');
            progressDiv.style.display = 'block';
            progressText.textContent = '–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è...';
        });

        player.on('canplaythrough', function() {
            console.log('–í–∏–¥–µ–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
            progressDiv.style.display = 'none';
        });
    </script>
</body>
</html>
