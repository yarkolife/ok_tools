{% extends "dashboard/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">

                <!-- Filters Section -->
                <div class="filter-section">
                    <form id="filtersForm" method="GET">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label">{% trans "Date Range" %}</label>
                                <select class="form-select" id="dateRange" name="days">
                                <option value="7">{% trans "Last 7 days" %}</option>
                                <option value="30">{% trans "Last 30 days" %}</option>
                                <option value="90">{% trans "Last 90 days" %}</option>
                                <option value="365">{% trans "Last year" %}</option>
                                <option value="all">{% trans "All Time" %}</option>
                                <option value="custom">{% trans "Custom Period" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="customStartDate" class="form-label">{% trans "Start Date" %}</label>
                                <input type="date" class="form-control" id="customStartDate" name="start_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="customEndDate" class="form-label">{% trans "End Date" %}</label>
                                <input type="date" class="form-control" id="customEndDate" name="end_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="mediaAuthority" class="form-label">{% trans "Media Authority" %}</label>
                                <select class="form-select" id="mediaAuthority" name="media_authority">
                                <option value="">{% trans "All Authorities" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="genderFilter" class="form-label">{% trans "Gender" %}</label>
                                <select class="form-select" id="genderFilter" name="gender">
                                <option value="">{% trans "All Genders" %}</option>
                                <option value="m">{% trans "Male" %}</option>
                                <option value="f">{% trans "Female" %}</option>
                                <option value="d">{% trans "Diverse" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="ageGroupFilter" class="form-label">{% trans "Age Group" %}</label>
                                <select class="form-select" id="ageGroupFilter" name="age_group">
                                <option value="">{% trans "All Ages" %}</option>
                                <option value="under_18">{% trans "Under 18" %}</option>
                                <option value="18_25">{% trans "18-25" %}</option>
                                <option value="26_35">{% trans "26-35" %}</option>
                                <option value="36_50">{% trans "36-50" %}</option>
                                <option value="over_50">{% trans "Over 50" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="memberFilter" class="form-label">{% trans "Member Status" %}</label>
                                <select class="form-select" id="memberFilter" name="member">
                                <option value="">{% trans "All Users" %}</option>
                                <option value="true">{% trans "Members Only" %}</option>
                                <option value="false">{% trans "Non-Members Only" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="verifiedFilter" class="form-label">{% trans "Verification" %}</label>
                                <select class="form-select" id="verifiedFilter" name="verified">
                                <option value="">{% trans "All Users" %}</option>
                                <option value="true">{% trans "Verified Only" %}</option>
                                <option value="false">{% trans "Not Verified" %}</option>
                            </select>
                        </div>
                    </div>
                        <div class="row mt-3">
                        <div class="col-12">
                                <button type="submit" class="btn btn-primary">{% trans "Apply Filters" %}</button>
                                <button type="button" class="btn btn-secondary" onclick="resetFilters()">{% trans "Reset" %}</button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Chart data will be loaded via AJAX -->

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">{{ widget_data.basic_stats.total_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Total Users" %}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-number" id="maleUsers">{{ widget_data.basic_stats.male_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Male" %}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-number" id="femaleUsers">{{ widget_data.basic_stats.female_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Female" %}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-number" id="verifiedUsers">{{ widget_data.basic_stats.verified_users|default:"0" }}</div>
                        <div class="stat-label">{% trans "Verified" %}</div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-number" id="memberUsers">{{ widget_data.basic_stats.member_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "Members" %}</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-number" id="newUsers">{{ widget_data.basic_stats.new_users|default:"0" }}</div>
                            <div class="stat-label">{% trans "New Users" %}</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Users by Media Authority" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('authorityChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="authorityChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Age Distribution" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('ageChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="ageChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Gender Distribution" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('genderChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="genderChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Member vs Non-Member" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('memberChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="memberChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Registration Trend -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Registration Trend" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportChartData('trendChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Users by Media Authority" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportTableData('authorityTable')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="authorityTable">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Media Authority" %}</th>
                                            <th>{% trans "User Count" %}</th>
                                            <th>{% trans "Percentage" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if widget_data.users_by_authority %}
                                            {% for item in widget_data.users_by_authority %}
                                            <tr>
                                                <td>{{ item.media_authority__name|default:"Unknown" }}</td>
                                                <td>{{ item.count }}</td>
                                                <td>{% widthratio item.count widget_data.basic_stats.total_users 100 %}%</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">{% trans "No data available" %}</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title">{% trans "Age Group Breakdown" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" @click="exportTableData('ageTable')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="ageTable">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Age Group" %}</th>
                                            <th>{% trans "User Count" %}</th>
                                            <th>{% trans "Percentage" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>{% trans "Under 18" %}</td>
                                            <td>{{ widget_data.age_groups.under_18|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.under_18 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.under_18 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "18-25" %}</td>
                                            <td>{{ widget_data.age_groups.18_25|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.18_25 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.18_25 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "26-35" %}</td>
                                            <td>{{ widget_data.age_groups.26_35|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.26_35 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.26_35 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "36-50" %}</td>
                                            <td>{{ widget_data.age_groups.36_50|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.36_50 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.36_50 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                        <tr>
                                            <td>{% trans "Over 50" %}</td>
                                            <td>{{ widget_data.age_groups.over_50|default:"0" }}</td>
                                            <td>{% if widget_data.age_groups.over_50 and widget_data.basic_stats.total_users %}{% widthratio widget_data.age_groups.over_50 widget_data.basic_stats.total_users 100 %}%{% else %}0%{% endif %}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<script>
// Chart instances - make them globally available
window.authorityChart = null;
window.ageChart = null;
window.genderChart = null;
window.memberChart = null;
window.trendChart = null;

// Initialize chart data with empty values
window.chartData = {
    usersByAuthority: [],
    ageGroups: {},
    basicStats: {},
    memberDistribution: {},
    registrationTrend: []
};

// Load filter data via AJAX
async function loadFilterData() {
            try {
                const response = await fetch('/admin-dashboard/api/filters-data/');
                const data = await response.json();
        
        if (data.success && data.data && data.data.context) {
            console.log('Filter data loaded:', data.data.context);
            
            // Populate Media Authority options
            const mediaAuthoritySelect = document.getElementById('mediaAuthority');
            if (mediaAuthoritySelect && data.data.context.media_authorities) {
                // Clear existing options except first one
                while (mediaAuthoritySelect.children.length > 1) {
                    mediaAuthoritySelect.removeChild(mediaAuthoritySelect.lastChild);
                }
                
                data.data.context.media_authorities.forEach(authority => {
                    const option = document.createElement('option');
                    option.value = authority.name;
                    option.textContent = authority.name;
                    mediaAuthoritySelect.appendChild(option);
                });
                
                console.log(`Loaded ${data.data.context.media_authorities.length} media authorities`);
            }
        } else {
            console.error('Failed to load filter data:', data);
        }
    } catch (error) {
        console.error('Error loading filter data:', error);
    }
}

// Load chart data via AJAX
async function loadChartData() {
    try {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const response = await fetch(`/admin-dashboard/api/users-statistics/?${urlParams.toString()}`);
                const data = await response.json();
                
        if (data.success && data.data) {
            console.log('API response data:', data.data);
            console.log('basic_stats type:', typeof data.data.basic_stats);
            console.log('basic_stats value:', data.data.basic_stats);
            console.log('registration_trend:', data.data.registration_trend);
            
            window.chartData = {
                usersByAuthority: data.data.users_by_authority || [],
                ageGroups: data.data.age_groups || {},
                basicStats: data.data.basic_stats || {},
                memberDistribution: data.data.member_distribution || {},
                registrationTrend: data.data.registration_trend || []
            };
            
            // Update statistics cards if they exist
            if (data.data.basic_stats && typeof data.data.basic_stats === 'object') {
                console.log('Updating statistics cards with:', data.data.basic_stats);
                console.log('window.updateStatisticsCards type:', typeof window.updateStatisticsCards);
                if (typeof window.updateStatisticsCards === 'function') {
                    // Pass the entire data object, not just basic_stats
                    window.updateStatisticsCards(data.data);
                } else {
                    console.error('window.updateStatisticsCards is not a function!');
                }
            } else {
                console.warn('basic_stats not found or invalid in API response:', data.data.basic_stats);
            }
            
            console.log('Chart data loaded successfully:', window.chartData);
        } else {
            console.error('API returned error or no data:', data);
            window.chartData = {
                usersByAuthority: [],
                ageGroups: {},
                basicStats: {},
                memberDistribution: {},
                registrationTrend: []
            };
        }
    } catch (error) {
        console.error('Error loading chart data:', error);
        window.chartData = {
            usersByAuthority: [],
            ageGroups: {},
            basicStats: {},
            memberDistribution: {},
            registrationTrend: []
        };
    }
}

// Update statistics cards - removed duplicate definition

// Simple filter management without Alpine.js
document.addEventListener('DOMContentLoaded', function() {
    // Initialize filters from URL
    initializeFiltersFromURL();
    
    // Load filter data
    loadFilterData();
    
    // Add event listeners for form submission
    const filtersForm = document.getElementById('filtersForm');
    if (filtersForm) {
        filtersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
    }
    
    // Add event listener for date range change
    const dateRangeSelect = document.getElementById('dateRange');
    if (dateRangeSelect) {
        dateRangeSelect.addEventListener('change', function() {
            toggleCustomDateInputs();
        });
    }
    
    // Initialize custom date inputs visibility
    toggleCustomDateInputs();
    
    // Load chart data and initialize charts
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error during initialization:', error);
        // Initialize charts with empty data if loading fails
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
});

function initializeFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days');
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');
    
    if (days) {
        const dateRangeSelect = document.getElementById('dateRange');
        if (dateRangeSelect) {
            dateRangeSelect.value = days;
        }
        
        if (days === 'custom' && startDate && endDate) {
            const startInput = document.getElementById('customStartDate');
            const endInput = document.getElementById('customEndDate');
            if (startInput) startInput.value = startDate;
            if (endInput) endInput.value = endDate;
        }
    }
    
    // Set other filter values from URL
    const filters = ['media_authority', 'gender', 'age_group', 'member', 'verified'];
    filters.forEach(filter => {
        const value = urlParams.get(filter);
        if (value) {
            const element = document.getElementById(filter === 'media_authority' ? 'mediaAuthority' : filter + 'Filter');
            if (element) {
                element.value = value;
            }
        }
    });
}

function toggleCustomDateInputs() {
    const dateRange = document.getElementById('dateRange').value;
    const startDateInput = document.getElementById('customStartDate');
    const endDateInput = document.getElementById('customEndDate');
    
    if (dateRange === 'custom') {
        startDateInput.style.display = 'block';
        endDateInput.style.display = 'block';
    } else {
        startDateInput.style.display = 'none';
        endDateInput.style.display = 'none';
    }
}

function applyFilters() {
    const form = document.getElementById('filtersForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    // Add form data to params
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Update URL without reloading page
    window.history.pushState({}, '', window.location.pathname + '?' + params.toString());
    
    // Reload chart data and reinitialize charts
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
}

function resetFilters() {
    // Clear form
    const form = document.getElementById('filtersForm');
    form.reset();
    
    // Update URL
    window.history.pushState({}, '', window.location.pathname);
    
    // Reload chart data and reinitialize charts
    loadChartData().then(function() {
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
}

// Make initializeCharts globally available
window.initializeCharts = function() {
    // Check if chartData is available
    if (!window.chartData) {
        console.warn('Chart data not available, initializing with empty data');
        window.chartData = {
            usersByAuthority: [],
            ageGroups: {},
            basicStats: {},
            memberDistribution: {},
            registrationTrend: []
        };
    }
    
    // Destroy existing charts if they exist
    if (window.authorityChart) window.authorityChart.destroy();
    if (window.ageChart) window.ageChart.destroy();
    if (window.genderChart) window.genderChart.destroy();
    if (window.memberChart) window.memberChart.destroy();
    if (window.trendChart) window.trendChart.destroy();
    
    // Authority Chart
    const authorityCtx = document.getElementById('authorityChart');
    if (authorityCtx) {
        window.authorityChart = new Chart(authorityCtx, {
            type: 'doughnut',
            data: {
                labels: window.chartData.usersByAuthority.map(item => item.media_authority__name || 'Unknown'),
            datasets: [{
                    data: window.chartData.usersByAuthority.map(item => item.count),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Age Chart
    const ageCtx = document.getElementById('ageChart');
    if (ageCtx) {
        window.ageChart = new Chart(ageCtx, {
            type: 'bar',
            data: {
                labels: ['Under 18', '18-25', '26-35', '36-50', 'Over 50'],
                datasets: [{
                    label: 'Users',
                    data: [
                    window.chartData.ageGroups.under_18 || 0,
                    window.chartData.ageGroups['18_25'] || 0,
                    window.chartData.ageGroups['26_35'] || 0,
                    window.chartData.ageGroups['36_50'] || 0,
                    window.chartData.ageGroups.over_50 || 0
                    ],
                    backgroundColor: '#36A2EB'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Gender Chart
    const genderCtx = document.getElementById('genderChart');
    if (genderCtx) {
        window.genderChart = new Chart(genderCtx, {
            type: 'pie',
            data: {
                labels: ['Male', 'Female', 'Diverse'],
                datasets: [{
                                    data: [
                        window.chartData.basicStats.male_users || 0,
                        window.chartData.basicStats.female_users || 0,
                        window.chartData.basicStats.diverse_users || 0
                ],
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Member Chart
    const memberCtx = document.getElementById('memberChart');
    if (memberCtx) {
        window.memberChart = new Chart(memberCtx, {
            type: 'doughnut',
            data: {
                labels: ['Members', 'Non-Members'],
                datasets: [{
                                    data: [
                        window.chartData.memberDistribution.members || 0,
                        window.chartData.memberDistribution.non_members || 0
                ],
                    backgroundColor: ['#4BC0C0', '#9966FF']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Trend Chart
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        console.log('Creating trend chart with data:', window.chartData.registrationTrend);
        
        // Ensure registrationTrend is an array
        const trendData = Array.isArray(window.chartData.registrationTrend) ? window.chartData.registrationTrend : [];
        
        window.trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.map(item => item.date || ''),
                datasets: [{
                    label: 'New Registrations',
                    data: trendData.map(item => item.count || 0),
                    borderColor: '#FF6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Make updateCharts globally available
window.updateCharts = async function(filters) {
    try {
        const params = new URLSearchParams(filters);
        
        // Update users statistics
        const response = await fetch(`/admin-dashboard/api/users-statistics/?${params}`);
        const data = await response.json();
        
        if (data.success) {
            updateChartData(data.data);
            updateStatistics(data.data);
        }
    } catch (error) {
        console.error('Error updating charts:', error);
    }
}

// Make updateChartData globally available
window.updateChartData = function(data) {
    // Update Authority Chart
    if (window.authorityChart && data.users_by_authority) {
        window.authorityChart.data.labels = data.users_by_authority.map(item => item.media_authority__name || 'Unknown');
        window.authorityChart.data.datasets[0].data = data.users_by_authority.map(item => item.count);
        window.authorityChart.update();
    }
    
    // Update Age Chart
    if (window.ageChart && data.age_groups) {
        window.ageChart.data.datasets[0].data = [
            data.age_groups.under_18 || 0,
            data.age_groups['18_25'] || 0,
            data.age_groups['26_35'] || 0,
            data.age_groups['36_50'] || 0,
            data.age_groups.over_50 || 0
        ];
        window.ageChart.update();
    }
    
    // Update Gender Chart
    if (window.genderChart && data.basic_stats) {
        window.genderChart.data.datasets[0].data = [
            data.basic_stats.male_users || 0,
            data.basic_stats.female_users || 0,
            data.basic_stats.diverse_users || 0
        ];
        window.genderChart.update();
    }
    
    // Update Member Chart
    if (window.memberChart && data.member_distribution) {
        window.memberChart.data.datasets[0].data = [
            data.member_distribution.members || 0,
            data.member_distribution.non_members || 0
        ];
        window.memberChart.update();
    }
    
    // Update Trend Chart
    if (window.trendChart && data.registration_trend) {
        window.trendChart.data.labels = data.registration_trend.map(item => item.date);
        window.trendChart.data.datasets[0].data = data.registration_trend.map(item => item.count);
        window.trendChart.update();
    }
}

// Make updateStatistics globally available
window.updateStatistics = function(data) {
    // Update statistics cards safely
    updateStatisticsCards(data);
}

// Make updateStatisticsCards globally available
window.updateStatisticsCards = function(data) {
    console.log('=== updateStatisticsCards START ===');
    console.log('data parameter:', data);
    
    // Check if data and basic_stats exist
    if (!data || !data.basic_stats || typeof data.basic_stats !== 'object') {
        console.warn('data or basic_stats is invalid, skipping statistics update');
        console.log('=== updateStatisticsCards END (early return) ===');
        return;
    }
    
    const elements = {
        'totalUsers': data.basic_stats.total_users || 0,
        'maleUsers': data.basic_stats.male_users || 0,
        'femaleUsers': data.basic_stats.female_users || 0,
        'verifiedUsers': data.basic_stats.verified_users || 0,
        'memberUsers': data.basic_stats.member_users || 0,
        'newUsers': data.basic_stats.new_users || 0
    };
    
    console.log('Elements to update:', elements);
    
    Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
            console.log(`Updated ${id} with value: ${value}`);
        } else {
            console.warn(`Element with id '${id}' not found`);
        }
    });
    
    console.log('=== updateStatisticsCards END ===');
}

// Make exportChartData globally available
window.exportChartData = function(chartId) {
    const chart = getChartInstance(chartId);
    if (chart) {
        const data = chart.data;
        const csv = convertToCSV(data);
        downloadCSV(csv, `${chartId}_data.csv`);
    }
}

// Make exportTableData globally available
window.exportTableData = function(tableId) {
    const table = document.getElementById(tableId);
    const rows = Array.from(table.querySelectorAll('tr'));
    const csv = convertTableToCSV(rows);
    downloadCSV(csv, `${tableId}_data.csv`);
}

// Make getChartInstance globally available
window.getChartInstance = function(chartId) {
    switch(chartId) {
        case 'authorityChart': return window.authorityChart;
        case 'ageChart': return window.ageChart;
        case 'genderChart': return window.genderChart;
        case 'memberChart': return window.memberChart;
        case 'trendChart': return window.trendChart;
        default: return null;
    }
}

// Make convertToCSV globally available
window.convertToCSV = function(data) {
    const labels = data.labels;
    const values = data.datasets[0].data;
    
    let csv = 'Label,Value\n';
    for (let i = 0; i < labels.length; i++) {
        csv += `"${labels[i]}",${values[i]}\n`;
    }
    
    return csv;
}

// Make convertTableToCSV globally available
window.convertTableToCSV = function(rows) {
    let csv = '';
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
        csv += rowData + '\n';
    });
    return csv;
}

// Make downloadCSV globally available
window.downloadCSV = function(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
