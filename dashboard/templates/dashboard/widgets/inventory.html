{% extends "dashboard/base.html" %}
{% load i18n %}

{% block title %}{% trans "Inventory & Rental Statistics" %}{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
        <div class="card">
            <div class="card-header">
            <h5 class="card-title mb-0">{% trans "Filters" %}</h5>
            </div>
            <div class="card-body">
            <form id="filtersForm">
    
                <!-- Row 1: Zeitraum + User -->
                <div class="row mb-3">
                <div class="col-md-2">
                    <label for="dateRange" class="form-label">{% trans "Time Period" %}</label>
                    <select class="form-select" id="dateRange" name="days">
                    <option value="7">{% trans "Last 7 days" %}</option>
                    <option value="30" selected>{% trans "Last 30 days" %}</option>
                    <option value="90">{% trans "Last 90 days" %}</option>
                    <option value="365">{% trans "Last year" %}</option>
                    <option value="custom">{% trans "Custom Period" %}</option>
                    </select>
                </div>
                <div class="col-md-2" id="customDateInputs" style="display: none;">
                    <label for="startDate" class="form-label">{% trans "Start Date" %}</label>
                    <input type="date" class="form-control" id="startDate" name="start_date">
                </div>
                <div class="col-md-2" id="customDateInputs2" style="display: none;">
                    <label for="endDate" class="form-label">{% trans "End Date" %}</label>
                    <input type="date" class="form-control" id="endDate" name="end_date">
                </div>
                <div class="col-md-2">
                    <label for="gender" class="form-label">{% trans "Gender" %}</label>
                    <select class="form-select" id="gender" name="gender">
                    <option value="">{% trans "All" %}</option>
                    <option value="m">{% trans "Male" %}</option>
                    <option value="f">{% trans "Female" %}</option>
                    <option value="d">{% trans "Diverse" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="member" class="form-label">{% trans "Membership" %}</label>
                    <select class="form-select" id="member" name="member">
                    <option value="">{% trans "All" %}</option>
                    <option value="true">{% trans "Members" %}</option>
                    <option value="false">{% trans "Non-members" %}</option>
                    </select>
                </div>
                </div>
    
                <!-- Row 2: Inventory -->
                <div class="row mb-3">
                <div class="col-md-2">
                    <label for="category" class="form-label">{% trans "Category" %}</label>
                    <select class="form-select" id="category" name="category">
                    <option value="">{% trans "All" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="owner" class="form-label">{% trans "Owner" %}</label>
                    <select class="form-select" id="owner" name="owner">
                    <option value="">{% trans "All" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="location" class="form-label">{% trans "Location" %}</label>
                    <select class="form-select" id="location" name="location">
                    <option value="">{% trans "All" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">{% trans "Status" %}</label>
                    <select class="form-select" id="status" name="status">
                    <option value="">{% trans "All" %}</option>
                    <option value="in_stock">{% trans "In Stock" %}</option>
                    <option value="out_of_stock">{% trans "Out of Stock" %}</option>
                    <option value="maintenance">{% trans "Maintenance" %}</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-primary me-2" id="applyFiltersBtn">{% trans "Apply Filters" %}</button>
                    <button type="button" class="btn btn-secondary" onclick="window.resetInventoryFilters()">{% trans "Reset" %}</button>
                </div>
                </div>
    
            </form>
            </div>
        </div>
        </div>
    </div>  
  
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary" id="totalItems">-</h5>
                    <p class="card-text">{% trans "Total Items" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success" id="inStockItems">-</h5>
                    <p class="card-text">{% trans "In Stock" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning" id="rentedItems">-</h5>
                    <p class="card-text">{% trans "Rented" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info" id="totalRentals">-</h5>
                    <p class="card-text">{% trans "Total Rentals" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success" id="activeRentals">-</h5>
                    <p class="card-text">{% trans "Active Rentals" %}</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary" id="utilizationRate">-</h5>
                    <p class="card-text">{% trans "Utilization Rate" %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Inventory by Category" %}</h5>
                </div>
                <div class="card-body">
                    <canvas id="inventoryByCategoryChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Inventory by Owner" %}</h5>
                </div>
                <div class="card-body">
                    <canvas id="inventoryByOwnerChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Rentals by Status" %}</h5>
                </div>
                <div class="card-body">
                    <canvas id="rentalsByStatusChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Rentals by Type" %}</h5>
                </div>
                <div class="card-body">
                    <canvas id="rentalsByTypeChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Rentals by Gender" %}</h5>
                </div>
                <div class="card-body">
                    <canvas id="rentalsByGenderChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Rentals Trend" %}</h5>
                </div>
                <div class="card-body">
                    <canvas id="rentalsTrendChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Equipment Sets Statistics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Equipment Sets Statistics" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-primary" id="activeSets">-</h4>
                                <p class="text-muted">{% trans "Active Sets" %}</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-success" id="availableSets">-</h4>
                                <p class="text-muted">{% trans "Available Sets" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Popular Equipment Sets" %}</h5>
                </div>
                <div class="card-body">
                    <div id="popularSetsList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Inventory Statistics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Popular Inventory Statistics" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-primary" id="availableItems">-</h4>
                                <p class="text-muted">{% trans "Available Items" %}</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-info" id="totalRentals">-</h4>
                                <p class="text-muted">{% trans "Total Rentals" %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Popular Inventory Items" %}</h5>
                </div>
                <div class="card-body">
                    <div id="popularInventoryList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- User Activity Analytics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "User Activity Analytics" %}</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-warning">{% trans "Anti-Rating" %}</h6>
                    <p class="text-muted small">{% trans "Users who rent but don't create licenses" %}</p>
                    <div id="antiRatingList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Content Creators" %}</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-success">{% trans "Rating" %}</h6>
                    <p class="text-muted small">{% trans "Users who create licenses but don't rent much" %}</p>
                    <div id="ratingList">
                        <p class="text-muted">{% trans "Loading..." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Rentals Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% trans "Room Rentals Statistics" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{% trans "Room Usage Trend" %}</h6>
                            <canvas id="roomTrendChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h6>{% trans "Popular Rooms" %}</h6>
                            <div id="popularRoomsStats">
                                <p class="text-muted">{% trans "Loading..." %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{% trans "Loading..." %}</span>
    </div>
</div>

<script>
// Global chart variables
window.inventoryByCategoryChart = null;
window.inventoryByOwnerChart = null;
window.rentalsByStatusChart = null;
window.rentalsByTypeChart = null;
window.rentalsByGenderChart = null;
window.rentalsTrendChart = null;
window.roomTrendChart = null;

// Toggle custom date inputs for inventory
function toggleInventoryCustomDateInputs() {
    const dateRange = document.getElementById('dateRange');
    const customInputs = document.getElementById('customDateInputs');
    const customInputs2 = document.getElementById('customDateInputs2');
    
    console.log('toggleInventoryCustomDateInputs called');
    console.log('dateRange value:', dateRange ? dateRange.value : 'dateRange not found');
    console.log('customInputs found:', !!customInputs);
    console.log('customInputs2 found:', !!customInputs2);
    
    if (dateRange && customInputs && customInputs2) {
        if (dateRange.value === 'custom') {
            customInputs.style.display = 'block';
            customInputs2.style.display = 'block';
            console.log('Showing custom date inputs');
        } else {
            customInputs.style.display = 'none';
            customInputs2.style.display = 'none';
            console.log('Hiding custom date inputs');
        }
    } else {
        console.error('Required elements not found for toggleInventoryCustomDateInputs');
    }
}

// Define resetFilters function
window.resetInventoryFilters = function() {
    const form = document.getElementById('filtersForm');
    if (form) {
        form.reset();
        // Set default values
        document.getElementById('dateRange').value = '30';
        toggleInventoryCustomDateInputs();
        // Apply filters with default values
        window.applyInventoryFilters();
    }
};

// Define applyFilters function early
window.applyInventoryFilters = function() {
    const form = document.getElementById('filtersForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();

    for (let [key, value] of formData.entries()) {
        // Skip empty, undefined, or null values
        if (value && value !== 'undefined' && value !== 'null' && value.trim() !== '') {
            // Handle custom date period
            if (key === 'days' && value === 'custom') {
                // Don't add days parameter for custom period
                continue;
            }
            params.append(key, value);
        }
    }
    
    window.history.pushState({}, '', window.location.pathname + '?' + params.toString());
    
    loadChartData().then(function() {
        // Update statistics cards
        if (window.chartData && window.chartData.basic_stats) {
            updateStatisticsCards(window.chartData.basic_stats);
        }
        
        // Update charts
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    }).catch(function(error) {
        console.error('Error updating charts:', error);
        if (window.initializeCharts) {
            window.initializeCharts();
        }
    });
};



// Load chart data via AJAX
async function loadChartData() {
    try {
        setLoadingState(true);
        const urlParams = new URLSearchParams(window.location.search);
        const response = await fetch(`/admin-dashboard/api/inventory-statistics/?${urlParams.toString()}`).then(r => r.json());
        const data = response;
        
        if (data.success && data.data) {
            window.chartData = {
                basic_stats: data.data.basic_stats || {},
                inventory_by_category: data.data.inventory_by_category || [],
                inventory_by_owner: data.data.inventory_by_owner || [],
                rentals_by_status: data.data.rentals_by_status || [],
                rentals_by_type: data.data.rentals_by_type || [],
                rentals_by_demographics: data.data.rentals_by_demographics || {},
                rentals_trend: data.data.rentals_trend || [],
                equipment_sets_stats: data.data.equipment_sets_stats || {},
                popular_inventory_stats: data.data.popular_inventory_stats || {},
                user_activity_analytics: data.data.user_activity_analytics || {},
                room_rentals_stats: data.data.room_rentals_stats || {}
            };
            
            // Update statistics cards
            updateStatisticsCards(data.data.basic_stats);
            
        } else {
            console.error('API returned error or no data:', data);
            window.chartData = {
                basic_stats: {},
                inventory_by_category: [],
                inventory_by_owner: [],
                rentals_by_status: [],
                rentals_by_type: [],
                rentals_by_demographics: {},
                rentals_trend: [],
                equipment_sets_stats: {},
                popular_inventory_stats: {},
                user_activity_analytics: {},
                room_rentals_stats: {}
            };
        }
    } catch (error) {
        console.error('Error loading chart data:', error);
        window.chartData = {
            basic_stats: {},
            inventory_by_category: [],
            inventory_by_owner: [],
            rentals_by_status: [],
            rentals_by_type: [],
            rentals_by_demographics: {},
            rentals_trend: [],
            equipment_sets_stats: {},
            popular_inventory_stats: {},
            user_activity_analytics: {},
            room_rentals_stats: {}
        };
    } finally {
        setLoadingState(false);
    }
}

// Update statistics cards
window.updateStatisticsCards = function(basicStats) {
    if (!basicStats || typeof basicStats !== 'object') {
        console.warn('basicStats is undefined or not an object, skipping statistics update');
        return;
    }

    // Update basic statistics
    document.getElementById('totalItems').textContent = basicStats.total_items || 0;
    document.getElementById('inStockItems').textContent = basicStats.in_stock_items || 0;
    document.getElementById('rentedItems').textContent = basicStats.rented_items || 0;
    document.getElementById('totalRentals').textContent = basicStats.total_rentals || 0;
    document.getElementById('activeRentals').textContent = basicStats.active_rentals || 0;
    document.getElementById('utilizationRate').textContent = (basicStats.utilization_rate || 0) + '%';
    
    // Update equipment sets stats
    const equipmentStats = window.chartData.equipment_sets_stats || {};
    document.getElementById('activeSets').textContent = equipmentStats.active_sets || 0;
    document.getElementById('availableSets').textContent = equipmentStats.available_sets || 0;
    
    // Update popular inventory stats
    const popularInventoryStats = window.chartData.popular_inventory_stats || {};
    document.getElementById('availableItems').textContent = popularInventoryStats.total_available_items || 0;
    
    // Calculate total rentals from popular items
    const totalRentals = (popularInventoryStats.popular_items || []).reduce((sum, item) => sum + (item.rental_count || 0), 0);
    document.getElementById('totalRentals').textContent = totalRentals;
    
    // Update popular sets
    const popularSetsList = document.getElementById('popularSetsList');
    if (equipmentStats.popular_sets && equipmentStats.popular_sets.length > 0) {
        popularSetsList.innerHTML = equipmentStats.popular_sets.map(set => 
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <span>${set.name}</span>
                <span class="badge bg-primary">${set.usage_count}</span>
            </div>`
        ).join('');
    } else {
        popularSetsList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }
    
    // Update popular inventory items
    const popularInventoryList = document.getElementById('popularInventoryList');
    if (popularInventoryStats.popular_items && popularInventoryStats.popular_items.length > 0) {
        popularInventoryList.innerHTML = popularInventoryStats.popular_items.map(item => 
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">${item.manufacturer || ''}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-info">${item.rental_count}</span>
                </div>
            </div>`
        ).join('');
    } else {
        popularInventoryList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }
    
    // Update user activity analytics
    const userActivityAnalytics = window.chartData.user_activity_analytics || {};
    
    // Update anti-rating list
    const antiRatingList = document.getElementById('antiRatingList');
    if (userActivityAnalytics.anti_rating && userActivityAnalytics.anti_rating.length > 0) {
        antiRatingList.innerHTML = userActivityAnalytics.anti_rating.map(user => 
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${user.username}</div>
                    <small class="text-muted">${user.gender || 'Unknown'}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-warning">${user.rental_count}</span>
                    <small class="text-muted d-block">rentals</small>
                </div>
            </div>`
        ).join('');
    } else {
        antiRatingList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }
    
    // Update rating list
    const ratingList = document.getElementById('ratingList');
    if (userActivityAnalytics.rating && userActivityAnalytics.rating.length > 0) {
        ratingList.innerHTML = userActivityAnalytics.rating.map(user => 
            `<div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${user.username}</div>
                    <small class="text-muted">${user.gender || 'Unknown'}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-success">${user.license_count}</span>
                    <small class="text-muted d-block">licenses</small>
                </div>
            </div>`
        ).join('');
    } else {
        ratingList.innerHTML = '<p class="text-muted">{% trans "No data available" %}</p>';
    }
}

// Set loading state
function setLoadingState(loading) {
    const overlay = document.getElementById('loadingOverlay');
    if (loading) {
        overlay.style.display = 'flex';
    } else {
        overlay.style.display = 'none';
    }
}

// Make initializeCharts globally available
window.initializeCharts = function() {
    console.log('initializeCharts called');
    
    // Prevent multiple simultaneous calls
    if (window.initializingCharts) {
        console.log('initializeCharts already running, skipping');
        return;
    }
    window.initializingCharts = true;
    // Check if chartData is available
    if (!window.chartData) {
        console.warn('Chart data not available, initializing with empty data');
        window.chartData = {
            basic_stats: {},
            inventory_by_category: [],
            inventory_by_owner: [],
            rentals_by_status: [],
            rentals_by_type: [],
            rentals_by_demographics: {},
            rentals_trend: [],
            equipment_sets_stats: {},
            room_rentals_stats: {}
        };
    }
    
    // Ensure all data arrays exist
    if (!window.chartData.inventory_by_category) window.chartData.inventory_by_category = [];
    if (!window.chartData.inventory_by_owner) window.chartData.inventory_by_owner = [];
    if (!window.chartData.rentals_by_status) window.chartData.rentals_by_status = [];
    if (!window.chartData.rentals_by_type) window.chartData.rentals_by_type = [];
    if (!window.chartData.rentals_by_demographics) window.chartData.rentals_by_demographics = {};
    if (!window.chartData.rentals_trend) window.chartData.rentals_trend = [];
    if (!window.chartData.equipment_sets_stats) window.chartData.equipment_sets_stats = {};
    if (!window.chartData.room_rentals_stats) window.chartData.room_rentals_stats = {};
    
    // Destroy and recreate all charts
    // Destroy existing charts
    if (window.inventoryByCategoryChart) {
        window.inventoryByCategoryChart.destroy();
        window.inventoryByCategoryChart = null;
    }
    
    if (window.inventoryByOwnerChart) {
        window.inventoryByOwnerChart.destroy();
        window.inventoryByOwnerChart = null;
    }
    
    if (window.rentalsByStatusChart) {
        window.rentalsByStatusChart.destroy();
        window.rentalsByStatusChart = null;
    }
    
    if (window.rentalsByTypeChart) {
        window.rentalsByTypeChart.destroy();
        window.rentalsByTypeChart = null;
    }
    
    if (window.rentalsByGenderChart) {
        window.rentalsByGenderChart.destroy();
        window.rentalsByGenderChart = null;
    }
    
    if (window.rentalsTrendChart) {
        window.rentalsTrendChart.destroy();
        window.rentalsTrendChart = null;
    }
    
    if (window.roomTrendChart) {
        console.log('Destroying roomTrendChart');
        window.roomTrendChart.destroy();
        window.roomTrendChart = null;
    }
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    // Inventory by Category Chart
    const categoryCtx = document.getElementById('inventoryByCategoryChart');
    if (categoryCtx) {
        window.inventoryByCategoryChart = new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: window.chartData.inventory_by_category.map(item => item.name),
                datasets: [{
                    label: '{% trans "Total Items" %}',
                    data: window.chartData.inventory_by_category.map(item => item.total_items),
                    backgroundColor: '#36A2EB'
                }, {
                    label: '{% trans "Rented Items" %}',
                    data: window.chartData.inventory_by_category.map(item => item.rented_items),
                    backgroundColor: '#FF6384'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Inventory by Owner Chart
    const ownerCtx = document.getElementById('inventoryByOwnerChart');
    if (ownerCtx) {
        window.inventoryByOwnerChart = new Chart(ownerCtx, {
            type: 'doughnut',
            data: {
                labels: window.chartData.inventory_by_owner.map(item => item.name),
                datasets: [{
                    data: window.chartData.inventory_by_owner.map(item => item.total_items),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Rentals by Status Chart
    const statusCtx = document.getElementById('rentalsByStatusChart');
    if (statusCtx) {
        window.rentalsByStatusChart = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: window.chartData.rentals_by_status.map(item => item.status),
                datasets: [{
                    data: window.chartData.rentals_by_status.map(item => item.count),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Rentals by Type Chart
    const typeCtx = document.getElementById('rentalsByTypeChart');
    if (typeCtx) {
        window.rentalsByTypeChart = new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: window.chartData.rentals_by_type.map(item => item.type),
                datasets: [{
                    label: '{% trans "Count" %}',
                    data: window.chartData.rentals_by_type.map(item => item.count),
                    backgroundColor: '#9966FF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Rentals by Gender Chart
    const genderCtx = document.getElementById('rentalsByGenderChart');
    if (genderCtx) {
        const genderData = window.chartData.rentals_by_demographics.gender || [];
        window.rentalsByGenderChart = new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: genderData.map(item => item.user__profile__gender || 'Unknown'),
                datasets: [{
                    data: genderData.map(item => item.count),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Rentals Trend Chart
    const trendCtx = document.getElementById('rentalsTrendChart');
    if (trendCtx) {
        window.rentalsTrendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: window.chartData.rentals_trend.map(item => item.period),
                datasets: [{
                    label: '{% trans "Rentals" %}',
                    data: window.chartData.rentals_trend.map(item => item.count),
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    

    
    // Room Trend Chart
    const roomTrendCtx = document.getElementById('roomTrendChart');
    if (roomTrendCtx && window.chartData.room_rentals_stats && window.chartData.room_rentals_stats.time_periods && window.chartData.room_rentals_stats.time_periods.length > 0) {
        console.log('Creating roomTrendChart with data:', window.chartData.room_rentals_stats.time_periods);
        window.roomTrendChart = new Chart(roomTrendCtx, {
            type: 'line',
            data: {
                labels: window.chartData.room_rentals_stats.time_periods.map(item => item.period),
                datasets: [{
                    label: '{% trans "Room Rentals" %}',
                    data: window.chartData.room_rentals_stats.time_periods.map(item => item.count),
                    borderColor: '#FF9F40',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Update popular rooms list
    if (window.chartData.room_rentals_stats) {
        const popularRoomsDiv = document.getElementById('popularRoomsStats');
        if (popularRoomsDiv) {
            const rooms = window.chartData.room_rentals_stats.popular_rooms;
            if (rooms && rooms.length > 0) {
                popularRoomsDiv.innerHTML = rooms.map(room => 
                    `<div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${room.room}</span>
                        <span class="badge bg-primary">${room.count}</span>
                    </div>`
                ).join('');
            } else {
                popularRoomsDiv.innerHTML = '<p class="text-muted">{% trans "No room rentals found" %}</p>';
            }
        }
    }
    
    // Reset the flag
    window.initializingCharts = false;
};

// Load filter data
async function loadFilterData() {
    try {
        const response = await fetch('/admin-dashboard/api/filters-data/');
        const data = await response.json();
        
        console.log('Filter data loaded:', data);
        
        if (data.success) {
            // Populate categories
            const categorySelect = document.getElementById('category');
            if (categorySelect && data.inventory_categories) {
                data.inventory_categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }
            
            // Populate owners (organizations)
            const ownerSelect = document.getElementById('owner');
            if (ownerSelect && data.organizations) {
                data.organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    ownerSelect.appendChild(option);
                });
            }
            
            // Populate locations
            const locationSelect = document.getElementById('location');
            if (locationSelect && data.locations) {
                data.locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    locationSelect.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Error loading filter data:', error);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load filter data first
    loadFilterData();
    
    // Initialize custom date inputs visibility with delay
    setTimeout(() => {
        toggleInventoryCustomDateInputs();
    }, 100);
    
    // Load initial data
    loadChartData();
    
    // Add event listeners for form submission
    const filtersForm = document.getElementById('filtersForm');
    if (filtersForm) {
        filtersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            window.applyInventoryFilters();
        });
    }
    
    // Add click event listener to Apply Filters button
    const applyButton = document.getElementById('applyFiltersBtn');
    if (applyButton) {
        applyButton.addEventListener('click', function(e) {
            e.preventDefault();
            window.applyInventoryFilters();
        });
    }
    
    // Add event listeners for filter changes (only for date range to toggle custom inputs)
    const dateRangeSelect = document.getElementById('dateRange');
    if (dateRangeSelect) {
        dateRangeSelect.addEventListener('change', function() {
            toggleInventoryCustomDateInputs();
        });
    }
});
</script>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.15s ease-in-out;
}

/* Room charts height limit */
#roomTrendChart {
    max-height: 200px !important;
    height: 200px !important;
}
</style>
{% endblock %}
