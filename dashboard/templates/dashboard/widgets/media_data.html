{% extends "dashboard/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">

                <!-- Filters Section -->
                <div class="filter-section">
                    <form id="filtersForm" method="GET">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label">{% trans "Date Range" %}</label>
                                <select class="form-select" id="dateRange" name="days">
                                <option value="7">{% trans "Last 7 days" %}</option>
                                <option value="30">{% trans "Last 30 days" %}</option>
                                <option value="90">{% trans "Last 90 days" %}</option>
                                <option value="365">{% trans "Last year" %}</option>
                                <option value="all">{% trans "All Time" %}</option>
                                <option value="custom">{% trans "Custom Period" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="customStartDate" class="form-label">{% trans "Start Date" %}</label>
                                <input type="date" class="form-control" id="customStartDate" name="start_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="customEndDate" class="form-label">{% trans "End Date" %}</label>
                                <input type="date" class="form-control" id="customEndDate" name="end_date" style="display: none;">
                        </div>
                        <div class="col-md-3">
                            <label for="mediaAuthority" class="form-label">{% trans "Media Authority" %}</label>
                                <select class="form-select" id="mediaAuthority" name="media_authority">
                                <option value="">{% trans "All Authorities" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="genderFilter" class="form-label">{% trans "Gender" %}</label>
                                <select class="form-select" id="genderFilter" name="gender">
                                <option value="">{% trans "All Genders" %}</option>
                                <option value="m">{% trans "Male" %}</option>
                                <option value="f">{% trans "Female" %}</option>
                                <option value="d">{% trans "Diverse" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="ageGroupFilter" class="form-label">{% trans "Age Group" %}</label>
                                <select class="form-select" id="ageGroupFilter" name="age_group">
                                <option value="">{% trans "All Ages" %}</option>
                                <option value="up_to_34">{% trans "Up to 34" %}</option>
                                <option value="35_50">{% trans "35-50" %}</option>
                                <option value="51_65">{% trans "51-65" %}</option>
                                <option value="over_65">{% trans "Over 65" %}</option>
                                <option value="unknown">{% trans "Unknown" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="memberFilter" class="form-label">{% trans "Member Status" %}</label>
                                <select class="form-select" id="memberFilter" name="member">
                                <option value="">{% trans "All Users" %}</option>
                                <option value="true">{% trans "Members Only" %}</option>
                                <option value="false">{% trans "Non-Members Only" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="verifiedFilter" class="form-label">{% trans "Verification" %}</label>
                                <select class="form-select" id="verifiedFilter" name="verified">
                                <option value="">{% trans "All Users" %}</option>
                                <option value="true">{% trans "Verified Only" %}</option>
                                <option value="false">{% trans "Not Verified" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="categoryFilter" class="form-label">{% trans "Categories" %}</label>
                                <select class="form-select" id="categoryFilter" name="category">
                                <option value="">{% trans "All Categories" %}</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                        </div>
                    </div>
                        <div class="row mt-3">
                        <div class="col-12">
                                <button type="submit" class="btn btn-primary">{% trans "Apply Filters" %}</button>
                                <button type="button" class="btn btn-secondary" onclick="resetFilters()">{% trans "Reset" %}</button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Active Filters Legend -->
                    <div id="activeFiltersLegend" class="mt-3 p-3 bg-light border rounded" style="display: none;">
                        <h6 class="mb-2"><i class="bi bi-funnel-fill"></i> {% trans "Active Filters" %}:</h6>
                        <div id="filtersDisplay" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Chart 1: Age Structure of Users with Licenses and Broadcasts -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title" id="usersChartTitle">{% trans "Age Structure of Users with Licenses and Broadcasts" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('usersWithLicensesChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="usersWithLicensesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart 2: Number of New Broadcasts by Age -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title" id="broadcastsChartTitle">{% trans "Number of New Broadcasts by Age" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('broadcastsByAgeChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="broadcastsByAgeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart 3: Duration by Age -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title" id="durationByAgeChartTitle">{% trans "Broadcast Time by Age (in Minutes)" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('durationByAgeChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="durationByAgeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart 4: Duration by Categories -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="dashboard-widget">
                            <div class="widget-header d-flex justify-content-between align-items-center">
                                <h3 class="widget-title" id="durationByCategoryChartTitle">{% trans "Broadcast Time by Categories (in Minutes)" %}</h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportChartData('durationByCategoryChart')">
                                    <i class="bi bi-download"></i> {% trans "Export" %}
                                </button>
                            </div>
                            <div class="chart-container">
                                <canvas id="durationByCategoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let usersWithLicensesChart = null;
let broadcastsByAgeChart = null;
let durationByAgeChart = null;
let durationByCategoryChart = null;
let chartData = {};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadFilterData();
    setupEventListeners();
    updateActiveFiltersDisplay();
    // Load chart data and initialize charts after data is loaded
    loadChartData();
});

function loadFilterData() {
    fetch('/admin-dashboard/api/media-data-statistics/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate media authorities
                const mediaAuthoritySelect = document.getElementById('mediaAuthority');
                if (data.data.filters.context.media_authorities) {
                    data.data.filters.context.media_authorities.forEach(authority => {
                        const option = document.createElement('option');
                        option.value = authority.name;
                        option.textContent = authority.name;
                        mediaAuthoritySelect.appendChild(option);
                    });
                }

                // Populate categories
                const categorySelect = document.getElementById('categoryFilter');
                if (data.data.filters.context.categories) {
                    data.data.filters.context.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                }

                console.log('Filter data loaded:', data);
            }
        })
        .catch(error => console.error('Error loading filter data:', error));
}

function loadChartData() {
    const urlParams = new URLSearchParams(window.location.search);
    const queryString = urlParams.toString();
    
    fetch(`/admin-dashboard/api/media-data-statistics/?${queryString}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chartData = data.data;
                console.log('Chart data loaded:', chartData);
                
                // Initialize charts if not already initialized
                if (!usersWithLicensesChart) {
                    initializeCharts();
                } else {
                    // Update existing charts
                    updateCharts();
                }
            }
        })
        .catch(error => console.error('Error loading chart data:', error));
}

function initializeCharts() {
    // Chart 1: Users with Licenses and Broadcasts
    const usersCtx = document.getElementById('usersWithLicensesChart');
    if (usersCtx) {
        const usersData = chartData.users_with_licenses_and_broadcasts || {};
        const dataValues = [
            usersData.up_to_34 || 0,
            usersData['35_50'] || 0,
            usersData['51_65'] || 0,
            usersData.over_65 || 0,
            usersData.unknown || 0
        ];
        const totalUsers = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок с общим количеством
        document.getElementById('usersChartTitle').textContent = 
            '{% trans "Age Structure of Users with Licenses and Broadcasts" %} (' + totalUsers + ')';
        
        usersWithLicensesChart = new Chart(usersCtx, {
            type: 'bar',
            data: {
                labels: [
                    '{% trans "Up to 34" %} (' + dataValues[0] + ')',
                    '{% trans "35-50" %} (' + dataValues[1] + ')',
                    '{% trans "51-65" %} (' + dataValues[2] + ')',
                    '{% trans "Over 65" %} (' + dataValues[3] + ')',
                    '{% trans "Unknown" %} (' + dataValues[4] + ')'
                ],
                datasets: [{
                    label: '{% trans "Users" %}',
                    data: dataValues,
                    backgroundColor: '#1e40af',
                    borderColor: '#1e40af',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        },
                        title: {
                            display: true,
                            text: '{% trans "Number of Users" %}'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '{% trans "Age Group" %}'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Chart 2: Broadcasts by Age
    const broadcastsCtx = document.getElementById('broadcastsByAgeChart');
    if (broadcastsCtx) {
        const broadcastsData = chartData.new_broadcasts_by_age || {};
        const dataValues = [
            broadcastsData.up_to_34 || 0,
            broadcastsData['35_50'] || 0,
            broadcastsData['51_65'] || 0,
            broadcastsData.over_65 || 0,
            broadcastsData.unknown || 0
        ];
        const totalBroadcasts = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок с общим количеством
        document.getElementById('broadcastsChartTitle').textContent = 
            '{% trans "Number of New Broadcasts by Age" %} (' + totalBroadcasts + ')';
        
        broadcastsByAgeChart = new Chart(broadcastsCtx, {
            type: 'bar',
            data: {
                labels: [
                    '{% trans "Up to 34" %} (' + dataValues[0] + ')',
                    '{% trans "35-50" %} (' + dataValues[1] + ')',
                    '{% trans "51-65" %} (' + dataValues[2] + ')',
                    '{% trans "Over 65" %} (' + dataValues[3] + ')',
                    '{% trans "Unknown" %} (' + dataValues[4] + ')'
                ],
                datasets: [{
                    label: '{% trans "Broadcasts" %}',
                    data: dataValues,
                    backgroundColor: [
                        '#1e40af', // Dark blue - Up to 34
                        '#ea580c', // Orange - 35-50
                        '#ca8a04', // Yellow - 51-65
                        '#16a34a', // Green - Over 65
                        '#dc2626'  // Dark red - Unknown
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{% trans "Number of Broadcasts" %}'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '{% trans "Age Group" %}'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Chart 3: Duration by Age
    const durationCtx = document.getElementById('durationByAgeChart');
    if (durationCtx) {
        const durationData = chartData.duration_by_age || {};
        const dataValues = [
            Math.round(durationData.up_to_34 || 0),
            Math.round(durationData['35_50'] || 0),
            Math.round(durationData['51_65'] || 0),
            Math.round(durationData.over_65 || 0),
            Math.round(durationData.unknown || 0)
        ];
        const totalDuration = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок с общим количеством
        document.getElementById('durationByAgeChartTitle').textContent = 
            '{% trans "Broadcast Time by Age (in Minutes)" %} (' + totalDuration + ')';
        
        durationByAgeChart = new Chart(durationCtx, {
            type: 'bar',
            data: {
                labels: [
                    '{% trans "Up to 34" %} (' + dataValues[0] + ')',
                    '{% trans "35-50" %} (' + dataValues[1] + ')',
                    '{% trans "51-65" %} (' + dataValues[2] + ')',
                    '{% trans "Over 65" %} (' + dataValues[3] + ')',
                    '{% trans "Unknown" %} (' + dataValues[4] + ')'
                ],
                datasets: [{
                    label: '{% trans "Duration (minutes)" %}',
                    data: dataValues,
                    backgroundColor: [
                        '#1e40af', // Dark blue - Up to 34
                        '#ea580c', // Orange - 35-50
                        '#ca8a04', // Yellow - 51-65
                        '#16a34a', // Green - Over 65
                        '#dc2626'  // Dark red - Unknown
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{% trans "Duration (minutes)" %}'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '{% trans "Age Group" %}'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Chart 4: Duration by Categories
    const categoryCtx = document.getElementById('durationByCategoryChart');
    if (categoryCtx) {
        const categoryData = chartData.duration_by_category || {};
        const categoryKeys = Object.keys(categoryData);
        const categoryValues = Object.values(categoryData).map(val => Math.round(val));
        const totalCategoryDuration = categoryValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок с общим количеством
        document.getElementById('durationByCategoryChartTitle').textContent = 
            '{% trans "Broadcast Time by Categories (in Minutes)" %} (' + totalCategoryDuration + ')';
        
        // Добавление значений к меткам категорий
        const categoryLabels = categoryKeys.map((key, index) => {
            return key + ' (' + categoryValues[index] + ')';
        });
        
        // Динамическая высота: минимум 300px, 40px на категорию
        const minHeight = 300;
        const heightPerCategory = 40;
        const calculatedHeight = Math.max(minHeight, categoryKeys.length * heightPerCategory);
        
        // Установка высоты контейнера
        const container = categoryCtx.parentElement;
        container.style.height = `${calculatedHeight}px`;
        
        durationByCategoryChart = new Chart(categoryCtx, {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: '{% trans "Duration (minutes)" %}',
                    data: categoryValues,
                    backgroundColor: '#3b82f6',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{% trans "Duration (minutes)" %}'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '{% trans "Category" %}'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
}

function updateCharts() {
    if (usersWithLicensesChart && chartData.users_with_licenses_and_broadcasts) {
        const usersData = chartData.users_with_licenses_and_broadcasts;
        const dataValues = [
            usersData.up_to_34 || 0,
            usersData['35_50'] || 0,
            usersData['51_65'] || 0,
            usersData.over_65 || 0,
            usersData.unknown || 0
        ];
        const totalUsers = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок
        document.getElementById('usersChartTitle').textContent = 
            '{% trans "Age Structure of Users with Licenses and Broadcasts" %} (' + totalUsers + ')';
        
        usersWithLicensesChart.data.labels = [
            '{% trans "Up to 34" %} (' + dataValues[0] + ')',
            '{% trans "35-50" %} (' + dataValues[1] + ')',
            '{% trans "51-65" %} (' + dataValues[2] + ')',
            '{% trans "Over 65" %} (' + dataValues[3] + ')',
            '{% trans "Unknown" %} (' + dataValues[4] + ')'
        ];
        usersWithLicensesChart.data.datasets[0].data = dataValues;
        usersWithLicensesChart.update('reset');
    }

    if (broadcastsByAgeChart && chartData.new_broadcasts_by_age) {
        const broadcastsData = chartData.new_broadcasts_by_age;
        const dataValues = [
            broadcastsData.up_to_34 || 0,
            broadcastsData['35_50'] || 0,
            broadcastsData['51_65'] || 0,
            broadcastsData.over_65 || 0,
            broadcastsData.unknown || 0
        ];
        const totalBroadcasts = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок
        document.getElementById('broadcastsChartTitle').textContent = 
            '{% trans "Number of New Broadcasts by Age" %} (' + totalBroadcasts + ')';
        
        broadcastsByAgeChart.data.labels = [
            '{% trans "Up to 34" %} (' + dataValues[0] + ')',
            '{% trans "35-50" %} (' + dataValues[1] + ')',
            '{% trans "51-65" %} (' + dataValues[2] + ')',
            '{% trans "Over 65" %} (' + dataValues[3] + ')',
            '{% trans "Unknown" %} (' + dataValues[4] + ')'
        ];
        broadcastsByAgeChart.data.datasets[0].data = dataValues;
        broadcastsByAgeChart.update();
    }

    if (durationByAgeChart && chartData.duration_by_age) {
        const durationData = chartData.duration_by_age;
        const dataValues = [
            Math.round(durationData.up_to_34 || 0),
            Math.round(durationData['35_50'] || 0),
            Math.round(durationData['51_65'] || 0),
            Math.round(durationData.over_65 || 0),
            Math.round(durationData.unknown || 0)
        ];
        const totalDuration = dataValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок
        document.getElementById('durationByAgeChartTitle').textContent = 
            '{% trans "Broadcast Time by Age (in Minutes)" %} (' + totalDuration + ')';
        
        durationByAgeChart.data.labels = [
            '{% trans "Up to 34" %} (' + dataValues[0] + ')',
            '{% trans "35-50" %} (' + dataValues[1] + ')',
            '{% trans "51-65" %} (' + dataValues[2] + ')',
            '{% trans "Over 65" %} (' + dataValues[3] + ')',
            '{% trans "Unknown" %} (' + dataValues[4] + ')'
        ];
        durationByAgeChart.data.datasets[0].data = dataValues;
        durationByAgeChart.update();
    }

    if (durationByCategoryChart && chartData.duration_by_category) {
        const categoryData = chartData.duration_by_category;
        const categoryKeys = Object.keys(categoryData);
        const categoryValues = Object.values(categoryData).map(val => Math.round(val));
        const totalCategoryDuration = categoryValues.reduce((sum, val) => sum + val, 0);
        
        // Обновляем заголовок
        document.getElementById('durationByCategoryChartTitle').textContent = 
            '{% trans "Broadcast Time by Categories (in Minutes)" %} (' + totalCategoryDuration + ')';
        
        // Добавление значений к меткам категорий
        const categoryLabels = categoryKeys.map((key, index) => {
            return key + ' (' + categoryValues[index] + ')';
        });
        
        // Обновляем высоту контейнера при изменении количества категорий
        const minHeight = 300;
        const heightPerCategory = 40;
        const calculatedHeight = Math.max(minHeight, categoryKeys.length * heightPerCategory);
        const container = document.getElementById('durationByCategoryChart').parentElement;
        container.style.height = `${calculatedHeight}px`;
        
        durationByCategoryChart.data.labels = categoryLabels;
        durationByCategoryChart.data.datasets[0].data = categoryValues;
        durationByCategoryChart.update();
    }
}

function setupEventListeners() {
    // Date range change handler
    document.getElementById('dateRange').addEventListener('change', function() {
        const isCustom = this.value === 'custom';
        document.getElementById('customStartDate').style.display = isCustom ? 'block' : 'none';
        document.getElementById('customEndDate').style.display = isCustom ? 'block' : 'none';
    });
}

function updateActiveFiltersDisplay() {
    const urlParams = new URLSearchParams(window.location.search);
    const filtersDisplay = document.getElementById('filtersDisplay');
    const filtersLegend = document.getElementById('activeFiltersLegend');
    
    const filters = [];
    
    // Date range
    const days = urlParams.get('days');
    const startDate = urlParams.get('start_date');
    const endDate = urlParams.get('end_date');
    
    if (days === 'all') {
        filters.push({ label: 'Datumsbereich', value: 'Gesamter Zeitraum' });
    } else if (days === '365') {
        filters.push({ label: 'Datumsbereich', value: 'Letztes Jahr' });
    } else if (days === '90') {
        filters.push({ label: 'Datumsbereich', value: 'Letzte 90 Tage' });
    } else if (days === '30') {
        filters.push({ label: 'Datumsbereich', value: 'Letzte 30 Tage' });
    } else if (days === '7') {
        filters.push({ label: 'Datumsbereich', value: 'Letzte 7 Tage' });
    } else if (startDate && endDate) {
        filters.push({ label: 'Datumsbereich', value: `${startDate} - ${endDate}` });
    }
    
    // Media authority
    const mediaAuthority = urlParams.get('media_authority');
    if (mediaAuthority) {
        filters.push({ label: 'Bürgermedium', value: mediaAuthority });
    }
    
    // Gender
    const gender = urlParams.get('gender');
    if (gender) {
        const genderMap = { 'm': 'Männlich', 'f': 'Weiblich', 'd': 'Divers' };
        filters.push({ label: 'Geschlecht', value: genderMap[gender] || gender });
    }
    
    // Age group
    const ageGroup = urlParams.get('age_group');
    if (ageGroup) {
        const ageGroupMap = { 
            'up_to_34': 'Up to 34', 
            '35_50': '35-50', 
            '51_65': '51-65', 
            'over_65': 'Over 65', 
            'unknown': 'Unbekannt' 
        };
        filters.push({ label: 'Altersgruppe', value: ageGroupMap[ageGroup] || ageGroup });
    }
    
    // Member status
    const member = urlParams.get('member');
    if (member === 'true') {
        filters.push({ label: 'Mitgliedsstatus', value: 'Nur Mitglieder' });
    } else if (member === 'false') {
        filters.push({ label: 'Mitgliedsstatus', value: 'Nur Nicht-Mitglieder' });
    }
    
    // Verification
    const verified = urlParams.get('verified');
    if (verified === 'true') {
        filters.push({ label: 'Verifizierung', value: 'Nur verifiziert' });
    } else if (verified === 'false') {
        filters.push({ label: 'Verifizierung', value: 'Nicht verifiziert' });
    }
    
    // Category
    const category = urlParams.get('category');
    if (category) {
        // Get category name from select options
        const categorySelect = document.getElementById('categoryFilter');
        const selectedOption = Array.from(categorySelect.options).find(opt => opt.value === category);
        if (selectedOption) {
            filters.push({ label: 'Kategorie', value: selectedOption.text });
        }
    }
    
    // Display filters
    if (filters.length > 0) {
        filtersDisplay.innerHTML = filters.map(filter => 
            `<span class="badge bg-primary">
                <strong>${filter.label}:</strong> ${filter.value}
            </span>`
        ).join('');
        filtersLegend.style.display = 'block';
    } else {
        filtersLegend.style.display = 'none';
    }
}

function resetFilters() {
    document.getElementById('filtersForm').reset();
    document.getElementById('customStartDate').style.display = 'none';
    document.getElementById('customEndDate').style.display = 'none';
    loadChartData();
}

// Export functions
function exportChartData(chartId) {
    const chart = getChartInstance(chartId);
    if (!chart) return;

    const labels = chart.data.labels;
    const data = chart.data.datasets[0].data;
    
    const csvContent = convertToCSV(labels, data, chart.options.scales.x.title.text);
    downloadCSV(csvContent, `${chartId}_export.csv`);
}

function getChartInstance(chartId) {
    switch(chartId) {
        case 'usersWithLicensesChart': return usersWithLicensesChart;
        case 'broadcastsByAgeChart': return broadcastsByAgeChart;
        case 'durationByAgeChart': return durationByAgeChart;
        case 'durationByCategoryChart': return durationByCategoryChart;
        default: return null;
    }
}

function convertToCSV(labels, data, valueLabel) {
    let csv = `${valueLabel},Count\n`;
    for (let i = 0; i < labels.length; i++) {
        csv += `"${labels[i]}",${data[i]}\n`;
    }
    return csv;
}

function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Make functions globally available
window.exportChartData = exportChartData;
window.getChartInstance = getChartInstance;
window.convertToCSV = convertToCSV;
window.downloadCSV = downloadCSV;
</script>

{% endblock %}
